{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSA - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'myapp/css/admin_dashboard.css' %}">
</head>

<body>
  <button class="btn btn-primary toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

  {% include "partials/sidebar.html" %}
  {% include "partials/logout_modal.html" %}


  <!-- //////////////////////////START HERE MAG CODE ///////////////////////////-->

  <style>
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background-color: #f8f9fa;
    }
    .main-content {
      margin-left: 250px; /* sidebar width */
      transition: margin-left 0.3s ease;
      padding: 20px;
    }
    /* When sidebar is hidden */
    .sidebar.show ~ .main-content {
      margin-left: 250px; /* keep same margin */
    }
    /* On smaller screens, remove the margin so content is always visible */
    @media (max-width: 992px) {
      .main-content {
        margin-left: 0;
      }
    }
    .stat-card {
      background-color: #1c0a0a;
      border-left: 5px solid #ad0211ff;
      border-radius: 12px;
      color: #fff;
      position: relative;
      padding: 20px;
      transition: transform 0.2s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 120px;
    }
    .stat-card .card-body i {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 3rem;
      opacity: 0.25;
    }
    .last-updated {
      font-size: 0.8rem;
      color: #6c757d;
    }

    .search-input {
      transition: all 0.3s ease;
      border-radius: 8px 0 0 8px; /* rounded only on left side */
      border: 1px solid #ccc;
    }

    .search-input:focus {
      border-color: #440207;
      box-shadow: 0 0 8px rgba(68, 2, 7, 0.3);
      outline: none;
    }
            
  </style>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">

    <!-- Dashboard Header -->
    <div class="container-fluid py-2 px-2">
      <div class="dashboard-header text-white mt-4"
           style="background: linear-gradient(to right bottom, #000000, #440207, rgb(104, 3, 12));
                  background-size: cover;
                  background-position: center;
                  background-repeat: no-repeat;
                  padding: 50px;
                  min-height: 100px;
                  border-radius: 20px;
                  margin-bottom: 20px;">
        <h2 class="fw-bold mb-0">
          <i class="bi bi-speedometer2 me-2"></i>
          Dashboard
        </h2>
        <p class="mb-0">Monitor, manage, and update student records</p>
        <small id="lastUpdated" class="last-updated d-block mt-1">Updated â€”</small>
      </div>
    </div>

    <!-- Stat Cards -->
    <div class="row g-3 mb-4 px-4">

      <div class="col-md-3 col-sm-6">
        <div class="card stat-card">
          <div class="card-body position-relative">
            <h6 class="card-title"><strong>Total Visitors</strong></h6>
            <h3 id="cardGrand">0</h3>
            <small class="d-block opacity-75">Grand total of requests</small>
            <div class="d-flex justify-content-between">
              <small class="text-danger">Rejected: <span id="cardGrandRejected">0</span></small>
            </div>
            <i class="fas fa-users"></i>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card stat-card">
          <div class="card-body position-relative">
            <h6 class="card-title">Good Moral Certificates</h6>
            <h3 id="cardGoodMoral">0</h3>
             <div class="d-flex justify-content-between">
              <small class="text-danger">Rejected: <span id="cardGMRejected">0</span></small>
            </div>
            <i class="fas fa-shield-alt"></i>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card stat-card">
          <div class="card-body position-relative">
            <h6 class="card-title">Clearances</h6>
            <h3 id="cardClearance">0</h3>
             <div class="d-flex justify-content-between">
            </div>
            <i class="fas fa-file-alt"></i>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="card stat-card">
          <div class="card-body position-relative">
            <h6 class="card-title">Surrender IDs</h6>
            <h3 id="cardSurrender">0</h3>
             <div class="d-flex justify-content-between">
              <small class="text-danger">Rejected: <span id="cardSurrRejected">0</span></small>
            </div>
            <i class="fas fa-file-alt"></i>
          </div>
        </div>
      </div>

    </div>

    <!-- Table -->
    <div class="container-fluid pt-2 pb-7">
      <div class="bg-white p-4 rounded shadow-sm border">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <h5 class="fw-bold mb-1">
              <i class="bi bi-bar-chart-line-fill me-2" style="color: #440207;"></i>
              Monthly Statistics
            </h5>
            <small class="text-muted">View monthly visitors, respondents, certificates, and clearances.</small>
          </div>


          <!-- search months -->
          <div class="input-group mb-3" style="max-width: 400px;">
            <input type="text" class="form-control search-input" placeholder="Search Month" aria-label="Search Month">
            <button class="btn border" type="button">
              <i class="bi bi-search"></i>
            </button>
          </div>

        </div>

        <hr class="border-dark">
        <!-- Scrollable Table -->
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
          <table class="table table-hover table-bordered align-middle text-center mb-0"  >
            <thead class="table-secondary sticky-top border">
              <tr>
                <th>Month</th>
                <th>Total Visitors</th>
                <th>Good Moral Certificates</th>
                <th>Clearances</th>
                <th>Surrender IDs</th>
              </tr>
            </thead>
            <tbody id="monthlyBody">
              <!-- rows injected by JS -->
              <tr id="monthlyEmpty">
                <td colspan="5" class="text-muted">No data yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* Sidebar Functions */
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('show');
    }

    function handleDropdown(menuId) {
      const clickedIcon = document.getElementById(`icon-${menuId}`);
      const clickedMenu = document.getElementById(menuId);
      const clickedCollapse = bootstrap.Collapse.getOrCreateInstance(clickedMenu);

      if (clickedMenu.classList.contains('show')) {
        clickedCollapse.hide();
        clickedIcon.classList.remove('rotate');
      } else {
        clickedCollapse.show();
        clickedIcon.classList.add('rotate');
      }

      const allDropdowns = ['violationMenu', 'documentsMenu', 'postingsMenu', 'studentRecordMenu'];
      allDropdowns.forEach(id => {
        if (id !== menuId) {
          const menu = document.getElementById(id);
          const icon = document.getElementById(`icon-${id}`);
          const collapse = bootstrap.Collapse.getInstance(menu);
          if (collapse) collapse.hide();
          if (icon) icon.classList.remove('rotate');
        }
      });
    }

    // Highlight Active Link
    document.addEventListener('DOMContentLoaded', function () {
      const currentUrl = window.location.href;
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
        if (link.href && currentUrl.includes(link.href)) {
          link.classList.add('active');
        }
      });
    });

    ///////////////////////////// START HERE MAG ADD

  const DATA_URL = "{% url 'admin_dashboard_data' %}";
  console.log("DATA_URL =", DATA_URL);

  const elLastUpdated  = document.getElementById('lastUpdated');
  const elCardGrand    = document.getElementById('cardGrand');
  const elCardGM       = document.getElementById('cardGoodMoral');
  const elCardClr      = document.getElementById('cardClearance');
  const elCardSurr     = document.getElementById('cardSurrender');
  const elMonthlyBody  = document.getElementById('monthlyBody');

  // NEW: rejected spans
  const elCardGrandRejected = document.getElementById('cardGrandRejected');
  const elCardGMRejected    = document.getElementById('cardGMRejected');
  const elCardSurrRejected  = document.getElementById('cardSurrRejected');

  // Small inline error
  const errorBadge = document.createElement('div');
  errorBadge.className = 'text-warning mt-2';
  errorBadge.style.fontSize = '0.85rem';
  errorBadge.style.display = 'none';
  errorBadge.id = 'loadError';
  elLastUpdated.parentNode.appendChild(errorBadge);

  function showError(msg) {
    const el = document.getElementById('loadError');
    el.textContent = msg;
    el.style.display = 'block';
  }
  function hideError() {
    const el = document.getElementById('loadError');
    el.textContent = '';
    el.style.display = 'none';
  }
  function fmt(n) { return (n || 0).toLocaleString(); }

  function renderTotals(totals, asOf) {
    elCardGrand.textContent = fmt(totals.grand_total);
    elCardGM.textContent    = fmt(totals.goodmoral_approved);
    elCardClr.textContent   = fmt(totals.clearance_all);
    elCardSurr.textContent  = fmt(totals.surrender_approved);

    // NEW: wire rejected counts
    if (elCardGrandRejected) elCardGrandRejected.textContent = fmt(totals.grand_rejected || 0);
    if (elCardGMRejected)    elCardGMRejected.textContent    = fmt(totals.goodmoral_rejected || 0);
    if (elCardSurrRejected)  elCardSurrRejected.textContent  = fmt(totals.surrender_rejected || 0);

    elLastUpdated.textContent = "Updated " + new Date(asOf).toLocaleString();
  }

  function renderMonthly(rows) {
    elMonthlyBody.innerHTML = "";
    if (!rows || rows.length === 0) {
      elMonthlyBody.innerHTML =
        '<tr><td colspan="5" class="text-muted">No data yet.</td></tr>';
      return;
    }
    rows.forEach(r => {
      elMonthlyBody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${r.month_label}</td>
          <td class="fw-semibold">${fmt(r.total)}</td>
          <td>${fmt(r.goodmoral_approved)}</td>
          <td>${fmt(r.clearance_all)}</td>
          <td>${fmt(r.surrender_approved)}</td>
        </tr>
      `);
    });
  }

  async function loadDashboard() {
    hideError();
    try {
      const res = await fetch(DATA_URL, {
        cache: 'no-store',
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });

      const ct = res.headers.get('content-type') || '';
      if (!res.ok) {
        const text = await res.text();
        console.error('admin_dashboard_data failed:', res.status, text);
        showError(`Failed to load data (${res.status}). See console.`);
        return;
      }
      if (!ct.includes('application/json')) {
        const text = await res.text();
        console.error('Expected JSON, got:', ct, text.slice(0, 400));
        showError('Data endpoint returned non-JSON (likely a redirect). Check auth/URL.');
        return;
      }

      const data = await res.json();
      renderTotals(data.totals, data.as_of);
      renderMonthly(data.rows);
    } catch (e) {
      console.error("Dashboard load exception:", e);
      showError('Error loading dashboard data. See console for details.');
    }
  }

  loadDashboard();
  setInterval(loadDashboard, 60_000);




  // Search Function
    const searchInput = document.querySelector('.search-input');
    const searchButton = document.querySelector('.btn-outline-secondary');
    const tableBody = document.getElementById('monthlyBody');

    function filterTable() {
      const query = searchInput.value.toLowerCase();
      const rows = tableBody.querySelectorAll('tr');

      let visibleCount = 0;

      rows.forEach(row => {
        // Skip the "No data yet" row
        if (row.id === 'monthlyEmpty') return;

        const monthCell = row.cells[0].textContent.toLowerCase();
        if (monthCell.includes(query)) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });

      // Show "No data yet" if nothing matches
      const emptyRow = document.getElementById('monthlyEmpty');
      if (visibleCount === 0) {
        emptyRow.style.display = '';
      } else {
        emptyRow.style.display = 'none';
      }
    }

    // Search on typing
    searchInput.addEventListener('keyup', filterTable);

    // Search on button click
    searchButton.addEventListener('click', filterTable);



</script>
</body>
</html>
