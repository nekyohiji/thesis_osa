
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OSA - Scholarships</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'myapp/css/admin_scholarships.css' %}">
</head>

<body>
    <button class="btn btn-primary toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

<!-- Sidebar -->
    {% include "partials/sidebar.html" %}
    {% include "partials/logout_modal.html" %}

<!--////////////////////// START HERE MAGCODE -->


    <div class="main-content">
        <div class="container-fluid">
            <h1 class="section-title"><i class="fas fa-award me-3"></i> SCHOLARSHIPS</h1>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
  
                </div>
                {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
                {% endif %}
                <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="mb-3">
                    <label for="title" class="form-label">Title</label>
                    <textarea class="form-control" name="title" id="title" rows="3" placeholder="Type Scholarship Title..." maxlength="255" required> </textarea>
                    </div>
                    
                    <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" name="description" id="description" rows="3" placeholder="Enter scholarship description..."></textarea>
                    </div>

                    <div class="mb-3">
                    <label for="category" class="form-label">Category</label>
                    <select class="form-select" name="category" id="category" required>
                        <option selected disabled value="">Select Category</option>
                        <option value="Internal">Internal</option>
                        <option value="External Govt">External (Govt)</option>
                        <option value="External Private">External (Private)</option>
                    </select>
                    </div>

                    <div class="mb-3">
                    <label for="deadline_date" class="form-label">Deadline Date</label>
                    <input type="date" class="form-control" name="deadline_date" id="deadline_date" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Attachments</label>
                        <input type="file" name="attachment_1" class="form-control mb-2" accept="image/*">
                        <input type="file" name="attachment_2" class="form-control mb-2" accept="image/*">
                        <input type="file" name="attachment_3" class="form-control mb-2" accept="image/*">
                        <input type="file" name="attachment_4" class="form-control mb-2" accept="image/*">
                        <input type="file" name="attachment_5" class="form-control mb-2" accept="image/*">
                    </div>

                    <div class="d-flex justify-content-end align-items-center mb-4">
                    <button type="submit" class="btn btn-secondary">Post</button>
                    </div>
                </form>

                <hr>

                <h6>Timeline</h6>
                <div class="timeline-container">
                    <div class="posted-scholarships-list">
                    {% for s in scholarships %}
                    <div class="card-body" data-id="{{ s.id }}">
                        <h5 class="card-title">{{ s.title }}</h5>
                        <p class="card-text">
                            <small class="text-muted">
                                <i class="fas fa-calendar-alt"></i> Posted: {{ s.posted_date }} |
                                <i class="fas fa-hourglass-half"></i> Deadline: {{ s.deadline_date }}
                            </small>
                        </p>
                        <p class="card-text mb-2">
                            <i class="fas fa-tag"></i> Category:
                            <span class="badge bg-info">{{ s.category }}</span>
                        </p>
                        <p class="card-text">
                            {{ s.description|linebreaksbr }}
                        </p>

                        {% if s.attachment_1 or s.attachment_2 or s.attachment_3 or s.attachment_4 or s.attachment_5 %}
                        <div class="mb-2">
                            <strong>Attachments:</strong>
                            <div class="mt-2">
                                {% if s.attachment_1 %}
                                    <img src="{{ s.attachment_1.url }}" alt="Attachment 1" class="img-thumbnail mb-1" style="max-height: 150px;">
                                {% endif %}
                                {% if s.attachment_2 %}
                                    <img src="{{ s.attachment_2.url }}" alt="Attachment 2" class="img-thumbnail mb-1" style="max-height: 150px;">
                                {% endif %}
                                {% if s.attachment_3 %}
                                    <img src="{{ s.attachment_3.url }}" alt="Attachment 3" class="img-thumbnail mb-1" style="max-height: 150px;">
                                {% endif %}
                                {% if s.attachment_4 %}
                                    <img src="{{ s.attachment_4.url }}" alt="Attachment 4" class="img-thumbnail mb-1" style="max-height: 150px;">
                                {% endif %}
                                {% if s.attachment_5 %}
                                    <img src="{{ s.attachment_5.url }}" alt="Attachment 5" class="img-thumbnail mb-1" style="max-height: 150px;">
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-end">
                            <a href="#" class="btn btn-sm btn-outline-success me-2" onclick="showEditScholarship({{ s.id }})">Edit</a>
                            <a href="#" class="btn btn-sm btn-outline-danger" onclick="showDeleteScholarship({{ s.id }})">Delete</a>
                        </div>
                    </div>
                    {% empty %}
                    <p>No scholarships posted yet.</p>
                    {% endfor %}
                </div>
                    </div>
                </div>
                </div>
    <div class="modal fade" id="editScholarshipModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
        <div class="modal-header">
            <h5>Edit Scholarship</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div id="editError" class="alert alert-danger d-none"></div>
            <form id="editScholarshipForm">
            <input type="hidden" id="editScholarshipId">
            <div class="mb-3">
                <label>Title</label>
                <textarea class="form-control" id="editTitle" name="title"></textarea>
            </div>
            <div class="mb-3">
                <label>Description</label>
                <textarea class="form-control" id="editDescription" name="description"></textarea>
            </div>
            <div class="mb-3">
                <label>Category</label>
                <select class="form-select" id="editCategory" name="category">
                <option value="Internal">Internal</option>
                <option value="External Govt">External (Govt)</option>
                <option value="External Private">External (Private)</option>
                </select>
            </div>
            <div class="mb-3">
                <label>Deadline Date</label>
                <input type="date" class="form-control" id="editDeadline" name="deadline_date">
            </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="submitScholarshipEdit()">Save</button>
        </div>
        </div>
    </div>
    </div>

    <div class="modal fade" id="deleteScholarshipModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
        <div class="modal-body">
            Are you sure you want to delete this scholarship?
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmScholarshipDeleteBtn">Delete</button>
        </div>
        </div>
    </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

    // ==================== Sidebar Functions ====================

    // Toggle Sidebar
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('show');
    }

    // Handle Dropdowns Uniformly
    function handleDropdown(menuId) {
        const clickedIcon = document.getElementById(`icon-${menuId}`);
        const clickedMenu = document.getElementById(menuId);
        const clickedCollapse = bootstrap.Collapse.getOrCreateInstance(clickedMenu);

        if (clickedMenu.classList.contains('show')) {
            clickedCollapse.hide();
            clickedIcon.classList.remove('rotate');
        } else {
            clickedCollapse.show();
            clickedIcon.classList.add('rotate');
        }

        const allDropdowns = ['violationMenu', 'documentsMenu', 'postingsMenu', 'studentRecordMenu'];
        allDropdowns.forEach(id => {
            if (id !== menuId) {
                const menu = document.getElementById(id);
                const icon = document.getElementById(`icon-${id}`);
                const collapse = bootstrap.Collapse.getInstance(menu);
                if (collapse) collapse.hide();
                if (icon) icon.classList.remove('rotate');
            }
        });
    }

    // Highlight Active Link
    document.addEventListener('DOMContentLoaded', function () {
        const currentUrl = window.location.href;
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            if (link.href && currentUrl.includes(link.href)) {
                link.classList.add('active');
            }
        });
    });

    // ==================== Scholarship Functions ====================

    // Utility: Get CSRF Token
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    // Utility: Set min date for a date input
    function setMinDeadlineDate(inputId) {
        fetch("{% url 'current_time' %}")
            .then(response => response.json())
            .then(data => {
                const dateInput = document.getElementById(inputId);
                const today = data.now.split('T')[0];
                dateInput.min = today;

                if (!dateInput.value || new Date(dateInput.value) < new Date(today)) {
                    dateInput.value = today;
                }
            });
    }

    // Run on page load
    document.addEventListener('DOMContentLoaded', () => {
        setMinDeadlineDate('deadline_date');
    });

    // ==================== Delete ====================

    let currentScholarshipId = null;

    function showDeleteScholarship(id) {
        currentScholarshipId = id;
        const modal = new bootstrap.Modal(document.getElementById('deleteScholarshipModal'));
        modal.show();
    }

    document.getElementById('confirmScholarshipDeleteBtn').addEventListener('click', () => {
        const btn = document.getElementById('confirmScholarshipDeleteBtn');
        btn.disabled = true;

        fetch(`/scholarships/ajax/delete/${currentScholarshipId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload(); // or remove card dynamically
            }
        })
        .finally(() => {
            btn.disabled = false;
        });
    });

    // ==================== Edit ====================

    function showEditScholarship(id) {
        clearEditError();
        currentScholarshipId = id;

        const card = document.querySelector(`[data-id="${id}"]`);
        document.getElementById('editScholarshipId').value = id;

        const titleEl = card.querySelector('.card-title');
        const descriptionEl = card.querySelectorAll('.card-text')[2];
        const categoryEl = card.querySelector('.badge');
        const deadlineEl = card.querySelectorAll('.card-text small')[0];

        document.getElementById('editTitle').value = titleEl ? titleEl.innerText.trim() : '';
        document.getElementById('editDescription').value = descriptionEl ? descriptionEl.innerText.trim() : '';
        document.getElementById('editCategory').value = categoryEl ? categoryEl.innerText.trim() : '';

        if (deadlineEl) {
            const deadlineText = deadlineEl.innerText.split('|')[1].split(':')[1].trim();
            document.getElementById('editDeadline').value = deadlineText;
        }

        setMinDeadlineDate('editDeadline');

        const modal = new bootstrap.Modal(document.getElementById('editScholarshipModal'));
        modal.show();
    }

    function submitScholarshipEdit() {
        clearEditError();

        const title = document.getElementById('editTitle').value.trim();
        const description = document.getElementById('editDescription').value.trim();
        const category = document.getElementById('editCategory').value.trim();
        const deadline = document.getElementById('editDeadline').value.trim();

        if (!title || !description || !category || !deadline) {
            showEditError("⚠️ Please fill in all fields before saving.");
            return;
        }

        const saveBtn = document.querySelector('#editScholarshipModal .btn-primary');
        saveBtn.disabled = true;

        const formData = new FormData(document.getElementById('editScholarshipForm'));

        fetch(`/scholarships/ajax/edit/${currentScholarshipId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload(); // or dynamically update
            } else {
                showEditError("❌ Error: " + (data.error || "Could not save changes."));
            }
        })
        .finally(() => {
            saveBtn.disabled = false;
        });
    }

    // ==================== Inline Error ====================

    function showEditError(message) {
        const errorDiv = document.getElementById('editError');
        errorDiv.textContent = message;
        errorDiv.classList.remove('d-none');
    }

    function clearEditError() {
        const errorDiv = document.getElementById('editError');
        errorDiv.textContent = '';
        errorDiv.classList.add('d-none');
    }

    </script>

</body>
</html>