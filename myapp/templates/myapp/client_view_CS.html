{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community Service Monitoring</title>

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- QR Code Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body { background: #f4f6f9; }
    .student-card { border:1px solid #7b0000; border-radius:16px; transition:.2s; cursor:pointer; }
    .student-card:hover { border-width:2px; transform: translateY(-3px); }
    .progress { height:10px; border-radius:5px; background:#00000010; overflow:hidden; }
    .progress-bar { background: linear-gradient(90deg,#3b0101,#7b0000,#ce1313); transition: width .5s; }
    .badge { border-radius:8px; }
    .section-box { background:#fff; border-radius:12px; border:1px solid #7b0000; padding:1rem 1.25rem; }
    .section-title { font-weight:600; color:#7b0000; display:flex; gap:.5rem; align-items:center; }
    #qr-reader { border-radius:12px; overflow:hidden; }
  </style>
</head>

<body>
  <div class="container py-4">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-4 text-white"
         style="background:linear-gradient(to right bottom,#000,#440207,#68030c); padding:20px; border-radius:20px;">
      <div class="p-2">
        <h2 class="fw-bold mb-2"><i class="bi bi-people-fill me-2"></i>Community Service Monitoring</h2>
        <p class="mb-0">Track rendered and remaining hours. Scan QR codes to log in/out.</p>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="input-group mb-3" style="max-width:480px;">
      <span class="input-group-text" style="border:1px solid #7b0000;"><i class="bi bi-search"></i></span>
      <input type="text" id="searchInput" class="form-control" placeholder="Search student...">
    </div>

    <!-- Student Cards -->
    <div class="row g-4" id="studentList">
      {% for c in cases %}
      <div class="col-md-4 student-card-wrapper">
        <div class="card student-card p-3"
             data-case-id="{{ c.id }}"
             data-student-id="{{ c.student_id }}"
             data-fullname="{{ c.last_name }}, {{ c.first_name }}{% if c.middle_initial %} {{ c.middle_initial }}{% endif %}{% if c.extension_name %} {{ c.extension_name }}{% endif %}"
             data-program="{{ c.program_course }}">
          <div class="card-body">
            <h5 class="card-title mb-1">{{ c.last_name|title }}, {{ c.first_name|title }}</h5>
            <p class="card-subtitle text-muted">{{ c.program_course }}</p>

            <div class="mt-3">
              <div class="d-flex justify-content-between small mb-1">
                <span>Hours Rendered</span>
                <span>{{ c.hours_completed }} / {{ c.total_required_hours }} hrs</span>
              </div>
              <div class="progress">
                {% with pc=0 %}
                {% if c.total_required_hours > 0 %}
                  {% widthratio c.hours_completed c.total_required_hours 100 as pc %}
                {% endif %}
                {% endwith %}
                <div class="progress-bar" style="width: {{ pc }}%"></div>
              </div>
            </div>

            <div class="mt-2">
              <span class="badge bg-success me-1">Rendered: {{ c.hours_completed }}h</span>
              <span class="badge bg-warning text-dark">Left: {{ c.remaining_hours }}h</span>
              {% if c.is_closed %}
                <span class="badge bg-secondary ms-1">Closed</span>
              {% endif %}
            </div>

            <div class="mt-3 d-flex gap-2">
              <button class="btn btn-primary flex-fill btn-view-logs" data-case-id="{{ c.id }}">
                <i class="bi bi-eye me-1"></i> View Logs
              </button>
            </div>
          </div>
        </div>
      </div>
      {% empty %}
        <div class="col-12">
          <div class="alert alert-light border">No community service cases found.</div>
        </div>
      {% endfor %}
    </div>

    <hr>
    <div class="d-flex justify-content-end">
      <a class="btn btn-outline-secondary" href="{% url 'client_CS' %}">
        <i class="bi bi-box-arrow-right me-1"></i> Logout
      </a>
    </div>
  </div>

  <!-- Logs Modal -->
  <div class="modal fade" id="logModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background:linear-gradient(to bottom,#000,#440207); color:#fff;">
          <h5 class="modal-title"><i class="bi bi-clock-history me-2"></i>Service Logs</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <!-- Profile -->
            <div class="col-lg-6">
              <div class="section-box">
                <div class="section-title"><i class="bi bi-person-badge"></i> Student Profile</div><hr class="my-2">
                <div class="mb-2">
                  <label class="form-label">Student ID</label>
                  <input type="text" id="m_student_id" class="form-control fw-bold text-center" readonly>
                </div>
                <div class="row mb-2">
                  <div class="col">
                    <label class="form-label">First Name</label>
                    <input type="text" id="m_first_name" class="form-control fw-bold text-center" readonly>
                  </div>
                  <div class="col">
                    <label class="form-label">Last Name</label>
                    <input type="text" id="m_last_name" class="form-control fw-bold text-center" readonly>
                  </div>
                </div>
                <div class="mb-2">
                  <label class="form-label">Program</label>
                  <input type="text" id="m_program" class="form-control fw-bold text-center" readonly>
                </div>
                <div class="mb-1">
                  <label class="form-label">Remaining Community Service Hours</label>
                  <input type="text" id="m_remaining" class="form-control fw-bold text-center text-danger" readonly>
                </div>
              </div>
            </div>

            <!-- Violations -->
            <div class="col-lg-6">
              <div class="section-box">
                <div class="section-title"><i class="bi bi-exclamation-triangle"></i> Violations</div><hr class="my-2">
                <div id="m_violations" style="max-height:250px; overflow-y:auto;"></div>
              </div>
            </div>

            <!-- Logs -->
            <div class="col-12">
              <div class="section-box">
                <div class="section-title"><i class="bi bi-clock-history"></i> Community Service Log</div><hr class="my-2">
                <p class="mb-2"><strong>Total Hours to Complete:</strong> <span id="m_total" class="text-danger">—</span></p>
                <div id="m_logs" style="max-height:260px; overflow-y:auto;"></div>
                <div class="mt-2 text-end">
                  <span class="badge bg-success">Total Rendered Hours: <span id="m_done">—</span></span>
                  <span class="badge bg-warning text-dark ms-1">Hours Left: <span id="m_left">—</span></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <div>
            <button class="btn btn-success" id="m_btn_in"><i class="bi bi-box-arrow-in-right me-1"></i> Time In</button>
            <button class="btn btn-danger" id="m_btn_out"><i class="bi bi-box-arrow-left me-1"></i> Time Out</button>
          </div>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Scanner Modal -->
  <div class="modal fade" id="qrScannerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background:linear-gradient(to bottom,#000,#440207); color:#fff;">
          <h5 class="modal-title"><i class="bi bi-qr-code me-2"></i>QR Code Scanner</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <div id="qr-reader" style="width:100%;"></div>
          <p class="mt-3 fw-bold" id="qr-result">Scan a student's QR code...</p>
          <div class="text-muted small">We’ll extract the <code>TUPC-XX-XXXX…</code> code before the surname.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
(function () {
  // ---------- CSRF ----------
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  // ---------- Search ----------
  const searchInput = document.getElementById("searchInput");
  const studentList = document.getElementById("studentList");
  if (searchInput && studentList) {
    searchInput.addEventListener("input", function () {
      const q = this.value.toLowerCase();
      studentList.querySelectorAll(".student-card-wrapper").forEach(card => {
        const name = card.querySelector(".card-title")?.textContent.toLowerCase() || "";
        card.style.display = name.includes(q) ? "" : "none";
      });
    });
  }

  // ---------- Helpers ----------
  function normalizeId(s) {
    return (s || "").toUpperCase().trim();
  }
  // Extracts "TUPC-XX-XXXX..." even if followed by whitespace/surname
  function tupcFrom(raw) {
    const m = (raw || "").match(/(?:^|\s)(TUPC-\d{2}-\d+)(?=\s|$)/i);
    return m ? normalizeId(m[1]) : null;
  }
  function setDisabled(btn, on) {
    if (!btn) return;
    btn.disabled = !!on;
    btn.classList.toggle('disabled', !!on);
  }

  // ---------- Logs Modal population ----------
  const logModal = document.getElementById('logModal');
  const m_student_id = document.getElementById('m_student_id');
  const m_first_name = document.getElementById('m_first_name');
  const m_last_name  = document.getElementById('m_last_name');
  const m_program    = document.getElementById('m_program');
  const m_remaining  = document.getElementById('m_remaining');
  const m_total      = document.getElementById('m_total');
  const m_done       = document.getElementById('m_done');
  const m_left       = document.getElementById('m_left');
  const m_violations = document.getElementById('m_violations');
  const m_logs       = document.getElementById('m_logs');
  const m_btn_in     = document.getElementById('m_btn_in');
  const m_btn_out    = document.getElementById('m_btn_out');

  let currentCaseId = null;
  let currentStudentId = null;
  let hasOpen = false;

  function renderViolations(items) {
    if (!items || !items.length) return '<div class="text-muted small">No violations found.</div>';
    return items.map(v => `
      <div class="bg-light border rounded px-3 py-2 mb-2">
        <div class="d-flex justify-content-between flex-wrap">
          <div class="me-3">
            <small class="text-muted d-block mb-1">Type of Violation:</small>
            <span class="fw-semibold small">${v.type}</span>
            <span class="badge ms-2 ${v.severity === 'Major' ? 'bg-danger' : 'bg-secondary'}">${v.severity || 'Minor'}</span>
          </div>
          <div>
            <small class="text-muted d-block mb-1">Date:</small>
            <span class="fw-semibold small">${v.date}</span>
          </div>
        </div>
      </div>
    `).join('');
  }

  function renderLogs(items) {
    if (!items || !items.length) return '<div class="text-muted small">No logs yet.</div>';
    return items.map(l => `
      <div class="bg-light border rounded px-4 py-2 mb-2" style="border:2px solid #440207;">
        <div class="row align-items-center">
          <div class="col-3"><small class="text-muted d-block mb-1">Date:</small><span class="fw-semibold small">${l.date}</span></div>
          <div class="col-3"><small class="text-muted d-block mb-1">Time In:</small><span class="fw-semibold small">${l.in}</span></div>
          <div class="col-3"><small class="text-muted d-block mb-1">Time Out:</small><span class="fw-semibold small">${l.out || '—'}</span></div>
          <div class="col-3 text-end">
            ${l.out ? `<span class="badge bg-success">${l.hours}h</span>` : `<span class="badge bg-warning text-dark">On Going</span>`}
          </div>
        </div>
      </div>
    `).join('');
  }

  async function loadCase(caseId) {
    const r = await fetch("{% url 'cs_case_detail_api' 0 %}".replace('/0/', `/${caseId}/`));
    if (!r.ok) throw new Error('Failed to load');
    return r.json();
  }

  // View Logs buttons
  document.querySelectorAll('.btn-view-logs').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const caseId = e.currentTarget.dataset.caseId;
      try {
        const data = await loadCase(caseId);
        currentCaseId = data.case.id;
        currentStudentId = data.case.student_id;
        hasOpen = !!data.open_session;

        m_student_id.value = data.case.student_id;
        m_first_name.value = (data.case.first_name || '').toUpperCase();
        m_last_name.value  = (data.case.last_name  || '').toUpperCase();
        m_program.value    = data.case.program_course || '';
        m_remaining.value  = data.case.remaining_hours + 'h';
        m_total.textContent = data.case.total_required_hours + 'h';
        m_done.textContent  = data.case.hours_completed + 'h';
        m_left.textContent  = data.case.remaining_hours + 'h';

        m_violations.innerHTML = renderViolations(data.violations || []);
        m_logs.innerHTML       = renderLogs(data.logs || []);

        setDisabled(m_btn_in, hasOpen || data.case.is_closed);
        setDisabled(m_btn_out, !hasOpen);

        new bootstrap.Modal(logModal).show();
      } catch (err) {
        alert('Failed to load case details.');
      }
    });
  });

  // ---------- Scanner Modal ----------
  const qrModal   = document.getElementById("qrScannerModal");
  const qrResult  = document.getElementById("qr-result");
  const btnScanList = document.querySelectorAll('.btn-scan'); // safe if none exist

  let html5QrCode = null;
  let scanAction  = null; // 'in' | 'out'
  let scanBusy    = false; // avoid duplicate posts

  // If you have scan buttons on the cards (optional)
  if (btnScanList && btnScanList.length) {
    btnScanList.forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const caseId = e.currentTarget.dataset.caseId;
        try {
          const data = await loadCase(caseId);
          currentCaseId = data.case.id;
          currentStudentId = data.case.student_id;
          hasOpen = !!data.open_session;
          scanAction = hasOpen ? 'out' : 'in';
          qrResult.textContent = hasOpen ? 'Scan to TIME OUT...' : 'Scan to TIME IN...';
          new bootstrap.Modal(qrModal).show();
        } catch {
          alert('Failed to load case details.');
        }
      });
    });
  }

  // Trigger scanner from logs modal buttons
  if (m_btn_in) {
    m_btn_in.addEventListener('click', () => {
      if (m_btn_in.disabled) return;
      scanAction = 'in';
      qrResult.textContent = 'Scan to TIME IN...';
      new bootstrap.Modal(qrModal).show();
    });
  }
  if (m_btn_out) {
    m_btn_out.addEventListener('click', () => {
      if (m_btn_out.disabled) return;
      scanAction = 'out';
      qrResult.textContent = 'Scan to TIME OUT...';
      new bootstrap.Modal(qrModal).show();
    });
  }

  qrModal.addEventListener("shown.bs.modal", async () => {
    if (html5QrCode) return;
    html5QrCode = new Html5Qrcode("qr-reader");

    const box = Math.min(window.innerWidth * 0.8, 360);
    const config = { fps: 12, qrbox: { width: box, height: box } };

    const onScanSuccess = async (decodedText) => {
      if (scanBusy) return;
      const parsed   = tupcFrom(decodedText);
      const expected = normalizeId(currentStudentId);

      if (!parsed) {
        qrResult.textContent = "ID unreadable. Try again.";
        return;
      }
      if (parsed !== expected) {
        qrResult.textContent = `ID mismatch: scanned ${parsed}, expected ${expected}.`;
        return;
      }

      scanBusy = true;
      try {
        const form = new FormData();
        form.append('scanned', decodedText);

        const url = (scanAction === 'in')
          ? "{% url 'cs_scan_time_in' 0 %}".replace('/0/', `/${currentCaseId}/`)
          : "{% url 'cs_scan_time_out' 0 %}".replace('/0/', `/${currentCaseId}/`);

        const r = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: form });
        if (!r.ok) {
          const err = await r.json().catch(() => ({ error: 'Scan failed.' }));
          qrResult.textContent = err.error || 'Scan failed.';
          scanBusy = false;
          return;
        }

        // Close scanner
        const modal = bootstrap.Modal.getInstance(qrModal);
        modal && modal.hide();

        // Refresh logs modal if open
        if (bootstrap.Modal.getInstance(logModal)) {
          const data = await loadCase(currentCaseId);
          m_remaining.value  = data.case.remaining_hours + 'h';
          m_total.textContent = data.case.total_required_hours + 'h';
          m_done.textContent  = data.case.hours_completed + 'h';
          m_left.textContent  = data.case.remaining_hours + 'h';
          m_logs.innerHTML    = renderLogs(data.logs || []);
          setDisabled(m_btn_in, data.open_session || data.case.is_closed);
          setDisabled(m_btn_out, !data.open_session);
        } else {
          location.reload();
        }
      } catch (e) {
        qrResult.textContent = 'Network error. Please try again.';
        scanBusy = false;
      }
    };

    try {
      // Prefer back camera
      await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
    } catch (e1) {
      try {
        const devices = await Html5Qrcode.getCameras();
        if (!devices || !devices.length) throw new Error("No camera available.");
        // Try last camera (often back camera)
        await html5QrCode.start(devices[devices.length - 1].id, config, onScanSuccess);
      } catch (e2) {
        let msg = String(e2 && e2.message || e2 || '');
        if (/Permission|NotAllowed/i.test(msg)) msg = "Camera permission denied. Allow it in browser settings.";
        else if (/No camera/i.test(msg)) msg = "No camera found on this device.";
        else if (location.protocol !== 'https:' && !/localhost|127\.0\.0\.1/.test(location.hostname)) msg = "Camera requires HTTPS on mobile. Use your tunnel URL.";
        qrResult.textContent = msg;
      }
    }
  });

  qrModal.addEventListener("hidden.bs.modal", async () => {
    if (html5QrCode) {
      try { await html5QrCode.stop(); } catch {}
      try { html5QrCode.clear(); } catch {}
      html5QrCode = null;
    }
    scanBusy = false;
    qrResult.textContent = "Scan a student's QR code...";
  });
})();
</script>

</body>
</html>
