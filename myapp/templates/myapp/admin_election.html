{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSA - Election Candidates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  
  <link rel="stylesheet" href="{% static 'myapp/css/admin_election.css' %}">
</head>

<body>
  <button class="btn btn-primary toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

  {% include "partials/sidebar.html" %}
  {% include "partials/logout_modal.html" %}
<!-- /////////////////////////START HERE MAG CODE ///////////////////////////-->


<style>

  /* Highlight on focus */
  .input-group-sm .form-control:focus {
    border: 2px solid #440207;
    box-shadow: 0 0 0 0.15rem rgba(68, 2, 7, 0.1); /* soft glow */
  }

  .input-group-sm .form-control:hover {
    border: 1px solid #440207;
  }
  .input-group-sm:focus-within .input-group-text {
    background-color: #f8f0f0;
    border-color: #440207;
    color: #440207;
  }
  .image-preview{
  position: relative;
  width: 180px;               /* adjust to taste */
  height: 220px;              /* adjust to taste (your “200x200-ish”) */
  border: 2px dashed #bbb;
  border-radius: 10px;
  background: #fff;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}
.image-preview img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none;              /* hidden until a file is chosen */
}
.placeholder-text{
  color: #888;
  font-size: 0.9rem;
  text-align: center;
  padding: 0 8px;
}
.image-btn{
  position: absolute;
  right: -10px;               /* tuck into the corner */
  bottom: -10px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid #fff;
  background: #212529;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}
.image-btn:hover{ opacity: .9; }

  </style>


<div class="mt-4 ps-4 pe-4" style="margin-left: 260px; min-height: 100vh;">

  <!-- Header and Navigation Buttons -->
<div class="election-header text-white mt-4"
      style="background: linear-gradient(to right, rgba(0,0,0,0.9), rgba(0,0,0,0.3)), 
              url('{% static 'myapp/images/election_bg.jpg' %}');
              background-size: cover;
              background-position: center;
              background-repeat: no-repeat;
              padding: 50px;
              min-height: 100px;
              margin-bottom: 50px;
              border-radius: 20px;
              ">
    <h2 class="fw-bold mb-0">University Student Government Election Dashboard</h2>
    <p class="mb-0">Monitor, manage, and update election proceedings.</p>
    <hr class="border-light">
  </div>

  <!-- Navigation Buttons-->
      <div class="d-flex gap-2">
        <a class="btn tab-btn mb-2 {% if request.resolver_match.url_name == 'admin_election' %}active{% endif %}" 
          href="{% url 'admin_election' %}">
          <i class="bi bi-person-circle"></i> Candidates
        </a>

        <a class="btn tab-btn mb-2 {% if request.resolver_match.url_name == 'admin_election_results' %}active{% endif %}" 
          href="{% url 'admin_election_results' %}">
          <i class="bi bi-bar-chart-fill"></i> Results
        </a>

        <a class="btn tab-btn mb-2 {% if request.resolver_match.url_name == 'admin_election_manage' %}active{% endif %}" 
          href="{% url 'admin_election_manage' %}">
          <i class="bi bi-gear-fill"></i> Manage
        </a>
      </div>



<!-- Election Candidates -->
  <div class="tab-content p-5  border rounded shadow-sm"style="background: #c2c1c13b">
    <div class="tab-pane show active" id="candidates">

      <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
        <h4 class="fw-bold">
          <i class="bi bi-person-circle me-2"></i>Candidates
        </h4>
        <div id="notice" class="alert alert-info d-none text-center" style="width:700px;"></div>
        <div></div>
        <div class="d-flex flex-wrap gap-3 align-items-center mb-4 " >
      </div>

      <div class="container-fluid px-4">
        <div class="row">


          <!-- ADD CANDIDATES PANEL -->
          <div class="col-md-5 mb-4">
            <div class="candidate-panel">
              <h5 class="fw-bold text-center mb-4">Candidate Details</h5>

              <div class="d-flex justify-content-center mb-3">
                <div class="image-preview" id="imagePreviewContainer">
                  <img id="previewImage" src="" alt="Preview">
                  <span id="placeholderText" class="placeholder-text">Upload a photo here</span>

                  <!-- Keep the button INSIDE the preview box so it's positioned relative to it -->
                  <button type="button" class="image-btn" id="imageBtn">
                    <i class="bi bi-plus"></i>
                  </button>

                  <!-- Hidden file input -->
                  <input type="file" accept="image/*" id="imageInput" hidden>
                </div>
              </div>

              <div id="formWarning" class="alert alert-warning d-none" role="alert">
                Please fill out all fields and upload a photo.
              </div>
              <form id="candidateForm" enctype="multipart/form-data">
                <input type="text" class="form-control custom-input mb-2" placeholder="Enter Name" id="candidateName" minlength="3" maxlength="100" required>
                <input type="text" class="form-control custom-input mb-2" placeholder="Enter Program" id="candidateSection" maxlength="50" required>
                <input type="text" class="form-control custom-input mb-2" placeholder="TUPC-XX-XXX" id="candidateID" minlength="4" maxlength="50" required>

                <select id="candidatePosition" class="form-control custom-input mb-2" required>
                  <option value="">Select Position</option>
                  <option value="President">President</option>
                  <option value="Vice President">Vice President</option>
                  <option value="Senator">Senator</option>
                  <option value="Governor">Governor</option>
                </select>
                <div id="orgGroup" class="mb-2 d-none">
                  <div class="form-text">Required for Governor candidates.</div>
                  <input type="text" class="form-control custom-input"
                        id="orgInput"
                        placeholder="Program/Organization (e.g., FEO, ACETS, PICE)">
                </div>

                <input type="text" class="form-control custom-input mb-3" placeholder="Party (optional)" id="candidateParty" maxlength="80">

                <hr>
                <div class="text-end mt-2">
                  <button type="submit" id="add_candidate" class="btn-add">
                    <i class="bi bi-plus-circle me-1"></i> <b>ADD</b>
                  </button>
                </div>
              </form>
            </div>
          </div>




          <!-- CANDIDATES DISPLAY-->
          <div class="col-md-7">
            <div class="p-5 mb-3  bg-white" style="border: 0.5px solid rgb(65, 4, 4);  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); border-radius: 1rem;">
              <div>
                <h5 class="fw-bold mb-1">
                  <i class="bi bi-bar-chart-line-fill me-2" style="color: #440207;"></i>
                  View Election Candidates
                </h5>
                <small class="text-muted">View a summary of registered election candidates.</small>
              </div>

              <hr class="bg-dark">
              <br>


              <div id="candidateList" class="d-flex flex-column gap-3" style="max-height: 500px; overflow-y: auto;">
                <!-- Cards appear dynamically here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>



<!-- Withdraw Confirmation Modal -->
    <div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-dark">
          <div class="modal-header text-dark">
            <h5 class="modal-title" id="withdrawModalLabel">Withdraw Candidate</h5>
          </div>
          <div class="modal-body text-center">
            Are you sure you want to <strong>withdraw</strong> this candidate?
          </div>
          <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmWithdrawBtn">Withdraw</button>
          </div>
        </div>
      </div>
    </div>
          
    <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-dark">
          <div class="modal-header text-white ">
            <h5 class="modal-title" id="alertModalLabel">Error</h5>
          </div>
          <div class="modal-body text-center" id="alertModalBody">
            Something went wrong.
          </div>
          <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

  <!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>


/* Sidebar Functions*/
        // Toggle Sidebar
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('show');
      }

      // Handle Dropdowns Uniformly
      function handleDropdown(menuId) {
        const clickedIcon = document.getElementById(`icon-${menuId}`);
        const clickedMenu = document.getElementById(menuId);
        const clickedCollapse = bootstrap.Collapse.getOrCreateInstance(clickedMenu);

        // Toggle clicked menu
        if (clickedMenu.classList.contains('show')) {
          clickedCollapse.hide();
          clickedIcon.classList.remove('rotate');
        } else {
          clickedCollapse.show();
          clickedIcon.classList.add('rotate');
        }

        // Hide other open menus
        const allDropdowns = ['violationMenu', 'documentsMenu', 'postingsMenu', 'studentRecordMenu'];
        allDropdowns.forEach(id => {
          if (id !== menuId) {
            const menu = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            const collapse = bootstrap.Collapse.getInstance(menu);
            if (collapse) collapse.hide();
            if (icon) icon.classList.remove('rotate');
          }
        });
      }

      // Highlight Active Link
      document.addEventListener('DOMContentLoaded', function () {
        const currentUrl = window.location.href;
        const navLinks = document.querySelectorAll('.nav-link');

        navLinks.forEach(link => {
          if (link.href && currentUrl.includes(link.href)) {
            link.classList.add('active');
          }
        });
      });
///////////////////////////// START HERE MAG ADD


// ---- Jaisson's----
function getCookie(name){
  const v=`; ${document.cookie}`.split(`; ${name}=`);
  if(v.length===2) return v.pop().split(';').shift();
}
const csrftoken = getCookie('csrftoken');
// ---- Modals ----
const alertModal = new bootstrap.Modal(document.getElementById("alertModal"));
const withdrawModal = new bootstrap.Modal(document.getElementById("withdrawModal"));
const alertModalTitle = document.getElementById("alertModalLabel");
const alertModalBody  = document.getElementById("alertModalBody");

// ---- Elements ----
const form          = document.getElementById("candidateForm");
const previewImage  = document.getElementById("previewImage");
const imageInput    = document.getElementById("imageInput");
const candidateList = document.getElementById("candidateList");
const confirmWithdrawBtn = document.getElementById("confirmWithdrawBtn");
const notice        = document.getElementById("notice");
const positionSelect = document.getElementById('candidatePosition');
const orgGroup = document.getElementById('orgGroup');
const orgInput = document.getElementById('orgInput')

// ---- State ----
let candidates = [];
let withdrawIndex = null;

// ---- Helpers ----
function showAlert(title, message, isError = true){
  alertModalTitle.textContent = title;
  alertModalBody.textContent = message;
  alertModalTitle.className = `modal-title text-white ${isError ? 'bg-danger' : 'bg-success'}`;
  alertModal.show();
}

async function loadCandidates(){
  try{
    const res = await fetch('/admin_election/candidates/');
    const data = await res.json();

    if(data.status !== 'success'){
      // No active election -> read-only empty state
      notice.classList.remove('d-none','alert-success');
      notice.classList.add('alert-warning');
      notice.textContent = 'No active election. Candidates hidden and adding is disabled.';
      disableForm(true);
      candidateList.innerHTML = "<div class='text-center text-muted'>No candidates to display.</div>";
      return;
    }

    // Active election banner
    notice.classList.remove('d-none','alert-warning');
    notice.classList.add('alert-success');
    notice.textContent = `Active: ${data.election.name} (${data.election.academic_year})`;

    disableForm(false);

    candidates = data.candidates || [];
    renderCandidates(candidates);
  } catch(err){
    console.error(err);
    showAlert('Network Error','Failed to load candidates.');
  }
}

function disableForm(disabled){
  form.querySelectorAll('input,select,button').forEach(el => el.disabled = disabled);
}

function renderCandidates(list){
  if(!list.length){
    candidateList.innerHTML = "<div class='text-center text-muted'>No candidates yet.</div>";
    return;
  }
  candidateList.innerHTML = '';
  list.forEach((c, idx) => {
    const card = document.createElement('div');
    card.className = "card d-flex flex-row align-items-center p-2 shadow-sm justify-content-between mb-2";
    card.innerHTML = `
      <div class="d-flex align-items-center w-100 p-3">
        <img src="${c.image || ''}" class="rounded me-3" style="width: 80px; height: 80px; object-fit: cover; ">
        <div style="width:1px;height:80px;background-color:#dee2e6;" class="me-3"></div>
        <div class="flex-grow-1">
          <p class="mb-1 small text-muted"><strong >Name:</strong> ${c.name}</p>
          <p class="mb-1 small text-muted"><strong>Year & Section:</strong> ${c.section}</p>
          <p class="mb-1 small text-muted"><strong>TUPC ID:</strong> ${c.tupc_id}</p>
        </div>
        <div class="text-center me-3">
          <span class="badge bg-secondary px-3 py-2" style="font-size:0.85rem;">${c.position}</span>
          ${c.party ? `<div class="small mt-1"><i class="bi bi-people-fill me-1"></i>${c.party}</div>` : ``}
        </div>
        <div class="d-flex flex-column gap-2 ms-2">
          <button class="btn btn-sm btn-danger withdraw-btn" data-index="${idx}">
            <i class="bi bi-x-circle me-1"></i> Remove
          </button>
        </div>
      </div>
    `;
    candidateList.appendChild(card);
  });
}

// ---- Form submit (ADD) ----
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const name     = document.getElementById("candidateName").value.trim();
  const section  = document.getElementById("candidateSection").value.trim();
  const tupc_id  = document.getElementById("candidateID").value.trim();
  const position = document.getElementById("candidatePosition").value;
  const party    = document.getElementById("candidateParty").value.trim();
  const photo    = imageInput.files[0];
  const org      = (orgInput?.value || '').trim(); // <-- get org here

  if(!name || !section || !tupc_id || !position || !photo){
    showAlert("Missing Fields","Please fill out all required fields and upload a photo.");
    return;
  }

  // Governor requires org
  if (position === 'Governor' && !org) {
    showAlert('Missing Program/Organization','Please enter the program/organization for a Governor candidate.');
    return;
  }

  const fd = new FormData();
  fd.append('name', name);
  fd.append('section', section);
  fd.append('tupc_id', tupc_id);
  fd.append('position', position);
  fd.append('party', party);
  fd.append('photo', photo);
  if (position === 'Governor') fd.append('org', org); // <-- include org only for Governor

  try{
    const res = await fetch('/admin_election/candidates/add/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: fd
    });
    const data = await res.json();
    if(res.ok && data.status === 'success'){
      form.reset();
      previewImage.src = ''; previewImage.style.display = 'none';
      document.getElementById("candidatePosition").selectedIndex = 0;
      orgGroup.classList.add('d-none'); // hide org field after reset
      showAlert('Candidate Added','Successfully added candidate!', false);
      await loadCandidates();
    } else {
      showAlert('Submission Failed', data.message || 'Unknown error.');
    }
  } catch(err){
    console.error(err);
    showAlert('Network Error','Failed to connect to server.');
  }
});

// ---- Delete (Withdraw) ----
document.addEventListener("click", function (e) {
  const btn = e.target.closest(".withdraw-btn");
  if(!btn) return;
  withdrawIndex = parseInt(btn.getAttribute("data-index"), 10);
  withdrawModal.show();
});

confirmWithdrawBtn.addEventListener("click", async () => {
  if(withdrawIndex == null) return;
  const c = candidates[withdrawIndex];
  try{
    const res = await fetch(`/admin_election/candidates/${c.id}/delete/`, {
      method: 'POST', // POST for easy CSRF
      headers: { 'X-CSRFToken': csrftoken }
    });
    const data = await res.json();
    if(res.ok && data.status === 'success'){
      withdrawModal.hide();
      showAlert('Candidate Removed', 'The candidate has been deleted.', false);
      await loadCandidates();
    } else {
      showAlert('Delete Failed', data.message || 'Could not remove candidate.');
    }
  } catch(err){
    console.error(err);
    showAlert('Network Error', 'Could not reach server.');
  } finally {
    withdrawIndex = null;
  }
});

// ---- Image preview ----
document.getElementById('imageBtn').addEventListener('click', () => {
  document.getElementById('imageInput').click();
});

imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  const placeholder = document.getElementById("placeholderText");
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      previewImage.src = e.target.result;
      previewImage.style.display = "block";
      placeholder.style.display = "none";
    };
    reader.readAsDataURL(file);
  } else {
    // reset if user cancels
    previewImage.src = "";
    previewImage.style.display = "none";
    placeholder.style.display = "block";
  }
});
// --- Show org input only for Governors ---
positionSelect.addEventListener('change', () => {
  if (positionSelect.value === 'Governor') {
    orgGroup.classList.remove('d-none');
  } else {
    orgGroup.classList.add('d-none');
    orgInput.value = '';
  }
});

// Apply once on load (in case the select has a remembered value)
document.addEventListener('DOMContentLoaded', () => {
  positionSelect.dispatchEvent(new Event('change'));
});
// ---- Kickoff ----
document.addEventListener('DOMContentLoaded', loadCandidates);





















</script>
</body>
</html>