{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
    <title>OSA -  Good Moral Certificate</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />  
    <!-- Google Fonts: Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <link rel="stylesheet" href="{% static 'myapp/css/client_goodmoral.css' %}">
    <style>
        #pageOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.18);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: progress;
            user-select: none;
            pointer-events: all;
        }
        #pageOverlay.show {
            display: flex;
        }
    </style>
</head>

<body data-bs-spy="scroll" data-bs-target=".navbar" data-bs-offset="70" tabindex="0">
<!-- NAVIGATION BAR -->
<nav class="navbar navbar-expand-lg navbar-custom fixed-top">
    <div class="container-fluid">
          <a id="TUPC" class="navbar-brand" href="#home">
            <img src="{% static 'myapp/images/logo.png' %}" alt="TUP Logo" class="img-fluid me-2">
            <span class="d-none d-sm-inline"><b>Technological University of the Philippines - Cavite<b/></span>
            <span class="d-inline d-sm-none"><b>TUPC</b></span>
         </a>


        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="{% url 'client_home' %}">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'client_home' %}#about">About</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'client_home' %}#services">Services</a></li>
                <li class="nav-item"><a class="nav-link nav-btn" href="{% url 'login' %}">Login</a></li>
            </ul>
        </div>
    </div>
</nav>



<div class="container mt-5 mb-5">
    <br>
    <h1  class="mb-4"> <i class="bi bi-file-earmark-text-fill"></i><b>  Good Moral Certificate Request Form</b></h1><hr>
    <h6 class="mb-4"> Please fill in the required information below.</h6>
    <div id="formAlert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
        <strong>Please fill out all required fields before proceeding.</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    {% if messages %}
    <div class="mt-3">
        {% for message in messages %}
            {% if 'gm-admin' not in message.tags %}
                <div class="alert alert-danger" role="alert">
                    {{ message }}
                </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Step Indicator -->
    <div class="step-indicator mb-4" id="stepIndicator">
        <div class="active" data-step="1"><i class="bi bi-person-fill"></i>  Personal</div>
        <div data-step="2"><i class="bi bi-mortarboard-fill"></i>  Academic</div>
        <div data-step="3"><i class="bi bi-journal-text"></i>  Request</div>
        <div data-step="4"><i class="bi bi-upload"></i>  Verification</div>

    </div>



    <!-- Form -->
    <form id="gmfForm" method="post" action="{% url 'goodmoral_request' %}" enctype="multipart/form-data">
        {% csrf_token %}



        <!-- STEP 1, PERSONAL INFORMATION-->
        <div class="step active card mb-4">
            <div class="card-body">
                <div class="section-title"><i class="bi bi-person-fill"></i>Personal Information</div>
                <hr><br>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">First Name:</label>
                        <input type="text" id="fn_goodmoral" class="form-control" name="first_name" maxlength="50" placeholder="Enter Your First Name" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Middle Name:</label>
                        <input type="text" id="mn_goodmoral" class="form-control" name="middle_name" maxlength="50" placeholder="Enter Your Middle Name" >
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Surname:</label>
                        <input type="text" id="sn_goodmoral" class="form-control" name="surname" maxlength="50" placeholder="Enter Your Last Name" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Extension (Jr., Sr.): OPTIONAL</label>
                        <input type="text" id="ex_goodmoral" class="form-control" name="ext" maxlength="10" placeholder="Enter Your Extension Name">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Sex:</label>
                        <select class="form-select" id="sex_goodmoral" name="sex" required>
                            <option value="">-- Select --</option>
                            <option>Male</option>
                            <option>Female</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>


                <!-- STEP 2, ACADEMIC INFORMATION -->
            <div class="step card mb-4">
                <div class="card-body">
                    <div class="section-title"><i class="bi bi-mortarboard-fill"></i> Academic Information</div>
                    <hr><br>

                    <!-- STUDENT ID NUMBER & PROGRAM/COURSE -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Student ID Number:</label>
                            <input type="text" id="studentID_goodmoral" class="form-control" name="student_id" maxlength="20" placeholder="TUPC-XX-XXXX" required>
                        </div>
                        <div class="col-md-6 mb-3">
                        <label class="form-label">Program/Course:</label>
                            <select id="program_goodmoral" class="form-select" name="program" required>
                                <option value="">-- Select Program --</option>
                            </select>
                        </div>
                    </div>

                    <!-- STATUS & DATE GRADUATED -->
                    <div class="col-md-6 mb-3">
                    <label class="form-label">Status:</label>

                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="status" id="status_graduated" value="Graduated" required onclick="toggleStatusFields()">
                        <label class="form-check-label" for="status_graduated">Alum/Graduated</label>
                    </div>
                    <div class="mt-2" id="graduated_date_field" style="display: none;">
                        <label class="form-label">Year Graduated:</label>
                        <input type="number" class="form-control" name="date_graduated" id="year_graduated_goodmoral" min="1979" step="1" inputmode="numeric" placeholder="e.g., 2024">
                    </div>

                    <div class="form-check mt-2">
                        <input class="form-check-input" type="radio" name="status" id="status_former" value="Former Student" onclick="toggleStatusFields()">
                        <label class="form-check-label" for="status_former">Former Student</label>
                    </div>
                    <div class="mt-2" id="inclusive_years_field" style="display: none;">
                        <label class="form-label">Inclusive Years of Stay:</label>
                        <input type="text" class="form-control" name="inclusive_years" id="stay_goodmoral" placeholder="e.g. 2018-2022">
                    </div>

                    <div class="form-check mt-2">
                        <input class="form-check-input" type="radio" name="status" id="status_current" value="Current Student" onclick="toggleStatusFields()">
                        <label class="form-check-label" for="status_current">Current Student</label>
                    </div>
                    <div class="mt-2" id="admission_date_field" style="display: none;">
                        <label class="form-label">Year of Admission:</label>
                        <input type="number" class="form-control" name="date_admission" id="year_admission_goodmoral" min="1979" step="1" inputmode="numeric" placeholder="e.g., 2021">
                    </div>
                    </div>
                </div>
            </div>



        <!-- STEP 3, REQUEST -->
        <div class="step card mb-4">
            <div class="card-body">
                <div class="section-title"><i class="bi bi-journal-text"></i> Request & Requester Information</div><hr><br>

                <!-- PURPOSE -->
                <div class="mb-3">
                    <label class="form-label">Purpose of Request:</label>
                    <select class="form-select" name="purpose" id="purpose_goodmoral" required onchange="toggleOtherInput()">
                        <option value="">-- Select Purpose of Request --</option>
                        <option value="Employment">Employment</option>
                        <option value="Transfer to Another School">Transfer to Another School</option>
                        <option value="continuing education">Continuing Education</option>
                        <option value="Supervised Industrial Training (SIT)"> Supervised Industrial Training (SIT)</option>
                        <option value="In-Campus Practice Teaching (IPT)">In-Campus Practice Teaching (IPT)</option>
                        <option value="Off-Campus Practice Teaching (OPT)">Off-Campus Practice Teaching (OPT)</option>
                        <option value="Student Development">Student Development ( COMSELEC, USG, Awards. etc.)</option>
                        <option value="Scholarship">Scholarship</option>
                    </select>
                </div>

                <!-- Shown only if Others, Transfer, or Scholarship is selected -->
                <div class="mb-3" id="otherPurposeContainer" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <input type="text" class="form-control" name="other_purpose" id="other_purpose">
                </div>


                <hr class="m"><br>

                <!-- NAME & EMAIL OF REQUESTER -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Name of Requester:</label>
                        <input type="text" class="form-control" id="requester_goodmoral" name="requester_name" maxlength="100" placeholder="Enter your Name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Email of Requester:</label>
                        <input type="email" class="form-control" id="email_req_goodmoral" name="requester_email" maxlength="100" placeholder="@gmail.com" required>
                    </div>
                </div>

                <!-- CONTACT & RELATIONSHIP -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Contact No. of Requester:</label>
                        <input type="tel" class="form-control" id="contact_req_goodmoral" name="requester_contact" maxlength="20" placeholder="+63 9XXXXXXXXX" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Relationship to Alum/Student:</label>
                        <input type="text" class="form-control" id="relationship_goodmoral" name="relationship" maxlength="50" placeholder="e.g., self" required>
                    </div>
                </div>
            </div>
        </div>


        <!-- STEP 4 UPLOAD -->
        <div class="step card mb-4">
            <div class="card-body">
                <div class="section-title"><i class="bi bi-upload"></i>Verification</div> <hr><br>

                <!-- Select Document Type -->
                <div class="mb-3">
                    <label class="form-label">Select Document Type:</label>
                    <select class="form-select" id="documentTypeSelect" name="document_type" required>
                        <option value="">-- Select Document Type --</option>
                        <option value="upload_id">Valid Student ID</option>
                        <option value="upload_ack_receipt">Acknowledgment Receipt</option>
                        <option value="upload_diploma">Diploma</option>
                    </select>
                </div>

                <!-- Upload Field -->
                <div class="mb-3" id="fileInputContainer" style="display: none;">
                    <label id="fileInputLabel" class="form-label">Upload File:</label>
                    <input type="file" class="form-control" name="uploaded_file" id="uploadedFileInput" accept="application/pdf,image/jpeg,image/png">
                </div>

                <hr>

                <!-- Submit Button -->
                <div class="text-end mt-3">
                    <button type="submit" class="btn text-light" style="background-color: #440207; border-color: #440207;"
                  onmouseover="this.style.backgroundColor='#5e0000';"
                  onmouseout="this.style.backgroundColor='#440207';">
                        <i class="bi bi-send-fill"></i> Submit Request
                    </button>
                </div>
            </div>
        </div>

            <!-- Navigation Buttons (Fixed at Bottom of Form) -->
        <div class="fixed-nav mt-4 py-3 d-flex justify-content-between align-items-center px-5">
                <button type="button" class="btn btn-secondary btn-lg" id="prevBtn" onclick="changeStep(-1)">
                    <i class="bi bi-arrow-left-circle-fill"></i> Previous
                </button>
                <button type="button" class="btn btn-primary btn-lg" id="nextBtn" onclick="changeStep(1)">
                    Next <i class="bi bi-arrow-right-circle-fill"></i>
                </button>
        </div>

        <!-- Submission Modal -->
        <div class="modal fade" id="submissionModal" tabindex="-1"
            aria-labelledby="submissionModalLabel" aria-hidden="true"
            data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="submissionModalLabel">Request Submitted</h5>
            </div>
            <div class="modal-body" id="submissionModalBody">
                Your request is being submitted and is subject to approval. You’ll receive an email update. Redirecting to home in ...
                <span id="submitCountdown">5</span> seconds…
            </div>
            <div class="modal-footer">
                <a id="modalHomeBtn" class="btn text-light" style="background-color: #440207; border-color: #440207;"
                  onmouseover="this.style.backgroundColor='#5e0000';"
                  onmouseout="this.style.backgroundColor='#440207';" href="{% url 'client_home' %}">Back to Home now</a>
            </div>
            </div>
        </div>
        </div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% load static %}
<script>
    (() => {
    /* =========================
        Helpers & initial wiring
        ========================= */

    // Ensure Purpose has "Others" (backend expects it)
    function ensureOthersPurpose() {
        const sel = document.getElementById('purpose_goodmoral');
        if (!sel) return;
        const hasOthers = Array.from(sel.options).some(o => o.value === 'Others');
        if (!hasOthers) {
        const opt = document.createElement('option');
        opt.value = 'Others';
        opt.textContent = 'Others';
        sel.appendChild(opt);
        }
    }

    // Populate Program/Course from CSV (or replace text input with <select>)
    function populateProgramsFromCSV() {
        const csvUrl = "{% static 'myapp/data/programs.csv' %}";

        // Prefer an existing <select>; otherwise, replace an <input name="program">
        let select = document.querySelector('#program_goodmoral, select[name="program"]');
        const input = select ? null : document.querySelector('input[name="program"]');
        if (!select && !input) return;

        // If only an input exists, swap it for a select (keeping name/id/required)
        if (!select) {
        select = document.createElement('select');
        select.id = input.id || 'program_goodmoral';
        select.name = input.name || 'program';
        select.className = 'form-select';
        if (input.required) select.required = true;
        input.replaceWith(select);
        }

        const keepPlaceholder = () => {
        const first = select.querySelector('option');
        select.innerHTML = '';
        if (first && first.value === '') {
            select.appendChild(first);
        } else {
            const ph = document.createElement('option');
            ph.value = '';
            ph.textContent = '-- Select Program --';
            ph.disabled = true; ph.selected = true; ph.hidden = true;
            select.appendChild(ph);
        }
        };

        fetch(csvUrl, { cache: 'no-store' })
        .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
        .then(text => {
            const current = (select.value || '').trim();
            text = text.replace(/^\uFEFF/, ''); // strip BOM
            const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            const seen = new Set();
            keepPlaceholder();
            for (const p of lines) {
            if (seen.has(p)) continue;
            seen.add(p);
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = p;
            if (p === current) opt.selected = true; // preserve prefilled
            select.appendChild(opt);
            }
        })
        .catch(err => console.warn('Programs CSV not loaded; leaving field as-is.', err));
    }

    // Show/hide status-dependent fields
    function toggleStatusFields() {
        const graduated = document.getElementById('status_graduated')?.checked;
        const former    = document.getElementById('status_former')?.checked;
        const current   = document.getElementById('status_current')?.checked;

        const yearGraduated = document.getElementById('year_graduated_goodmoral');
        const stayYears     = document.getElementById('stay_goodmoral');
        const yearAdmission = document.getElementById('year_admission_goodmoral');

        // Show/hide wrappers
        const gradWrap  = document.getElementById('graduated_date_field');
        const stayWrap  = document.getElementById('inclusive_years_field');
        const admWrap   = document.getElementById('admission_date_field');

        if (gradWrap) gradWrap.style.display = graduated ? 'block' : 'none';
        if (stayWrap) stayWrap.style.display = former ? 'block' : 'none';
        if (admWrap)  admWrap.style.display  = current ? 'block' : 'none';

        // Required flags
        if (yearGraduated) yearGraduated.required = !!graduated;
        if (stayYears)     stayYears.required     = !!former;
        if (yearAdmission) yearAdmission.required = !!current;
    }

    // Purpose “Others / Scholarship / Transfer” → reveal text box
    function toggleOtherInput() {
        const purposeSelect       = document.getElementById("purpose_goodmoral");
        const otherInputContainer = document.getElementById("otherPurposeContainer");
        const otherInput          = document.getElementById("other_purpose");
        if (!purposeSelect || !otherInputContainer || !otherInput) return;

        const selected = purposeSelect.value;
        let placeholderText = "";

        switch (selected) {
        case "Others":                        placeholderText = "Please specify your purpose"; break;
        case "Transfer to Another School":    placeholderText = "Enter the School Name";       break;
        case "Scholarship":                   placeholderText = "Specify Scholarship";          break;
        }

        if (placeholderText) {
        otherInputContainer.style.display = "block";
        otherInput.required = true;
        otherInput.placeholder = placeholderText;
        } else {
        otherInputContainer.style.display = "none";
        otherInput.required = false;
        otherInput.value = "";
        otherInput.placeholder = "";
        }
    }

    // Verification: document type → file input visible + required
    function updateUploadRequired() {
        const documentTypeSelect = document.getElementById('documentTypeSelect');
        const fileInputContainer = document.getElementById('fileInputContainer');
        const fileInputLabel     = document.getElementById('fileInputLabel');
        const uploadedFileInput  = document.getElementById('uploadedFileInput');
        if (!documentTypeSelect || !fileInputContainer || !fileInputLabel || !uploadedFileInput) return;

        const selectedText = documentTypeSelect.options[documentTypeSelect.selectedIndex]?.text || 'File';
        if (documentTypeSelect.value) {
        fileInputContainer.style.display = 'block';
        fileInputLabel.textContent = `Upload ${selectedText}:`;
        uploadedFileInput.required = true;
        } else {
        fileInputContainer.style.display = 'none';
        uploadedFileInput.required = false;
        uploadedFileInput.value = '';
        uploadedFileInput.classList.remove('is-invalid');
        }
    }

    // Run your togglers on load so prefilled values render correctly
    function initTogglesOnLoad() {
        try { toggleStatusFields(); } catch(_) {}
        try { toggleOtherInput();   } catch(_) {}
        try { updateUploadRequired(); } catch(_) {}
    }

    /* ===============
        Stepper logic
        =============== */
    let currentStep = 1;
    const steps = () => document.getElementsByClassName('step');
    const indicators = () => document.getElementById('stepIndicator')?.children || [];

    function showStep(step) {
        const S = steps();
        for (let i = 0; i < S.length; i++) S[i].classList.remove('active');
        if (S[step - 1]) S[step - 1].classList.add('active');

        const I = indicators();
        for (let i = 0; i < I.length; i++) {
        I[i].classList.remove('active', 'done');
        if (i < step - 1) I[i].classList.add('done');
        else if (i === step - 1) I[i].classList.add('active');
        }

        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const fixedNav = document.querySelector('.fixed-nav');
        if (!prevBtn || !nextBtn || !fixedNav) return;

        if (step === 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'inline-block';
        fixedNav.classList.remove('justify-content-between');
        fixedNav.classList.add('justify-content-end');
        } else if (step === S.length) {
        prevBtn.style.display = 'inline-block';
        nextBtn.style.display = 'none';
        fixedNav.classList.remove('justify-content-end');
        fixedNav.classList.add('justify-content-between');
        } else {
        prevBtn.style.display = 'inline-block';
        nextBtn.style.display = 'inline-block';
        fixedNav.classList.remove('justify-content-end');
        fixedNav.classList.add('justify-content-between');
        }
    }

    function changeStep(n) {
        const alertDiv = document.getElementById('formAlert');
        if (alertDiv) {
        alertDiv.classList.add('d-none');
        alertDiv.textContent = 'Please fill out all required fields correctly before proceeding.';
        }

        if (n > 0) {
        const S = steps();
        const stepIndex = Array.from(S).findIndex(s => s.classList.contains('active'));
        const curStep = stepIndex + 1;
        const currentFields = S[stepIndex]?.querySelectorAll('input, select, textarea') || [];
        let valid = true;

        // General required field validation (middle_name not required)
        currentFields.forEach(field => {
            // Required field check (skip middle_name)
            if (field.hasAttribute('required') && !field.value.trim() && field.name !== 'middle_name') {
                valid = false;
                field.classList.add('is-invalid');
                field.setCustomValidity("This field is required.");
                field.reportValidity();
            } 
            // No numbers allowed: first, middle, surname
            else if (
                (field.name === 'first_name' || field.name === 'middle_name' || field.name === 'surname') 
                && field.value.trim() !== "" 
                && /\d/.test(field.value)
            ) {
                valid = false;
                field.classList.add('is-invalid');
                field.setCustomValidity("Numbers are not allowed in this field.");
                field.reportValidity();
            } 
            else {
                field.classList.remove('is-invalid');
                field.setCustomValidity(""); // clear error state
            }
        });

        // Step 2: Academic Info validation
        if (valid && curStep === 2) {
            const statusRadios = document.querySelectorAll('input[name="status"]');
            const oneSelected = Array.from(statusRadios).some(r => r.checked);
            if (!oneSelected) {
            valid = false;
            if (alertDiv) alertDiv.textContent = 'Please select your status (Current, Former, or Alum/Graduated).';
            }

            const studentID     = document.getElementById('studentID_goodmoral');
            const stayYears     = document.getElementById('stay_goodmoral');
            const yearAdmission = document.getElementById('year_admission_goodmoral');
            const yearGraduated = document.getElementById('year_graduated_goodmoral');

            const graduated = document.getElementById('status_graduated')?.checked;
            const former    = document.getElementById('status_former')?.checked;
            const current   = document.getElementById('status_current')?.checked;

            const idPattern   = /^TUPC-\d{2}-\d{4}$/;
            const stayPattern = /^\d{4}-\d{4}$/;
            const yearPattern = /^\d{4}$/;
            const CURRENT_YEAR = new Date().getFullYear();

            if (studentID && !idPattern.test(studentID.value.trim())) {
            valid = false;
            studentID.classList.add('is-invalid');
            if (alertDiv) alertDiv.textContent = 'Student ID must match the format: TUPC-XX-XXXX';
            } else if (studentID) studentID.classList.remove('is-invalid');

            if (former) {
            if (!stayYears || !stayPattern.test(stayYears.value.trim())) {
                valid = false;
                if (stayYears) stayYears.classList.add('is-invalid');
                if (alertDiv) alertDiv.textContent = 'Inclusive Years of Stay must match the format: YYYY-YYYY';
            } else {
                // Extra ordering/range guard
                const [a,b] = stayYears.value.split('-').map(Number);
                if (a < 1979 || b < a || b > CURRENT_YEAR) {
                valid = false;
                stayYears.classList.add('is-invalid');
                if (alertDiv) alertDiv.textContent = `Inclusive Years must be 1979–${CURRENT_YEAR} and in order (e.g., 2018-2022).`;
                } else {
                stayYears.classList.remove('is-invalid');
                }
            }
            } else if (stayYears) stayYears.classList.remove('is-invalid');

            if (current) {
            const y = yearAdmission?.value.trim() || '';
            if (!(yearPattern.test(y) && +y >= 1979 && +y <= CURRENT_YEAR)) {
                valid = false;
                if (yearAdmission) yearAdmission.classList.add('is-invalid');
                if (alertDiv) alertDiv.textContent = `Please enter a valid admission year (1979–${CURRENT_YEAR}).`;
            } else if (yearAdmission) yearAdmission.classList.remove('is-invalid');
            }

            if (graduated) {
            const y = yearGraduated?.value.trim() || '';
            if (!(yearPattern.test(y) && +y >= 1979 && +y <= CURRENT_YEAR)) {
                valid = false;
                if (yearGraduated) yearGraduated.classList.add('is-invalid');
                if (alertDiv) alertDiv.textContent = `Please enter a valid graduation year (1979–${CURRENT_YEAR}).`;
            } else if (yearGraduated) yearGraduated.classList.remove('is-invalid');
            }
        }

        // Step 3: Requester Info
        if (valid && curStep === 3) {
            const email   = document.getElementById('email_req_goodmoral');
            const contact = document.getElementById('contact_req_goodmoral');

            const emailPattern   = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const contactPattern = /^\+63 9\d{9}$/;

            if (email && !emailPattern.test(email.value.trim())) {
            valid = false;
            email.classList.add('is-invalid');
            if (alertDiv) alertDiv.textContent = 'Please enter a valid email address.';
            } else if (email) email.classList.remove('is-invalid');

            if (contact && !contactPattern.test(contact.value.trim())) {
            valid = false;
            contact.classList.add('is-invalid');
            if (alertDiv) alertDiv.textContent = 'Contact number must match format: +63 9XXXXXXXXX';
            } else if (contact) contact.classList.remove('is-invalid');
        }

        // Step 4: File Upload step validation
        if (valid && curStep === 4) {
            const documentType = document.getElementById('documentTypeSelect');
            const uploadedFile = document.getElementById('uploadedFileInput');
            const maxSize = 10 * 1024 * 1024; // 10MB

            if (!documentType?.value) {
            valid = false;
            if (documentType) documentType.classList.add('is-invalid');
            if (alertDiv) alertDiv.textContent = 'Please select a document type.';
            } else if (documentType) documentType.classList.remove('is-invalid');

            if (!uploadedFile?.value) {
            valid = false;
            if (uploadedFile) uploadedFile.classList.add('is-invalid');
            if (alertDiv) alertDiv.textContent = 'Please upload a document file.';
            } else {
            const file = uploadedFile.files?.[0];
            if (file && file.size > maxSize) {
                valid = false;
                uploadedFile.classList.add('is-invalid');
                if (alertDiv) alertDiv.textContent = 'File size must not exceed 10MB.';
            } else {
                uploadedFile.classList.remove('is-invalid');
            }
            }
        }

        if (!valid) {
            if (alertDiv) {
            alertDiv.classList.remove('d-none');
            alertDiv.scrollIntoView({ behavior: 'smooth' });
            }
            return;
        }
        }

        // Advance or retreat steps
        const S = steps();
        let stepIndex = Array.from(S).findIndex(s => s.classList.contains('active'));
        const target = stepIndex + 1 + n;
        if (target >= 1 && target <= S.length) {
        S[stepIndex].classList.remove('active');
        S[target - 1].classList.add('active');

        const I = indicators();
        for (let i = 0; i < I.length; i++) {
            I[i].classList.remove('active', 'done');
            if (i < target - 1) I[i].classList.add('done');
            else if (i === target - 1) I[i].classList.add('active');
        }

        currentStep = target;

        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const fixedNav = document.querySelector('.fixed-nav');
        if (currentStep === 1) {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'inline-block';
            fixedNav.classList.remove('justify-content-between');
            fixedNav.classList.add('justify-content-end');
        } else if (currentStep === S.length) {
            prevBtn.style.display = 'inline-block';
            nextBtn.style.display = 'none';
            fixedNav.classList.remove('justify-content-end');
            fixedNav.classList.add('justify-content-between');
        } else {
            prevBtn.style.display = 'inline-block';
            nextBtn.style.display = 'inline-block';
            fixedNav.classList.remove('justify-content-end');
            fixedNav.classList.add('justify-content-between');
        }
        }
    }

    // Expose these for your HTML onclick handlers
    window.showStep = showStep;
    window.changeStep = changeStep;
    window.toggleStatusFields = toggleStatusFields;
    window.toggleOtherInput = toggleOtherInput;

    /* =======================================
        Submit: enforce required upload + size
        ======================================= */
    function wireSubmit() {
        const form     = document.getElementById('gmfForm');
        const alertDiv = document.getElementById('formAlert');
        const modalEl  = document.getElementById('submissionModal');
        if (!form) return;

        const modal       = modalEl ? new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false }) : null;
        const countdownEl = document.getElementById('submitCountdown');
        const bodyEl      = document.getElementById('submissionModalBody');
        const homeUrl     = "{% url 'client_home' %}";
        const getCSRF     = () => (form.querySelector('input[name="csrfmiddlewaretoken"]') || {}).value || '';

        form.addEventListener('submit', (e) => {
        e.preventDefault();

        // 1) Native HTML5 validation first
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            if (alertDiv) {
            alertDiv.textContent = 'Please fill out all required fields correctly before submitting.';
            alertDiv.classList.remove('d-none');
            }
            const firstInvalid = form.querySelector(':invalid');
            if (firstInvalid) {
            // Jump to the step containing the first invalid field
            const stepEl = firstInvalid.closest('.step');
            const S = Array.from(steps());
            const idx = S.indexOf(stepEl);
            if (idx >= 0) showStep(idx + 1);
            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstInvalid.focus({ preventScroll: true });
            }
            return;
        }

        // 2) Extra guards for Verification step
        const documentTypeSelect = document.getElementById('documentTypeSelect');
        const uploadedFileInput  = document.getElementById('uploadedFileInput');
        const MAX_SIZE = 10 * 1024 * 1024; // 10MB
        let ok = true;

        if (!documentTypeSelect?.value) {
            ok = false;
            documentTypeSelect?.classList.add('is-invalid');
        } else {
            documentTypeSelect?.classList.remove('is-invalid');
        }

        const file = uploadedFileInput?.files?.[0];
        if (!file) {
            ok = false;
            uploadedFileInput?.classList.add('is-invalid');
        } else if (file.size > MAX_SIZE) {
            ok = false;
            uploadedFileInput?.classList.add('is-invalid');
            if (alertDiv) {
            alertDiv.textContent = 'File size must not exceed 10MB.';
            alertDiv.classList.remove('d-none');
            }
            showStep(4);
            return;
        } else {
            uploadedFileInput?.classList.remove('is-invalid');
        }

        if (!ok) {
            if (alertDiv) {
            alertDiv.textContent = 'Please select a document type and upload the file.';
            alertDiv.classList.remove('d-none');
            }
            showStep(4);
            uploadedFileInput?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            uploadedFileInput?.focus({ preventScroll: true });
            return;
        }

        // 3) Modal + 5s countdown + AJAX submit
        modal?.show();
        form.querySelectorAll('button[type="submit"], input[type="submit"]').forEach(b => b.disabled = true);

        let secs = 5;
        if (countdownEl) countdownEl.textContent = secs;
        const delay = new Promise(resolve => {
            const t = setInterval(() => {
            secs -= 1;
            if (countdownEl) countdownEl.textContent = secs;
            if (secs <= 0) { clearInterval(t); resolve(); }
            }, 1000);
        });

        const post = fetch(form.action, {
            method: form.method || 'POST',
            body: new FormData(form),
            headers: { 'X-CSRFToken': getCSRF(), 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin'
        }).then(resp => {
            if (!resp.ok) throw new Error('Submit failed');
            return resp.text();
        });

        Promise.all([post, delay]).then(() => {
            window.location.assign(homeUrl);
        }).catch(() => {
            if (bodyEl) bodyEl.innerHTML = '<div class="text-danger">Submission failed. Please check required fields and try again.</div>';
            form.querySelectorAll('button[type="submit"], input[type="submit"]').forEach(b => b.disabled = false);
        });
        });
    }

    /* ======================================
        Field normalizers & year constraints
        ====================================== */

    // Names: strip trailing spaces; Email/Relationship: no spaces; Contact: normalize + pattern
    function wireFieldNormalizers() {
        // Names: allow internal spaces; forbid trailing spaces
        const rtrimIds = ['fn_goodmoral','mn_goodmoral','sn_goodmoral','requester_goodmoral'];
        rtrimIds.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('blur', () => {
            el.value = (el.value || '').replace(/\s+$/, '');
        });
        });

        // Email & Relationship: block/strip spaces
        const noSpaceIds = ['email_req_goodmoral','relationship_goodmoral'];
        noSpaceIds.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('keydown', (e) => { if (e.key === ' ' || e.code === 'Space') e.preventDefault(); });
        el.addEventListener('beforeinput', (e) => { if (e.data && /\s/.test(e.data)) e.preventDefault(); });
        const strip = () => {
            const cleaned = (el.value || '').replace(/\s+/g, '');
            if (el.value !== cleaned) el.value = cleaned;
        };
        el.addEventListener('input', strip);
        el.addEventListener('blur', strip);
        el.addEventListener('paste', (e) => {
            e.preventDefault();
            const txt = (e.clipboardData || window.clipboardData).getData('text');
            document.execCommand('insertText', false, (txt || '').replace(/\s+/g, ''));
        });
        });

        // Contact: keep "+63 9XXXXXXXXX" shape usable on mobile
        (function () {
        const el = document.getElementById('contact_req_goodmoral');
        if (!el) return;
        el.setAttribute('pattern', '^\\+63 9\\d{9}$');
        el.setAttribute('inputmode', 'tel');
        el.addEventListener('input', () => {
            let v = el.value || '';
            v = v.replace(/[^\d +]/g, '');   // allow digits, single spaces, single leading +
            v = v.replace(/(?!^)\+/g, '');
            v = v.replace(/ {2,}/g, ' ');
            v = v.replace(/\s+$/, '');
            v = v.replace(/^\+63(?!\s|$)/, '+63 ');
            el.value = v;
        });
        el.addEventListener('blur', () => { el.value = (el.value || '').replace(/\s+$/, ''); });
        el.addEventListener('paste', (e) => {
            e.preventDefault();
            let txt = (e.clipboardData || window.clipboardData).getData('text') || '';
            txt = txt.replace(/[^\d +]/g, '')
                    .replace(/(?!^)\+/g, '')
                    .replace(/ {2,}/g, ' ')
                    .replace(/\s+$/, '');
            document.execCommand('insertText', false, txt);
        });
        })();

        // Normalize again right before submit (defense in depth)
        const form = document.getElementById('gmfForm');
        if (form) form.addEventListener('submit', () => {
        rtrimIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = (el.value || '').replace(/\s+$/, '');
        });
        noSpaceIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = (el.value || '').replace(/\s+/g, '');
        });
        const c = document.getElementById('contact_req_goodmoral');
        if (c) c.value = (c.value || '').replace(/\s+$/, '');
        });
    }

    // Year inputs: numeric only, clamp visually, mark invalid if out of 1979–current
    function wireYearFields() {
        const YEAR_IDS = ['year_graduated_goodmoral', 'year_admission_goodmoral'];
        const MIN = 1979;
        const CUR = new Date().getFullYear();

        YEAR_IDS.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.setAttribute('inputmode', 'numeric');
        el.setAttribute('step', '1');
        el.setAttribute('max', String(CUR));

        el.addEventListener('keydown', (e) => { if (e.key === ' ' || e.code === 'Space') e.preventDefault(); });
        el.addEventListener('beforeinput', (e) => { if (e.data && /\s/.test(e.data)) e.preventDefault(); });

        el.addEventListener('input', () => {
            let v = el.value || '';
            v = v.replace(/\s+/g, '');
            v = v.replace(/\D+/g, '');
            if (v.length > 4) v = v.slice(0, 4);
            el.value = v;
        });

        el.addEventListener('blur', () => {
            let v = (el.value || '').replace(/\s+$/, '').replace(/\D+/g, '').slice(0, 4);
            el.value = v;
            if (v.length === 4) {
            const n = +v;
            if (n < MIN || n > CUR) el.classList.add('is-invalid');
            else el.classList.remove('is-invalid');
            } else if (v.length > 0) {
            el.classList.add('is-invalid');
            } else {
            el.classList.remove('is-invalid');
            }
        });
        });
    }

    /* =================
        Event listeners
        ================= */
    document.addEventListener('DOMContentLoaded', () => {
        // Initial step render (safe if HTML sets active manually)
        try { showStep(currentStep); } catch(_) {}

        ensureOthersPurpose();
        populateProgramsFromCSV();
        wireFieldNormalizers();
        wireYearFields();
        wireSubmit();

        // Upload area
        document.getElementById('documentTypeSelect')?.addEventListener('change', updateUploadRequired);
    });

    window.addEventListener('load', () => {
        initTogglesOnLoad();
    });
    })();
</script>


</body>
</html>