{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
    <title>OSA -  Good Moral Certificate</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />  
    <!-- Google Fonts: Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <link rel="stylesheet" href="{% static 'myapp/css/client_goodmoral.css' %}">
    <style>
        #pageOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.18);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: progress;
            user-select: none;
            pointer-events: all;
        }
        #pageOverlay.show {
            display: flex;
        }
    </style>
</head>

<body data-bs-spy="scroll" data-bs-target=".navbar" data-bs-offset="70" tabindex="0">
<!-- NAVIGATION BAR -->
<nav class="navbar navbar-expand-lg navbar-custom fixed-top">
    <div class="container-fluid">
          <a id="TUPC" class="navbar-brand" href="#home">
            <img src="{% static 'myapp/images/logo.png' %}" alt="TUP Logo" class="img-fluid me-2">
            <span class="d-none d-sm-inline"><b>Technological University of the Philippines - Cavite<b/></span>
            <span class="d-inline d-sm-none"><b>TUPC</b></span>
         </a>


        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="{% url 'client_home' %}">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'client_home' %}#about">About</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'client_home' %}#services">Services</a></li>
                <li class="nav-item"><a class="nav-link nav-btn" href="{% url 'login' %}">Login</a></li>
            </ul>
        </div>
    </div>
</nav>



<div class="container mt-5 mb-5">
    <br>
    <h1  class="mb-4"> <i class="bi bi-file-earmark-text-fill"></i><b>  Good Moral Certificate Request Form</b></h1><hr>
    <h6 class="mb-4"> Please fill in the required information below.</h6>
    <div id="formAlert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
        <strong>Please fill out all required fields before proceeding.</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    {% if messages %}
    <div class="mt-3">
        {% for message in messages %}
        <div class="alert alert-danger" role="alert">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Step Indicator -->
    <div class="step-indicator mb-4" id="stepIndicator">
        <div class="active" data-step="1"><i class="bi bi-person-fill"></i>  Personal</div>
        <div data-step="2"><i class="bi bi-mortarboard-fill"></i>  Academic</div>
        <div data-step="3"><i class="bi bi-journal-text"></i>  Request</div>
        <div data-step="4"><i class="bi bi-upload"></i>  Upload</div>

    </div>



    <!-- Form -->
    <form id="gmfForm" method="post" action="{% url 'goodmoral_request' %}" enctype="multipart/form-data">
        {% csrf_token %}



        <!-- STEP 1, PERSONAL INFORMATION-->
        <div class="step active card mb-4">
            <div class="card-body">
                <div class="section-title"><i class="bi bi-person-fill"></i>Personal Information</div>
                <hr><br>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">First Name:</label>
                        <input type="text" id="fn_goodmoral" class="form-control" name="first_name" maxlength="50" placeholder="Enter Your First Name" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Middle Name:</label>
                        <input type="text" id="mn_goodmoral" class="form-control" name="middle_name" maxlength="50" placeholder="Enter Your Middle Name">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Surname:</label>
                        <input type="text" id="sn_goodmoral" class="form-control" name="surname" maxlength="50" placeholder="Enter Your Last Name" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Extension (Jr., Sr.):</label>
                        <input type="text" id="ex_goodmoral" class="form-control" name="ext" maxlength="10" placeholder="Enter Your Extension Name">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Sex:</label>
                        <select class="form-select" id="sex_goodmoral" name="sex" required>
                            <option value="">-- Select --</option>
                            <option>Male</option>
                            <option>Female</option>
                            <option>Other</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>


                <!-- STEP 2, ACADEMIC INFORMATION -->
            <div class="step card mb-4">
                <div class="card-body">
                    <div class="section-title"><i class="bi bi-mortarboard-fill"></i> Academic Information</div>
                    <hr><br>

                    <!-- STUDENT ID NUMBER & PROGRAM/COURSE -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Student ID Number:</label>
                            <input type="text" id="studentID_goodmoral" class="form-control" name="student_id" maxlength="20" placeholder="TUPC-XX-XXXX" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Program/Course:</label>
                            <input type="text" id="program_goodmoral" class="form-control" name="program"  minlength = "10" placeholder="Bachelor of ..." maxlength="175" required>         
                        </div>
                    </div>

                    <!-- STATUS & DATE GRADUATED -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Status:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="status_graduated" value="Graduated" required onclick="toggleStatusFields()" required>
                            <label class="form-check-label" for="status_graduated">Alum/Graduated</label>
                        </div>
                        <div class="mt-2" id="graduated_date_field" style="display: none;">
                            <label class="form-label">Date Graduated:</label>
                            <input type="date" class="form-control" name="date_graduated" id="date_graduated_goodmoral" min="1979-01-01">
                        </div>

                        <div class="form-check mt-2">
                            <input class="form-check-input" type="radio" name="status" id="status_former" value="Former Student" onclick="toggleStatusFields()">
                            <label class="form-check-label" for="status_former">Former Student</label>
                        </div>
                        <div class="mt-2" id="inclusive_years_field" style="display: none;">
                            <label class="form-label">Inclusive Years of Stay:</label>
                            <input type="text" class="form-control" name="inclusive_years" id="stay_goodmoral" placeholder="e.g. 2018-2022">
                        </div>

                        <div class="form-check mt-2">
                            <input class="form-check-input" type="radio" name="status" id="status_current" value="Current Student" onclick="toggleStatusFields()">
                            <label class="form-check-label" for="status_current">Current Student</label>
                        </div>
                        <div class="mt-2" id="admission_date_field" style="display: none;">
                            <label class="form-label">Date of Admission:</label>
                            <input type="text" class="form-control" name="date_admission" id="admission_date_goodmoral" placeholder="Year of Admission or Exact Date">
                        </div>
                    </div>

                </div>
            </div>



        <!-- STEP 3, REQUEST -->
        <div class="step card mb-4">
            <div class="card-body">
                <div class="section-title"><i class="bi bi-journal-text"></i> Request & Requester Information</div><hr><br>

                <!-- PURPOSE -->
                <div class="mb-3">
                    <label class="form-label">Purpose of Request:</label>
                    <select class="form-select" name="purpose" id="purpose_goodmoral" required onchange="toggleOtherInput()">
                        <option value="">-- Select Purpose of Request --</option>
                        <option value="Employment">Employment</option>
                        <option value="Transfer to Another School">Transfer to Another School</option>
                        <option value="SIT/OPT"> Supervised Industrial Training (SIT) / Off-Campus Practice Teaching (OPT) </option>
                        <option value="Student Development">Student Development ( COMSELEC, USG, Awards. etc.)</option>
                        <option value="Scholarship">Scholarship</option>
                    </select>
                </div>

                <!-- Shown only if Others, Transfer, or Scholarship is selected -->
                <div class="mb-3" id="otherPurposeContainer" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <input type="text" class="form-control" name="other_purpose" id="other_purpose">
                </div>


                <hr class="m"><br>

                <!-- NAME & EMAIL OF REQUESTER -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Name of Requester:</label>
                        <input type="text" class="form-control" id="requester_goodmoral" name="requester_name" maxlength="100" placeholder="Enter your Name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Email of Requester:</label>
                        <input type="email" class="form-control" id="email_req_goodmoral" name="requester_email" maxlength="100" placeholder="@gmail.com" required>
                    </div>
                </div>

                <!-- CONTACT & RELATIONSHIP -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Contact No. of Requester:</label>
                        <input type="tel" class="form-control" id="contact_req_goodmoral" name="requester_contact" maxlength="20" placeholder="+63 9XXXXXXXXX" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Relationship to Alum/Student:</label>
                        <input type="text" class="form-control" id="relationship_goodmoral" name="relationship" maxlength="50" placeholder="e.g., self" required>
                    </div>
                </div>
            </div>
        </div>


        <!-- STEP 4 UPLOAD -->
        <div class="step card mb-4">
            <div class="card-body">
                <div class="section-title"><i class="bi bi-upload"></i> Upload Document</div> <hr><br>

                <!-- Select Document Type -->
                <div class="mb-3">
                    <label class="form-label">Select Document Type:</label>
                    <select class="form-select" id="documentTypeSelect" name="document_type" required>
                        <option value="">-- Select Document Type --</option>
                        <option value="upload_id">Valid Student ID</option>
                        <option value="upload_ack_receipt">Acknowledgment Receipt</option>
                        <option value="upload_diploma">Diploma</option>
                    </select>
                </div>

                <!-- Upload Field -->
                <div class="mb-3" id="fileInputContainer" style="display: none;">
                    <label id="fileInputLabel" class="form-label">Upload File:</label>
                    <input type="file" class="form-control" name="uploaded_file" id="uploadedFileInput" accept=".jpg,.jpeg,.png,.pdf" required>
                </div>

                <hr>

                <!-- Submit Button -->
                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-send-fill"></i> Submit Request
                    </button>
                </div>
            </div>
        </div>

            <!-- Navigation Buttons (Fixed at Bottom of Form) -->
        <div class="fixed-nav mt-4 py-3 d-flex justify-content-between align-items-center px-5">
                <button type="button" class="btn btn-secondary btn-lg" id="prevBtn" onclick="changeStep(-1)">
                    <i class="bi bi-arrow-left-circle-fill"></i> Previous
                </button>
                <button type="button" class="btn btn-primary btn-lg" id="nextBtn" onclick="changeStep(1)">
                    Next <i class="bi bi-arrow-right-circle-fill"></i>
                </button>
        </div>

        <!-- Submission Modal -->
        <div class="modal fade" id="submissionModal" tabindex="-1"
            aria-labelledby="submissionModalLabel" aria-hidden="true"
            data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="submissionModalLabel">Request Submitted</h5>
            </div>
            <div class="modal-body" id="submissionModalBody">
                Your request is being submitted and is subject to approval. You’ll receive an email update. Redirecting to home in ...
                <span id="submitCountdown">5</span> seconds…
            </div>
            <div class="modal-footer">
                <a id="modalHomeBtn" class="btn btn-primary" href="{% url 'client_home' %}">Back to Home now</a>
            </div>
            </div>
        </div>
        </div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Stepper JS -->
<script>
    // Stepper Logic
    let currentStep = 1;
    const steps = document.getElementsByClassName('step');
    const indicators = document.getElementById('stepIndicator').children;

    showStep(currentStep);

    function showStep(step) {
        for (let i = 0; i < steps.length; i++) {
            steps[i].classList.remove('active');
        }
        steps[step - 1].classList.add('active');

        for (let i = 0; i < indicators.length; i++) {
            indicators[i].classList.remove('active', 'done');
            if (i < step - 1) {
                indicators[i].classList.add('done');
            } else if (i === step - 1) {
                indicators[i].classList.add('active');
            }
        }

        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const fixedNav = document.querySelector('.fixed-nav');

        if (step === 1) {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'inline-block';
            fixedNav.classList.remove('justify-content-between');
            fixedNav.classList.add('justify-content-end');
        } else if (step === steps.length) {
            prevBtn.style.display = 'inline-block';
            nextBtn.style.display = 'none';
            fixedNav.classList.remove('justify-content-end');
            fixedNav.classList.add('justify-content-between');
        } else {
            prevBtn.style.display = 'inline-block';
            nextBtn.style.display = 'inline-block';
            fixedNav.classList.remove('justify-content-end');
            fixedNav.classList.add('justify-content-between');
        }
    }

    function changeStep(n) {
        const alertDiv = document.getElementById('formAlert');
        alertDiv.classList.add('d-none');
        alertDiv.textContent = 'Please fill out all required fields correctly before proceeding.';

        if (n > 0) {
            const currentFields = steps[currentStep - 1].querySelectorAll('input, select, textarea');
            let valid = true;

            // General required field validation (except middle name)
            currentFields.forEach(field => {
                if (
                    field.hasAttribute('required') &&
                    !field.value.trim() &&
                    field.name !== 'middle_name'
                ) {
                    valid = false;
                    field.classList.add('is-invalid');
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            // Step 2: Academic Info validation
            if (valid && currentStep === 2) {
                const statusRadios = document.querySelectorAll('input[name="status"]');
                const oneSelected = Array.from(statusRadios).some(r => r.checked);
                if (!oneSelected) {
                    valid = false;
                    alertDiv.textContent = 'Please select your status (Current, Former, or Alum/Graduated).';
                }

                const studentID = document.getElementById('studentID_goodmoral');
                const stayYears = document.getElementById('stay_goodmoral');
                const dateAdmission = document.getElementById('admission_date_goodmoral');
                const dateGraduated = document.getElementById('date_graduated_goodmoral');

                const graduated = document.getElementById('status_graduated').checked;
                const former = document.getElementById('status_former').checked;
                const current = document.getElementById('status_current').checked;

                const idPattern = /^TUPC-\d{2}-\d{4}$/;
                const stayPattern = /^\d{4}-\d{4}$/;

                if (!idPattern.test(studentID.value.trim())) {
                    valid = false;
                    studentID.classList.add('is-invalid');
                    alertDiv.textContent = 'Student ID must match the format: TUPC-XX-XXXX';
                } else {
                    studentID.classList.remove('is-invalid');
                }

                if (former && !stayPattern.test(stayYears.value.trim())) {
                    valid = false;
                    stayYears.classList.add('is-invalid');
                    alertDiv.textContent = 'Inclusive Years of Stay must match the format: YYYY-YYYY';
                } else {
                    stayYears.classList.remove('is-invalid');
                }

                if (current && !dateAdmission.value) {
                    valid = false;
                    dateAdmission.classList.add('is-invalid');
                    alertDiv.textContent = 'Please enter your admission date.';
                } else {
                    dateAdmission.classList.remove('is-invalid');
                }

                if (graduated && !dateGraduated.value) {
                    valid = false;
                    dateGraduated.classList.add('is-invalid');
                    alertDiv.textContent = 'Please enter your graduation date.';
                } else {
                    dateGraduated.classList.remove('is-invalid');
                }
            }

            // Step 3: Requester Info
            if (valid && currentStep === 3) {
                const email = document.getElementById('email_req_goodmoral');
                const contact = document.getElementById('contact_req_goodmoral');

                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const contactPattern = /^\+63 9\d{9}$/;

                if (!emailPattern.test(email.value.trim())) {
                    valid = false;
                    email.classList.add('is-invalid');
                    alertDiv.textContent = 'Please enter a valid email address.';
                } else {
                    email.classList.remove('is-invalid');
                }

                if (!contactPattern.test(contact.value.trim())) {
                    valid = false;
                    contact.classList.add('is-invalid');
                    alertDiv.textContent = 'Contact number must match format: +63 9XXXXXXXXX';
                } else {
                    contact.classList.remove('is-invalid');
                }
            }

            // Step 4: File Upload
            if (valid && currentStep === 4) {
                const documentType = document.getElementById('documentTypeSelect');
                const uploadedFile = document.getElementById('uploadedFileInput');
                const maxSize = 10 * 1024 * 1024; // 10MB

                if (!documentType.value) {
                    valid = false;
                    documentType.classList.add('is-invalid');
                    alertDiv.textContent = 'Please select a document type.';
                } else {
                    documentType.classList.remove('is-invalid');
                }

                if (!uploadedFile.value) {
                    valid = false;
                    uploadedFile.classList.add('is-invalid');
                    alertDiv.textContent = 'Please upload a document file.';
                } else {
                    const file = uploadedFile.files[0];
                    if (file && file.size > maxSize) {
                        valid = false;
                        uploadedFile.classList.add('is-invalid');
                        alertDiv.textContent = 'File size must not exceed 10MB.';
                    } else {
                        uploadedFile.classList.remove('is-invalid');
                    }
                }
            }

            // Show error if invalid
            if (!valid) {
                alertDiv.classList.remove('d-none');
                alertDiv.scrollIntoView({ behavior: 'smooth' });
                return;
            }
        }

        // Advance or retreat steps
        if (currentStep + n >= 1 && currentStep + n <= steps.length) {
            currentStep += n;
            showStep(currentStep);
        }
    }



    // Document Upload Logic
    const documentTypeSelect = document.getElementById('documentTypeSelect');
    const fileInputContainer = document.getElementById('fileInputContainer');
    const fileInputLabel = document.getElementById('fileInputLabel');

    documentTypeSelect.addEventListener('change', () => {
        const selected = documentTypeSelect.options[documentTypeSelect.selectedIndex].text;
        if (documentTypeSelect.value) {
            fileInputContainer.style.display = 'block';
            fileInputLabel.textContent = `Upload ${selected}:`;
        } else {
            fileInputContainer.style.display = 'none';
        }
    });



    // "Others" - Hidden Input Text
    function toggleOtherInput() {
        const purposeSelect = document.getElementById("purpose_goodmoral");
        const otherInputContainer = document.getElementById("otherPurposeContainer");
        const otherInput = document.getElementById("other_purpose");

        const selected = purposeSelect.value;

        let placeholderText = "";

        switch (selected) {
            case "Others":
                placeholderText = "Please specify your purpose";
                break;
            case "Transfer to Another School":
                placeholderText = "Enter the School Name";
                break;
            case "Scholarship":
                placeholderText = "Specify Scholarship";
                break;
        }

        if (placeholderText !== "") {
            otherInputContainer.style.display = "block";
            otherInput.required = true;
            otherInput.placeholder = placeholderText;
        } else {
            otherInputContainer.style.display = "none";
            otherInput.required = false;
            otherInput.value = "";
            otherInput.placeholder = "";
        }
    }
    window.addEventListener('load', () => {
    const form = document.getElementById('gmfForm');
    const modalEl = document.getElementById('submissionModal');
    if (!form || !modalEl) return;

    const modal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
    const countdownEl = document.getElementById('submitCountdown');
    const bodyEl = document.getElementById('submissionModalBody');
    const homeUrl = "{% url 'client_home' %}";

    // helper to get CSRF token (from hidden input)
    const getCSRF = () => (form.querySelector('input[name="csrfmiddlewaretoken"]') || {}).value || '';

    form.addEventListener('submit', (e) => {
        e.preventDefault();

        // show modal immediately
        modal.show();

        // prevent double submit, but DO NOT disable form fields (we need their values)
        form.querySelectorAll('button[type="submit"], input[type="submit"]').forEach(b => b.disabled = true);

        // 5-second countdown
        let secs = 5;
        countdownEl.textContent = secs;
        const delay = new Promise(resolve => {
        const t = setInterval(() => {
            secs -= 1;
            countdownEl.textContent = secs;
            if (secs <= 0) { clearInterval(t); resolve(); }
        }, 1000);
        });

        // post using fetch (works with files via FormData)
        const post = fetch(form.action, {
        method: form.method || 'POST',
        body: new FormData(form),
        headers: {
            'X-CSRFToken': getCSRF(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
        }).then(resp => {
        if (!resp.ok) throw new Error('Submit failed');
        return resp.text();
        });

        // redirect after BOTH finish
        Promise.all([post, delay]).then(() => {
        window.location.assign(homeUrl);
        }).catch(() => {
        bodyEl.innerHTML = '<div class="text-danger">Submission failed. Please check required fields and try again.</div>';
        form.querySelectorAll('button[type="submit"], input[type="submit"]').forEach(b => b.disabled = false);
        });
    });
    }); 




    (function () {
    const el = document.getElementById('date_graduated_goodmoral');
    if (!el) return;

    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    el.max = `${yyyy}-${mm}-${dd}`;
    })();

    function toggleStatusFields() {
        const graduated = document.getElementById('status_graduated').checked;
        const former = document.getElementById('status_former').checked;
        const current = document.getElementById('status_current').checked;

        const dateGraduated = document.getElementById('date_graduated_goodmoral');
        const inclusiveYears = document.getElementById('stay_goodmoral');
        const dateAdmission = document.getElementById('admission_date_goodmoral');

        // Show/hide fields
        document.getElementById('graduated_date_field').style.display = graduated ? 'block' : 'none';
        document.getElementById('inclusive_years_field').style.display = former ? 'block' : 'none';
        document.getElementById('admission_date_field').style.display = current ? 'block' : 'none';

        // Dynamically set 'required'
        dateGraduated.required = graduated;
        inclusiveYears.required = former;
        dateAdmission.required = current;
    }

</script>

</body>
</html>