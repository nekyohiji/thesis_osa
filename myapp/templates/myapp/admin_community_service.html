{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSA - Community Service</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'myapp/css/admin_CS.css' %}">
</head>

<body>
  <button class="btn btn-primary toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

  {% include "partials/sidebar.html" %}
  {% include "partials/logout_modal.html" %}


<!-- //////////////////////////START HERE MAG CODE ///////////////////////////-->


 
<style>
  /* Highlight on focus */
  .input-group-sm .form-control:focus {
    border: 2px solid #440207;
    box-shadow: 0 0 0 0.15rem rgba(68, 2, 7, 0.1); /* soft glow */
  }

  .input-group-sm .form-control:hover {
    border: 1px solid #440207;
  }

  .input-group-sm:focus-within .input-group-text {
    background-color: #f8f0f0;
    border-color: #440207;
    color: #440207;
  }

  .btn.text-light {
    background-color: #440207 !important;
    padding: 10px;
    transition: all 0.3s ease;
  }

  .btn.text-light:hover {
    background-color: #5e0000 !important; 
  }

  .form-control {
    border-radius: 6px; /* optional: smoother edges */
    box-shadow: none;  /* remove Bootstrap default glow */
  }

  .form-control:focus {
    border: 1px solid #440207 !important;  /* darker border on focus */
    box-shadow: 0 0 4px rgba(68, 2, 7, 0.3); /* subtle glow */
  }




</style>

<!-- Main Content Area -->
<div class="main-content" style="margin-left: 250px; min-height: 100vh; background-color: #f8f9fa;">

  <!-- Dashboard Header -->
  <div class="container-fluid py-4 px-4">
    <div class="election-header text-white mt-4"
      style="background: linear-gradient(to right bottom, #000000, #440207, rgb(104, 3, 12));
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: 50px;
            min-height: 100px;
            border-radius: 20px;
            margin-bottom: 1px;
            margin-top: 1px;">
      <h2 class="fw-bold mb-0">
        <i class="bi bi-people-fill me-2"></i>
        Community Service Dashboard
      </h2>
      <p class="mb-0">Monitor, manage, and update student community service records</p>
    </div>
  </div>
  {% if messages %}
    <div class="container-fluid px-4">
      <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show mb-2 text-center shadow-sm">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}



  
  <div class="container-fluid px-4">
    <a href="{% url 'admin_community_service' %}" class="btn btn-secondary" style=" text-align: center;
          background-color: #f0f0f0;
          color: #333;
          font-weight: 500;
          border: 1px solid #ccc;
          border-radius: 5px;
          padding: 10px 15px;
          transition: all 0.3s ease;"
          onmouseover="this.style.backgroundColor='#ccccccff'; this.style.borderColor='#ccc';">
        <i class="bi bi-clipboard-check-fill me-2"></i> Community Service Requests
    </a>

    <a href="{% url 'admin_add_faculty' %}" class="btn btn-secondary" style=" text-align: center;
          background-color: #f0f0f0;
          color: #333;
          font-weight: 500;
          border: 1px solid #ccc;
          border-radius: 5px;
          padding: 10px 15px;
          transition: all 0.3s ease;"
          onmouseover="this.style.backgroundColor='#ccccccff'; this.style.borderColor='#ccc';">
        <i class="bi bi-people-fill me-2"></i> Community Service Facilitators
    </a>

    <hr>

    <div class="bg-white p-2 rounded shadow-sm border"> 
      <!-- Community Service Request Section -->
      <div class="container-fluid pt-4 pb-5">
        <div class="bg-white p-4 rounded shadow-sm border">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <h5 class="fw-bold mb-1">
                <i class="bi bi-bar-chart-line-fill me-2" style="color: #440207;"></i>
                Community Service Requests
              </h5>
              <small class="text-muted">Handle service requests, monitor progress, and maintain records.</small>
            </div>
            <button class="btn text-light" style="background-color: #440207; padding: 10px; font-size: 17px;"
              data-bs-toggle="modal" data-bs-target="#csCreateAdjustModal"><i class="bi bi-plus-circle-fill me-2"></i>
              Create Community Service
            </button>
          </div>
          <hr class="border-dark">


          <!-- Search Bar -->
          <div class="d-flex justify-content-end mb-3">
            <div class="input-group input-group-sm" style="max-width: 400px;">
              <input id="communityservice_search" type="text" class="form-control" placeholder="Search student">
              <span class="input-group-text bg-white border"><i class="bi bi-search text-muted"></i></span>
            </div>
          </div>

          <!-- Table of Community Service Requests -->
          <div class="card shadow-sm border">
            <div class="card-header text-white" style="background-color: #440207;">
              <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Community Service Record</h6>
            </div>
            <div class="card-body table-responsive p-0" style="max-height: calc(49px * 10); overflow-y: auto;">
              <table class="table table-hover table-bordered align-middle text-center mb-0">
                <thead class="table-secondary sticky-top border">
                  <tr>
                    <th>ID Number</th>
                    <th>Name</th>
                    <th>Program</th>
                    <th>Required Hours</th>
                    <th>Rendered Hours</th>
                    <th> Remaining Hours </th>
                    <th>Status</th>
                    <th>Date Time</th>
                    <th> Details </th>
                  </tr>
                </thead>
                <tbody>
                  {% if cases %}
                    {% for case in cases %}
                      <tr>
                        <td>{{ case.student_id }}</td>
                        <td>
                          {{ case.last_name }}, {{ case.first_name }}
                          {% if case.middle_initial %} {{ case.middle_initial }}.{% endif %}
                          {% if case.extension_name %} {{ case.extension_name }}{% endif %}
                        </td>
                        <td>{{ case.program_course }}</td>
                        <td>{{ case.total_required_hours }}h</td>
                        <td>{{ case.hours_completed }}h</td>
                        <td>{{ case.remaining_hours }}h</td>
                        <td>
                          {% if case.is_closed %}
                            <span class="badge bg-secondary">Completed</span>
                          {% else %}
                            <span class="badge bg-success">Ongoing</span>
                          {% endif %}
                        </td>
                        <td>{{ case.updated_at|date:"M d, Y H:i" }}</td>
                        <td>
                          <a class="btn btn-sm " style="color: #440207; border-color: #440207;"
                          onmouseover="this.style.backgroundColor='#440207'; this.style.color='#fff';"
                          onmouseout="this.style.backgroundColor=''; this.style.color='#440207';"
                            href="{% url 'admin_view_community_service' case.id %}">
                            View More
                          </a>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="9" class="text-center text-muted">No community service cases found.</td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- End white content box -->
  </div> <!-- End container -->
</div> <!-- End main-content -->



<!-- Create  Community Service Modal -->
<div class="modal fade" id="csCreateAdjustModal" tabindex="-1" aria-labelledby="csModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border">
      <div class="modal-header">
        <h5 class="modal-title fw-semibold" id="csModalLabel"> <i class="bi bi-plus-circle-fill me-2"></i>Create Community Service</h5>
      </div>

      <form method="post" action="{% url 'cs_create_or_adjust' %}{% if q %}?q={{ q|urlencode }}{% endif %}">
        {% csrf_token %}
        <div class="modal-body">
          {% if cs_form.non_field_errors %}
            <div class="alert alert-danger">{{ cs_form.non_field_errors }}</div>
          {% endif %}

          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Last Name:</label>
              <input name="{{ cs_form.last_name.name }}" type="text"
                     value="{{ cs_form.last_name.value|default_if_none:'' }}"
                     minlength="1" maxlength="50" placeholder="Enter last name"
                     class="form-control {% if cs_form.last_name.errors %}is-invalid{% endif %}" required
                     inputmode="text" title="Letters from any language with spaces and internal hyphen/apostrophe. No digits or symbols." oninput="this.value=this.value.normalize('NFC').replace(/[^\p{L}\p{M} \u2010\-'\u2019]/gu,'').replace(/([\-'\u2010\u2019])\1+/gu,'$1').replace(/ {2,}/g,' ').replace(/^[ '\-\u2010\u2019]+|[ '\-\u2010\u2019]+$/gu,'')">
              {% for err in cs_form.last_name.errors %}<div class="invalid-feedback">{{ err }}</div>{% endfor %}
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">First Name:</label>
              <input name="{{ cs_form.first_name.name }}" type="text"
                     value="{{ cs_form.first_name.value|default_if_none:'' }}"
                     minlength="1" maxlength="50" placeholder="Enter first name"
                     class="form-control {% if cs_form.first_name.errors %}is-invalid{% endif %}" required
                     inputmode="text" title="Letters from any language with spaces and internal hyphen/apostrophe. No digits or symbols." oninput="this.value=this.value.normalize('NFC').replace(/[^\p{L}\p{M} \u2010\-'\u2019]/gu,'').replace(/([\-'\u2010\u2019])\1+/gu,'$1').replace(/ {2,}/g,' ').replace(/^[ '\-\u2010\u2019]+|[ '\-\u2010\u2019]+$/gu,'')">
              {% for err in cs_form.first_name.errors %}<div class="invalid-feedback">{{ err }}</div>{% endfor %}
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">Middle Initial (optional):</label>
              <input name="{{ cs_form.middle_initial.name }}" type="text"
                     value="{{ cs_form.middle_initial.value|default_if_none:'' }}"
                     maxlength="5" placeholder="M."
                     class="form-control {% if cs_form.middle_initial.errors %}is-invalid{% endif %}">
              {% for err in cs_form.middle_initial.errors %}<div class="invalid-feedback">{{ err }}</div>{% endfor %}
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">Ext (optional):</label>
              <input name="{{ cs_form.extension_name.name }}" type="text"
                     value="{{ cs_form.extension_name.value|default_if_none:'' }}"
                     maxlength="10"  placeholder="Jr., Sr., III"
                     class="form-control {% if cs_form.extension_name.errors %}is-invalid{% endif %}">
              {% for err in cs_form.extension_name.errors %}<div class="invalid-feedback">{{ err }}</div>{% endfor %}
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">Student ID:</label>
              <input
                id="cs_student_id"
                name="{{ cs_form.student_id.name }}"
                type="text"
                value="{{ cs_form.student_id.value|default_if_none:'' }}"
                placeholder="TUPC-XX-XXXX"
                maxlength="16"
                autocomplete="off"
                spellcheck="false"
                inputmode="text"
                pattern="^TUPC-\d{2}-\d{4,8}$"
                class="form-control {% if cs_form.student_id.errors %}is-invalid{% endif %}"
                required
                aria-describedby="csStudentIdHelp"
                data-lookup-prefix="{% url 'get_student_by_id' tupc_id='TUPC-00-0000' %}|prefix"
              >
              {% for err in cs_form.student_id.errors %}<div class="invalid-feedback">{{ err }}</div>{% endfor %}
              <div id="csStudentIdHelp" class="form-text">Format: TUPC-##-####. Scan or type, then press Enter.</div>
              <div id="csLookupFeedback" class="small mt-1"></div>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold">Program:</label>
              <input name="{{ cs_form.program_course.name }}" type="text"
                     value="{{ cs_form.program_course.value|default_if_none:'' }}"
                     minlength="1" maxlength="100" placeholder="Enter program/course"
                     class="form-control {% if cs_form.program_course.errors %}is-invalid{% endif %}" required
                     inputmode="text" pattern="^[A-Za-z]+(?:-[A-Za-z]+)*$" title="Letters and hyphens only. No spaces; hyphens must be between letters." oninput="this.value=this.value.replace(/[^A-Za-z-]/g,'').replace(/-{2,}/g,'-').replace(/^-+|-+$/g,'')">
              {% for err in cs_form.program_course.errors %}<div class="invalid-feedback">{{ err }}</div>{% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">SDT Resolution No. (optional):</label>
              <input
                id="cs_sdt_resolution_no"
                name="sdt_resolution_no"
                type="text"
                class="form-control {% if cs_form and cs_form.sdt_resolution_no.errors %}is-invalid{% endif %}"
                placeholder="e.g., SDT-2025-00123"
                maxlength="64"
                autocomplete="off"
                value="{{ cs_form.sdt_resolution_no.value|default_if_none:'' }}"
              >
              {% if cs_form and cs_form.sdt_resolution_no.errors %}
                <div class="invalid-feedback">
                  {{ cs_form.sdt_resolution_no.errors|striptags }}
                </div>
              {% else %}
                <div class="form-text">Leave blank if not applicable.</div>
              {% endif %}
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold">Hours (Total Required):</label>
              <input name="{{ cs_form.hours.name }}" type="number"  max = "500"
                     value="{{ cs_form.hours.value|default_if_none:'' }}"
                     class="form-control {% if cs_form.hours.errors %}is-invalid{% endif %}" required>
              {% for err in cs_form.hours.errors %}<div class="invalid-feedback">{{ err }}</div>{% endfor %}
              <div class="form-text">Set the TOTAL required hours. Example: 10, 10.5, 30.</div>
            </div>
          </div>
        </div>

        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn text-light" style="background-color: #440207;">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if show_cs_modal %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var el = document.getElementById('csCreateAdjustModal');
    if (el) new bootstrap.Modal(el).show();
  });
</script>
{% endif %}




  <!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* Community Service — hard-trim to first TUPC + freeze to block trailing scanner chars */
(() => {
  const modal = document.getElementById('csCreateAdjustModal')
             || document.getElementById('createCommunityServiceModal');
  const form  = modal?.querySelector('form');
  if (!form) return;

  const sid = document.getElementById('cs_student_id');
  const fb  = document.getElementById('csLookupFeedback');

  const TUPC_FULL    = /^TUPC-\d{2}-\d{4,8}$/;
  const TUPC_CAPTURE = /(TUPC-\d{2}-\d{4,8})/i;

  let freezeUntil = 0;     // while frozen, ignore any inserted characters
  let lockedId    = '';    // the ID we keep during freeze

  const setFeedback = (kind, text) => {
    if (!fb) return;
    fb.className = 'small mt-1 ' + (kind==='ok' ? 'text-success' : kind==='warn' ? 'text-warning' : 'text-danger');
    fb.textContent = text || '';
  };

  const normalize = v => String(v||'')
    .toUpperCase()
    .replace(/[\r\n\t]/g, ' ')
    .replace(/[^A-Z0-9\- ]/g, '');

  const firstId = v => {
    const m = String(v||'').toUpperCase().match(TUPC_CAPTURE);
    return m ? m[1] : '';
  };

  function getLookupPrefix() {
    const raw = sid?.dataset?.lookupPrefix || "";
    const beforePipe = raw.split('|')[0];
    const cleaned = beforePipe.replace(/TUPC-00-0000\/?$/i, '');
    return cleaned.endsWith('/') ? cleaned : cleaned + '/';
  }

  function fillIfEmpty(name, val) {
    const el = form.querySelector(`[name="${name}"]`);
    if (el && !el.value) el.value = val || '';
  }

  async function doLookup() {
    const id = sid.value.toUpperCase().trim();
    if (!TUPC_FULL.test(id)) return;
    const url = getLookupPrefix() + encodeURIComponent(id) + '/';
    setFeedback('warn', 'Looking up student…');
    try {
      const res = await fetch(url, { headers: { 'Accept':'application/json' } });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      if (data && data.success) {
        fillIfEmpty('last_name',      data.last_name);
        fillIfEmpty('first_name',     data.first_name);
        fillIfEmpty('middle_initial', data.middle_initial);
        fillIfEmpty('extension_name', data.extension);
        fillIfEmpty('program_course', data.program);
        setFeedback('ok', 'Student found. Fields filled (you can still edit).');
      } else {
        setFeedback('err', 'Student not found.');
      }
    } catch (e) {
      console.error('[CS TUPC lookup]', e);
      setFeedback('err', 'Lookup failed. See console.');
    }
  }

  // Freeze helpers
  function startFreeze(id) {
    lockedId = id;
    freezeUntil = Date.now() + 500; // 0.5s is enough to swallow the scanner tail
  }
  function isFrozen() { return Date.now() < freezeUntil; }

  // Block inserts while frozen (but allow deletions/navigation)
  sid.addEventListener('beforeinput', (e) => {
    if (!isFrozen()) return;
    const type = e.inputType || '';
    if (!type.startsWith('delete') && type !== 'historyUndo' && type !== 'historyRedo') {
      e.preventDefault();
    }
  });

  // Keep value locked during freeze
  const enforceLock = () => {
    if (isFrozen()) {
      sid.value = lockedId;
      // keep caret at end
      try { sid.setSelectionRange(lockedId.length, lockedId.length); } catch {}
    }
  };

  // Snap + lookup
  const snapAndLookup = () => {
    sid.value = normalize(sid.value);
    const id = firstId(sid.value);
    if (id) {
      sid.value = id;      // hard-trim to the ID
      startFreeze(id);     // block any tail (e.g., "RIBERAL 4351")
      doLookup();
      enforceLock();
    }
  };

  // Prevent Enter from submitting modal
  form.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') e.preventDefault();
  });

  if (sid) {
    sid.addEventListener('input',  () => { snapAndLookup(); enforceLock(); });
    sid.addEventListener('blur',   () => { snapAndLookup(); enforceLock(); });
    sid.addEventListener('change', () => { snapAndLookup(); enforceLock(); });
    sid.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); snapAndLookup(); enforceLock(); }
    });
    sid.addEventListener('paste',  () => setTimeout(() => { snapAndLookup(); enforceLock(); }, 0));
  }

  // Focus on open; reset on close
  modal?.addEventListener('shown.bs.modal', () => sid?.focus());
  modal?.addEventListener('hidden.bs.modal', () => {
    form.reset();
    form.querySelectorAll('input,select,textarea').forEach(el => el.style.borderColor = '');
    setFeedback('ok', '');
    lockedId = ''; freezeUntil = 0;
  });
})();
</script>



<script>

/* Sidebar Functions*/
        // Toggle Sidebar
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('show');
      }

      // Handle Dropdowns Uniformly
      function handleDropdown(menuId) {
        const clickedIcon = document.getElementById(`icon-${menuId}`);
        const clickedMenu = document.getElementById(menuId);
        const clickedCollapse = bootstrap.Collapse.getOrCreateInstance(clickedMenu);

        // Toggle clicked menu
        if (clickedMenu.classList.contains('show')) {
          clickedCollapse.hide();
          clickedIcon.classList.remove('rotate');
        } else {
          clickedCollapse.show();
          clickedIcon.classList.add('rotate');
        }

        // Hide other open menus
        const allDropdowns = ['violationMenu', 'documentsMenu', 'postingsMenu', 'studentRecordMenu'];
        allDropdowns.forEach(id => {
          if (id !== menuId) {
            const menu = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            const collapse = bootstrap.Collapse.getInstance(menu);
            if (collapse) collapse.hide();
            if (icon) icon.classList.remove('rotate');
          }
        });
      }

      // Highlight Active Link
      document.addEventListener('DOMContentLoaded', function () {
        const currentUrl = window.location.href;
        const navLinks = document.querySelectorAll('.nav-link');

        navLinks.forEach(link => {
          if (link.href && currentUrl.includes(link.href)) {
            link.classList.add('active');
          }
        });
      });
///////////////////////////// START HERE MAG ADD

  document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('communityservice_search');
    if (!input) return;

    // keep the input in sync with the current ?q
    const params = new URLSearchParams(window.location.search);
    input.value = params.get('q') || '';

    // submit on Enter
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const url = new URL(window.location.href);
        const q = input.value.trim();
        if (q) url.searchParams.set('q', q); else url.searchParams.delete('q');
        window.location.href = url.toString();
      }
    });

    // clicking the search icon also triggers search
    const icon = input.parentElement?.querySelector('.input-group-text');
    if (icon) {
      icon.style.cursor = 'pointer';
      icon.addEventListener('click', function () {
        const url = new URL(window.location.href);
        const q = input.value.trim();
        if (q) url.searchParams.set('q', q); else url.searchParams.delete('q');
        window.location.href = url.toString();
      });
    }
  });
</script>
<script>
  window.addEventListener('pageshow', function (e) {
    if (e.persisted) location.reload();
  });
</script>




</body>
</html>
