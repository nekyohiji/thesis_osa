{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>USG Ballot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background:#111; color:#eee; }
    .container-narrow{max-width:980px; margin:90px auto 40px;}
    .stepper{display:flex; gap:10px; margin-bottom:20px;}
    .step{flex:1; text-align:center; padding:10px; border-radius:8px; background:#1d1d1d; color:#bbb; font-weight:600}
    .step.active{background:#7b0012; color:#fff;}
    .panel{background:#181818; border:1px solid #2a2a2a; border-radius:16px; padding:18px;}
    .position-box{background:#141414; border:1px solid #2a2a2a; border-radius:12px; padding:14px; margin-bottom:14px;}
    .position-box h3{font-size:1.1rem; margin-bottom:10px;}
    .styled-select{width:100%; padding:10px; border-radius:8px; border:1px solid #444; background:#0f0f0f; color:#eee;}
    .preview{margin-top:10px; display:flex; gap:12px; align-items:center; background:#0f0f0f; border:1px dashed #333; border-radius:10px; padding:10px;}
    .preview img{width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #333;}
    .controls{display:flex; justify-content:space-between; gap:10px; margin-top:16px;}
    .back-btn, .next-btn{padding:10px 16px; border-radius:10px; border:none;}
    .back-btn{background:#343a40; color:#fff;}
    .next-btn{background:#7b0012; color:#fff;}
    .next-btn:disabled{opacity:.6; cursor:not-allowed;}
    .empty-hint{padding:16px; border:1px dashed #555; border-radius:10px; color:#bbb; text-align:center;}
    pre.review{background:#0f0f0f; color:#d7d7d7; border-radius:12px; border:1px solid #2b2b2b; padding:14px; min-height:160px; white-space:pre-wrap;}
    .submit-container{display:flex; gap:10px; align-items:center; margin-top:12px;}
    .email-input{flex:1; padding:10px; border-radius:8px; border:1px solid #444; background:#0f0f0f; color:#eee;}
    .submit-btn{padding:10px 16px; border-radius:10px; border:none; background:#0a7a19; color:#fff;}
    .icon-tag{margin-right:8px; color:#aaa;}


      .highlight {
    background: #44444444; /* your accent color */
    color: #d7d7d7;
    padding: 4px 8px;
    border-radius: 8px;
  }

  .preview img {
    width: 140px;  /* increase size */
    height: 140px; /* increase size */
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #333;
  }

  /* Success modal text */
.modal-header.bg-success + .modal-body {
  color: #0f0f0f; /* light green for success */
}

/* Warning modal text */
.modal-header.bg-warning + .modal-body {
  color:#0f0f0f; /* dark yellow for warning */
}

/* Danger modal text */
.modal-header.bg-danger + .modal-body {
  color: #0f0f0f; /* light red for danger */
}

/* Info modal text */
.modal-header.bg-primary + .modal-body {
  color: #0f0f0f; /* light blue for info */
}


  </style>
</head>
<body>

<div class="container-narrow">
  <h2 class="mb-3"><strong>University Student Government Ballot</strong></h2>
  <div class="text-light mb-3">
   <strong> Election:</strong> <span class="highlight"> {{ election.name }} ( {{ election.academic_year }}) </span>  •<strong> Voter:</strong> <span class="highlight">{{ voter_sid }} </span> •<strong> Org:</strong> <span class="highlight"> {{ voter_org }} </span>
  </div><br>

  <!-- Stepper -->
  <div class="stepper">
    <div class="step active" id="stepIndicator1">1. President & VP</div>
    <div class="step" id="stepIndicator2">2. Senators (9)</div>
    <div class="step" id="stepIndicator3">3. Governor</div>
    <div class="step" id="stepIndicator4">4. Review & Submit</div>
  </div>

  <!-- Content -->
  <div class="panel">
    <div class="step-content active" id="step1">
      <div id="panel1"></div>
    </div>
    <div class="step-content" id="step2">
      <div id="panel2"></div>
    </div>
    <div class="step-content" id="step3">
      <div id="panel3"></div>
    </div>
    <div class="step-content" id="step4">
      <pre class="review" id="review"></pre>
      <!-- email + submit injected here -->
    </div>

    <div class="controls">
      <button class="back-btn" onclick="prevStep()" style="display:none">Back</button>
      <button class="next-btn" onclick="nextStep()" disabled>Next</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="msgModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div id="msgModalHeader" class="modal-header"><h5 class="modal-title" id="msgModalLabel">Notice</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div id="msgModalBody" class="modal-body">...</div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Okay</button></div>
  </div></div>
</div>

<!-- Final Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Vote Submitted</h5>
      </div>
      <div class="modal-body">
        <p>Your vote has been casted successfully.</p>
        <p>Redirecting back to home in <span id="redirectSeconds">5</span> seconds…</p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function getCookie(name){
  const v = `; ${document.cookie}`.split(`; ${name}=`);
  if (v.length === 2) return v.pop().split(';').shift();
  return null;
}
const csrftoken = getCookie('csrftoken');

let ballotData = null;
let seats = { senator: 9, governor: 1 };
const picks = { president:null, vice_president:null, senators:[], governor:null };
let currentStep = 1;

// ---- modal helpers ----
const msgModal = new bootstrap.Modal(document.getElementById('msgModal'));
const msgHeader = document.getElementById('msgModalHeader');
const msgTitle  = document.getElementById('msgModalLabel');
const msgBody   = document.getElementById('msgModalBody');
function showMsg(type, title, body){
  const bg = {success:'bg-success text-dark', warning:'bg-warning', danger:'bg-danger text-dark', info:'bg-primary text-dark'}[type] || 'bg-primary text-dark';
  msgHeader.className = 'modal-header ' + bg;
  msgTitle.textContent = title;
  msgBody.textContent = body;
  msgModal.show();
}

// ---- utils ----
function el(id){ return document.getElementById(id); }
function isEmail(s){
  const regex = /^[^\s@]+@(gmail\.com|gsfe\.tupcavite\.edu\.ph)$/i;
  return regex.test(s);
}

function showStep(n){
  document.querySelectorAll('.step-content').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.step').forEach(x => x.classList.remove('active'));
  el(`step${n}`).classList.add('active');
  el(`stepIndicator${n}`).classList.add('active');
  currentStep = n;
  const backBtn = document.querySelector('.back-btn');
  const nextBtn = document.querySelector('.next-btn');
  if (backBtn) backBtn.style.display = (n===1?'none':'inline-block');
  if (nextBtn) nextBtn.style.display = (n===4?'none':'inline-block');
  validateStepEnableNext();
}

function validateStepEnableNext(){
  const nextBtn = document.querySelector('.next-btn');
  if(!nextBtn) return;

  if(currentStep===1){
    const p = document.querySelector('#select-president');
    const v = document.querySelector('#select-vice');
    nextBtn.disabled = (!p || !v || p.value==="" || v.value==="");
    return;
  }
  if(currentStep===2){
    let ok = true;
    for(let i=0;i<seats.senator;i++){
      const s = document.querySelector(`#select-senator-${i}`);
      if(!s || s.value===""){ ok=false; break; }
    }
    nextBtn.disabled = !ok;
    return;
  }
  if(currentStep===3){
    const govKey = Object.keys(ballotData.ballot).find(k => k.endsWith(' Governor'));
    const list = ballotData.ballot[govKey] || [];
    if(list.length===0){ nextBtn.disabled=false; return; }
    const g = document.querySelector('#select-governor');
    nextBtn.disabled = (!g || g.value==="");
    return;
  }
}

function uniqueDisable(selects){
  // filter out nulls if step 2 isn't rendered yet
  const list = Array.from(selects || []).filter(Boolean);
  const chosen = new Set(list.map(s => s.value).filter(v => v && v!=='ABSTAIN'));
  list.forEach(s => {
    const cur = s.value;
    s.querySelectorAll('option').forEach(opt => {
      if(opt.value && opt.value!=='ABSTAIN'){
        opt.disabled = (opt.value !== cur && chosen.has(opt.value));
      } else {
        opt.disabled = false;
      }
    });
  });
}

function buildDropdownBox(label, list, selectId, onChange){
  const wrap = document.createElement('div');
  wrap.className = 'position-box';
  wrap.innerHTML = `
    <h3><i class="bi bi-person-square icon-tag"></i>${label}</h3>
    <select id="${selectId}" class="styled-select text-center">
      <option value="">-- Select Candidate --</option>
      ${list.map(c => `<option value="${c.id}">${c.name}${c.party ? ' ('+c.party+')':''}</option>`).join('')}
      <option value="ABSTAIN">Abstain</option>
    </select>
    <div class="preview justify-content-center" style="display:none;">
      <img src="" alt="">
      <div class="preview-info"></div>
    </div>`;
  const select = wrap.querySelector('select');
  const preview= wrap.querySelector('.preview');
  const img    = preview.querySelector('img');
  const info   = preview.querySelector('.preview-info');

  select.addEventListener('change', () => {
    const val = select.value;
    if(val && val!=='ABSTAIN'){
      const c = list.find(x => String(x.id)===val);
      if(c){
        preview.style.display='flex';
        img.src = c.image||'';
        info.innerHTML = `<strong>${c.name}</strong><br>${c.section}${c.party?`<br>${c.party}`:''}`;
      }
    } else if(val==='ABSTAIN'){
      preview.style.display='flex'; img.src=''; info.innerHTML='<em>Abstained</em>';
    } else {
      preview.style.display='none';
    }
    onChange(val);
  });
  return wrap;
}

function injectStraightPartySelector(containerEl){
  const parties = ballotData.parties || [];
  if(!parties.length) return;
  const box = document.createElement('div');
  box.className = 'position-box';
  box.innerHTML = `
    <h3><i class="bi bi-people-fill icon-tag"></i>Straight Party Vote</h3>
    <div class="d-flex gap-2 align-items-center">
      <select id="straight-party" class="styled-select">
        <option value="">-- Select a Party --</option>
        ${parties.map(p => `<option value="${p}">${p}</option>`).join('')}
      </select>
      <button class="btn btn-sm btn-dark" id="apply-party">Apply</button>
      <button class="btn btn-sm btn-outline-secondary" id="clear-party">Clear</button>
    </div>
    <div class="text-light mt-1 " style="font-size:15px;">
      Auto-fills President, Vice President, up to ${seats.senator} Senators, and your org’s Governor from that party. Missing positions become Abstain.
    </div>`;
  containerEl.prepend(box);

  box.querySelector('#apply-party').addEventListener('click', () => {
    const party = box.querySelector('#straight-party').value;
    if(!party) return;
    applyStraightParty(party);
    // optional UX: jump to Governor after applying
    renderStep2(); renderStep3(); showStep(3);
  });
  box.querySelector('#clear-party').addEventListener('click', clearAllSelections);
}

function setSelectValue(sel, value){
  if(!sel) return;
  sel.value = value;
  sel.dispatchEvent(new Event('change'));
}

function applyStraightParty(party){
  // ensure array sized
  if (!Array.isArray(picks.senators) || picks.senators.length !== seats.senator) {
    picks.senators = Array(seats.senator).fill(null);
  }

  // President & VP
  const pSel = document.querySelector('#select-president');
  const vSel = document.querySelector('#select-vice');
  const pList = ballotData.ballot['President'] || [];
  const vList = ballotData.ballot['Vice President'] || [];
  const pPick = pList.find(c => c.party===party);
  const vPick = vList.find(c => c.party===party);
  setSelectValue(pSel, pPick ? String(pPick.id) : 'ABSTAIN'); picks.president = pPick ? pPick.id : null;
  setSelectValue(vSel, vPick ? String(vPick.id) : 'ABSTAIN'); picks.vice_president = vPick ? vPick.id : null;

  // Senators (unique up to seats)
  const sList = (ballotData.ballot['Senator'] || []).filter(c => c.party===party);
  const selects = [];
  for(let i=0;i<seats.senator;i++){
    const sel = document.querySelector(`#select-senator-${i}`);
    if (sel) selects.push(sel);
  }
  const chosen = new Set();
  for(let i=0;i<seats.senator;i++){
    const sel = document.querySelector(`#select-senator-${i}`);
    const cand = sList.find(c => !chosen.has(c.id));
    if(cand){ chosen.add(cand.id); if(sel) setSelectValue(sel, String(cand.id)); picks.senators[i]=cand.id; }
    else { if(sel) setSelectValue(sel, 'ABSTAIN'); picks.senators[i]=null; }
  }
  if (selects.length) uniqueDisable(selects);

  // Governor (org-filtered)
  const govKey = Object.keys(ballotData.ballot).find(k => k.endsWith(' Governor'));
  const gList = (ballotData.ballot[govKey] || []).filter(c => c.party===party);
  const gSel  = document.querySelector('#select-governor');
  if(gSel){
    const gPick = gList[0];
    setSelectValue(gSel, gPick ? String(gPick.id) : 'ABSTAIN');
  }
  picks.governor = (gList[0]?.id ?? null);

  validateStepEnableNext();
}

function clearAllSelections(){
  // Step 1
  setSelectValue(document.querySelector('#select-president'), '');
  setSelectValue(document.querySelector('#select-vice'), '');
  picks.president = null; picks.vice_president = null;

  // Step 2
  for(let i=0;i<seats.senator;i++){
    setSelectValue(document.querySelector(`#select-senator-${i}`), '');
  }
  picks.senators = Array(seats.senator).fill(null);
  uniqueDisable(document.querySelectorAll('[id^="select-senator-"]'));

  // Step 3
  const gSel = document.querySelector('#select-governor');
  if(gSel){ setSelectValue(gSel, ''); }
  picks.governor = null;

  validateStepEnableNext();
}

// ---- renderers ----
function renderStep1(){
  const panel = el('panel1'); panel.innerHTML = '';
  injectStraightPartySelector(panel);

  const pres = ballotData.ballot['President'] || [];
  const vps  = ballotData.ballot['Vice President'] || [];

  const pBox = buildDropdownBox('President', pres, 'select-president', val=>{
    picks.president = (val==='ABSTAIN'? null : (val? parseInt(val): null));
    validateStepEnableNext();
  });
  const vBox = buildDropdownBox('Vice President', vps, 'select-vice', val=>{
    picks.vice_president = (val==='ABSTAIN'? null : (val? parseInt(val): null));
    validateStepEnableNext();
  });
  panel.appendChild(pBox);
  panel.appendChild(vBox);

  // prefill if returning/back
  const pSel = pBox.querySelector('select');
  const vSel = vBox.querySelector('select');
  if (picks.president !== null) setSelectValue(pSel, String(picks.president)); else if (pSel.value==='') {}
  if (picks.vice_president !== null) setSelectValue(vSel, String(picks.vice_president));
}

function renderStep2(){
  const panel = el('panel2'); panel.innerHTML = '';
  const senators = ballotData.ballot['Senator'] || [];
  if (!Array.isArray(picks.senators) || picks.senators.length !== seats.senator)
    picks.senators = Array(seats.senator).fill(null);

  const selects = [];
  for(let i=0;i<seats.senator;i++){
    const selId = `select-senator-${i}`;
    const box = buildDropdownBox(`Senator #${i+1}`, senators, selId, val=>{
      picks.senators[i] = (val==='ABSTAIN'? null : (val? parseInt(val): null));
      uniqueDisable(selects);
      validateStepEnableNext();
    });
    panel.appendChild(box);
    const sel = box.querySelector('select');
    selects.push(sel);

    // prefill (from straight party or back nav)
    if (picks.senators[i] !== null) {
      setSelectValue(sel, String(picks.senators[i]));
    } else {
      // leave the default placeholder "-- Select Candidate --"
      setSelectValue(sel, '');
    }
  }
  uniqueDisable(selects);
}

function renderStep3(){
  const panel = el('panel3'); panel.innerHTML = '';
  const govKey = Object.keys(ballotData.ballot).find(k => k.endsWith(' Governor'));
  const govs = ballotData.ballot[govKey] || [];
  if(govs.length===0){
    panel.innerHTML = `<div class="empty-hint">Your organization has no governor candidates.</div>`;
    picks.governor = null; return;
  }
  const box = buildDropdownBox(govKey, govs, 'select-governor', val=>{
    picks.governor = (val==='ABSTAIN'? null : (val? parseInt(val): null));
    validateStepEnableNext();
  });
  panel.appendChild(box);

  // prefill
  const gSel = box.querySelector('select');
  if (picks.governor !== null) setSelectValue(gSel, String(picks.governor));
}

function nameById(arr, id){
  if(id===null) return 'Abstain';
  const c=(arr||[]).find(x=>x.id===id);
  return c? c.name : '(?)';
}

function renderReview(){
  const pre = el('review');
  const govKey = Object.keys(ballotData.ballot).find(k => k.endsWith(' Governor'));

  const lines = [];
  lines.push(`PRESIDENT: ${nameById(ballotData.ballot['President'], picks.president)}`);
  lines.push(`VICE PRESIDENT: ${nameById(ballotData.ballot['Vice President'], picks.vice_president)}`);
  picks.senators.forEach((sid, i)=> lines.push(`SENATOR #${i+1}: ${nameById(ballotData.ballot['Senator'], sid)}`));
  const hasGov = (ballotData.ballot[govKey]||[]).length>0;
  lines.push(`${govKey.toUpperCase()}: ${hasGov? nameById(ballotData.ballot[govKey], picks.governor) : '— (no candidates)'}`);
  lines.push('', 'Enter your email if you want a copy of your ballot (optional).');
  pre.textContent = lines.join('\n');

  if(!document.getElementById('emailBox')){
    const box=document.createElement('div'); 
    box.className='submit-container';
    box.innerHTML=`
      <input id="emailBox" type="email" class="email-input" placeholder="your.email@gmail.com" required>
      <small style="color:white;">Email is required.</small>
      <button class="submit-btn" id="submitBtn" disabled>
        <i class="bi bi-check-circle-fill"></i> Submit Vote
      </button>`;
    el('step4').appendChild(box);

    const emailInput = document.getElementById('emailBox');
    const submitBtn  = document.getElementById('submitBtn');

    emailInput.addEventListener('input', () => {
      submitBtn.disabled = !isEmail(emailInput.value.trim());
    });

    submitBtn.addEventListener('click', submitVote);
  }
}

// ---- nav ----
function nextStep(){
  if(currentStep===1) renderStep2();
  if(currentStep===2) renderStep3();
  if(currentStep===3) renderReview();
  if(currentStep<4) showStep(currentStep+1);
}
function prevStep(){ if(currentStep>1) showStep(currentStep-1); }

// ---- load ballot ----
async function loadBallot(){
  try{
    const res = await fetch('/api/ballot/', { credentials: 'same-origin' });
    const data = await res.json();

    if (res.status === 401) {
      showMsg('warning','Login Required','Please log in again to access the ballot.');
      setTimeout(()=>{ window.location.href = "{% url 'client_election' %}"; }, 2000);
      return;
    }
    if (res.status === 400) {
      showMsg('warning','Unavailable', data.message || 'No active election right now.');
      setTimeout(()=>{ window.location.href = "{% url 'client_election' %}"; }, 2500);
      return;
    }
    if(data.status!=='success'){
      showMsg('danger','Error','Unable to load ballot.');
      return;
    }

    ballotData = data;
    seats = data.seats || {senator:9, governor:1};

    renderStep1();
    validateStepEnableNext();
    showStep(1);
  }catch(err){
    console.error(err);
    showMsg('danger','Network','Please try again.');
  }
}

// ---- submit ----
async function submitVote(){
  const fd = new FormData();
  fd.append('president', picks.president===null? '': String(picks.president));
  fd.append('vice_president', picks.vice_president===null? '': String(picks.vice_president));
  fd.append('senators', JSON.stringify(picks.senators.map(x=>x===null? '': String(x))));
  fd.append('governor', picks.governor===null? '': String(picks.governor));

  const email = (document.getElementById('emailBox')?.value || '').trim();
  if(email){
    if (!isEmail(email)){
      showMsg('warning','Invalid Email','Please enter a valid email address or leave it blank.');
      return;
    }
    fd.append('email', email);
  }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true; const old = btn.innerText; btn.innerText = 'Submitting…';

  try{
    const res = await fetch('/api/submit_vote/', {
      method: 'POST',
      body: fd,
      headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest' },
      credentials: 'same-origin'
    });
    const data = await res.json();
    if(res.ok && data.status === 'success'){
      let seconds = Number(data.logout_after ?? 5);
      const successModal = new bootstrap.Modal(document.getElementById('successModal'));
      const secSpan = document.getElementById('redirectSeconds');
      secSpan.textContent = seconds;
      successModal.show();

      const timer = setInterval(()=>{
        seconds--;
        secSpan.textContent = seconds;
        if(seconds <= 0){
          clearInterval(timer);
          window.location.href = "{% url 'client_home' %}";
        }
      },1000);
      return;
    }
    showMsg('warning','Unable to Submit', data.message || 'Please try again.');
  }catch(err){
    console.error(err);
    showMsg('danger','Network Error','Please check your connection and try again.');
  }finally{
    btn.disabled = false; btn.innerText = old;
  }
}

window.addEventListener('load', loadBallot);
</script>

</body>
</html>
