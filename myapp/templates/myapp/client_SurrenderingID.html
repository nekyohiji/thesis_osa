surrendering id
{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
    <title>OSA - Surrendering of ID</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />  
    <!-- Google Fonts: Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'myapp/css/client_SurrenderingID.css' %}">
</head>

<body data-bs-spy="scroll" data-bs-target=".navbar" data-bs-offset="70" tabindex="0">

<!-- NAVIGATION BAR -->
<nav class="navbar navbar-expand-lg navbar-custom fixed-top">
    <div class="container-fluid">
        <a id="TUPC" class="navbar-brand" href="#home">
            <img src="{% static 'myapp/images/logo.png' %}" alt="TUP Logo" class="img-fluid me-2">
            <span class="d-none d-sm-inline"><b>Technological University of the Philippines - Cavite</b></span>
            <span class="d-inline d-sm-none"><b>TUPC</b></span>
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="{% url 'client_home' %}">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'client_home' %}#about">About</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'client_home' %}#services">Services</a></li>
                <li class="nav-item"><a class="nav-link nav-btn" href="{% url 'login' %}">Login</a></li>
            </ul>
        </div>
    </div>
</nav>
<br><br><br>
<!-- MAIN CONTAINER -->
<div class="container mt-3 mb-3">
  
    <h1 class="mb-3"><i class="bi bi-card-text"></i> <b>Surrendering of ID Form</b></h1>
    <hr>
    <h6 class="mb-3">Please fill in the required information below.</h6>
    <!-- Form -->
    <form id="surrender-form" method="post" action="{% url 'id_surrender_request' %}" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- STEP 1: Personal Information -->
        <div class="card mb-3 card-surrender-personal shadow-sm">
            <div class="card-body">
                <div class="section-title"><i class="bi bi-person-fill"></i> Personal Information</div>
                <hr>

                <div class="row">
                    <!-- First Name -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">First Name:</label>
                        <input type="text" class="form-control" id="fn_surrender" name="first_name" placeholder="Enter Your First Name" minlength="1" maxlength="50" required>
                    </div>
                    <!-- Middle Name -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Middle Name:</label>
                        <input type="text" class="form-control" id="mn_surrender" name="middle_name" placeholder="Enter Your Middle Name" maxlength="50">
                    </div>
                    <!-- Surname -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Surname:</label>
                        <input type="text" class="form-control" id="sn_surrender" name="surname" placeholder="Enter Your Surname" minlength="1" maxlength="50" required>
                    </div>
                </div>

            
                <!-- Question row -->
                  <div class="row mb-3">
                      <div class="col-md-12 d-flex align-items-center">
                          <label class="form-label fw-semibold me-3 mb-0">Do you have an extension name?</label>
                          <div class="form-check form-check-inline mb-0">
                              <input class="form-check-input" type="radio" name="hasExtension" id="extYes" value="yes">
                              <label class="form-check-label" for="extYes">Yes</label>
                          </div>
                          <div class="form-check form-check-inline mb-0">
                              <input class="form-check-input" type="radio" name="hasExtension" id="extNo" value="no" checked>
                              <label class="form-check-label" for="extNo">No</label>
                          </div>
                      </div>
                  </div>


                  <div class="row">
                    <!-- Extension -->
                    <div class="col-md-6 mb-3 d-none"  id="extensionCol" >
                        <label class="form-label fw-semibold">Extension (Jr., Sr.):</label>
                        <input type="text" class="form-control" id="ex_surrender" name="extension" placeholder="Enter Extension Name" maxlength="15">
                    </div>

                    <!-- Program -->
                    <div class="col-md-6 mb-3" id="programCol">
                        <label class="form-label fw-semibold">Program (Acronym Only):</label>
                        <input type="text" class="form-control" id="program_surrender" name="program" placeholder="BET-COET" minlength ="2" maxlength="10" required>
                    </div>
                

                    <!-- Email -->
                    <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">Email:</label>
                    <input type="email" class="form-control" id="email_surrender" name="contact_email" placeholder="you@gmail.com" required>
                    </div>
                </div>
            </div>
        </div>


        <!-- STEP 2: Academic Information -->
        <div class="card mb-3 card-surrender-academic shadow-sm">
            <div class="card-body">
                <div class="section-title"><i class="bi bi-book"></i> Academic Information</div>
                <hr>

                <!-- Reason to Surrender -->
              <div class="row"> 
                <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Reason to Surrender:</label>
                <select class="form-select" name="reason" id="reason_surrender" required>
                    <option value="">-- Select Reason --</option>
                    <option value="Dropped">Dropped</option>
                    <option value="Graduate">Graduate</option>
                    <option value="Transfer">Transfer</option>
                    <option value="Withdrawn">Withdrawn</option>
                    <option value="Claim of Credentials">Claim of Credentials</option>
                    <option value="Worn Out">Worn Out</option>
                </select>
                </div>
              </div>

                <!-- Student Number and Year Level -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Student Number:</label>
                        <input type="text" class="form-control" name="student_number" id="studentID_surrender" placeholder="TUPC-XX-XXXXXXXXXX" required pattern="^TUPC-\d{2}-\d{4,10}$" minlength="12" maxlength="18" title="Format: TUPC-XX-XXXX up to TUPC-XX-XXXXXXXXXX (last block 4â€“10 digits)"
>
                    </div>
                <!-- Year Level (corrected) -->
                <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Year Level:</label>
                <select class="form-select" name="year_level" id="yearlevel_surrender" required>
                    <option value="">-- Select Year Level --</option>
                    <option value="1st Year">1st Year</option>
                    <option value="2nd Year">2nd Year</option>
                    <option value="3rd Year">3rd Year</option>
                    <option value="4th Year">4th Year</option>
                    <option value="5th Year">5th Year</option>
                    <option value="Graduate">Graduate</option>
                </select>
                </div>
                </div>
                <!-- Inclusive Years of Stay -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Inclusive Years of Stay:</label>
                    <input type="text" class="form-control" name="inclusive_years" id="stay_surrender" placeholder="e.g., 2019-2023" required pattern="^\d{4}-\d{4}$" minlength="9" maxlength="9" >
                </div>
            </div>
        </div>

        <div class="card mb-3 card-surrender-upload shadow-sm">
          <div class="card-body">
            <div class="section-title"><i class="bi bi-upload"></i> Upload Documents</div>
            <hr>

            <div class="mb-3">
              <label class="form-label fw-semibold">Document Type:</label>
              <select class="form-select" id="doc_type" name="document_type" required>
                <option value="">-- Select Document Type --</option>
                <option value="id">School ID</option>
                <option value="affidavit">Affidavit of Loss</option>
              </select>
            </div>

            <!-- Hidden by default; shown after a selection -->
            <div class="mb-3 d-none" id="frontGroup">
              <label class="form-label" id="frontLabel">Upload ID (Front) / Affidavit First Page:</label>
              <input type="file" class="form-control" id="front_surrender" name="upload_id_front" accept=".jpg,.jpeg,.png,.pdf">
            </div>

            <div class="mb-3 d-none" id="backGroup">
              <label class="form-label" id="backLabel">Upload ID (Back) / Affidavit Second Page:</label>
              <input type="file" class="form-control" id="back_surrender" name="upload_id_back" accept=".jpg,.jpeg,.png,.pdf">
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="text-end mb-3">
            <button id="submitBtn" type="submit" class="btn btn-success btn-lg text-light" style="background-color: #440207; border-color: #440207; font-size: 17px"
                  onmouseover="this.style.backgroundColor='#5e0000';"
                  onmouseout="this.style.backgroundColor='#440207';" disabled>
                <i class="bi bi-send-fill"></i> Submit Request
            </button>
        </div>
    </form>
</div>

<!-- Submission Modal -->
<div class="modal fade" id="submissionModal" tabindex="-1"
     aria-labelledby="submissionModalLabel" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="submissionModalLabel">Request Submitted</h5>
      </div>
      <div class="modal-body" id="submissionModalBody">
        Your request is being submitted and is subject to approval. Youâ€™ll receive an email update. Redirecting to home in ...
        <span id="submitCountdown">5</span> secondsâ€¦
      </div>
      <div class="modal-footer">
        <a id="modalHomeBtn" class="btn text-light" style="background-color: #440207; border-color: #440207;"
                  onmouseover="this.style.backgroundColor='#5e0000';"
                  onmouseout="this.style.backgroundColor='#440207';" href="{% url 'client_home' %}">Back to Home now</a>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>



<script>

document.addEventListener("DOMContentLoaded", function () {
    const extYes = document.getElementById("extYes");
    const extNo = document.getElementById("extNo");
    const extensionCol = document.getElementById("extensionCol");
    const extensionInput = document.getElementById("ex_surrender");

    function toggleExtension() {
        if (extYes.checked) {
            extensionCol.classList.remove("d-none");  // Show extension
            extensionInput.focus();
        } else {
            extensionCol.classList.add("d-none");     // Hide extension
            extensionInput.value = "";
        }
    }

    toggleExtension();
    extYes.addEventListener("change", toggleExtension);
    extNo.addEventListener("change", toggleExtension);
});


(function () {
  // ----- CONFIG -----
  const FIELD_IDS = [
    'doc_type',
    'fn_surrender','sn_surrender','program_surrender','email_surrender',
    'reason_surrender','studentID_surrender','yearlevel_surrender',
    'stay_surrender','front_surrender','back_surrender'
  ];
  const MB = 1024 * 1024, LIMIT_MB = 10, ALLOWED_EXT = ['jpg','jpeg','png','pdf'];

  // ----- ELEMENTS -----
  const form = document.getElementById('surrender-form') || document.querySelector('form');
  const submitBtn = document.getElementById('submitBtn') || (form && form.querySelector('button[type="submit"]'));
  const alertBox = document.getElementById('formAlert');

  const modalEl = document.getElementById('submissionModal');
  const hasBootstrap = typeof bootstrap !== 'undefined' && modalEl;
  const modal = hasBootstrap ? new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false }) : null;
  const titleEl = modalEl ? document.getElementById('submissionModalLabel') : null;
  const bodyEl  = modalEl ? document.getElementById('submissionModalBody') : null;
  const footer  = modalEl ? modalEl.querySelector('.modal-footer') : null;

  const docTypeSel = document.getElementById('doc_type');

  if (!form || !submitBtn) return;

  // ----- HELPERS -----
  function elById(id) { return document.getElementById(id); }

  function ensureFeedback(el) {
    if (!el.nextElementSibling || !el.nextElementSibling.classList.contains('invalid-feedback')) {
      const fb = document.createElement('div');
      fb.className = 'invalid-feedback';
      fb.textContent = 'This field is required.';
      el.after(fb);
    }
    return el.nextElementSibling;
  }

  function setInvalid(el, msg = 'This field is required.') {
    el.classList.add('is-invalid');
    el.classList.remove('is-valid');
    el.setCustomValidity(msg);
    ensureFeedback(el).textContent = msg;
  }

  function setValid(el) {
    el.classList.remove('is-invalid');
    el.classList.add('is-valid');
    el.setCustomValidity('');
  }

  function fileOk(input) {
    const f = input.files && input.files[0];
    if (!f) {
      if (input.required) { setInvalid(input, 'This file is required.'); return false; }
      setValid(input); return true;
    }
    const ext = f.name.split('.').pop().toLowerCase();
    if (!ALLOWED_EXT.includes(ext)) { setInvalid(input, `Allowed types: ${ALLOWED_EXT.join(', ')}`); return false; }
    if (f.size > LIMIT_MB * MB) { setInvalid(input, `Max file size is ${LIMIT_MB} MB.`); return false; }
    setValid(input); return true;
  }

  // UPDATED: validation (names allow internal spaces; email forbids any spaces)
  function textOk(input) {
    const raw = input.value || '';
    const val = raw.trim(); // validate against trimmed; don't rewrite while typing

    // Email: no spaces at all
    if (input.id === 'email_surrender') {
      if (/\s/.test(raw)) { setInvalid(input, 'Email cannot contain spaces.'); return false; }
      const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(raw);
      if (!ok) { setInvalid(input, 'Enter a valid email address.'); return false; }
      setValid(input); return true;
    }

    // First/Surname: allow internal spaces, disallow spaces-only
    if (input.id === 'fn_surrender' || input.id === 'sn_surrender') {
      if (!val) { setInvalid(input, 'Enter a name.'); return false; }
      setValid(input); return true;
    }

    if (!val) { setInvalid(input); return false; }

    const pattern = input.getAttribute('pattern');
    if (pattern) {
      try {
        const re = new RegExp(pattern);
        if (!re.test(val)) {
          if (input.id === 'studentID_surrender') setInvalid(input, 'Format: TUPC-XX-XXXX (last block 4â€“10 digits).');
          else if (input.id === 'stay_surrender') setInvalid(input, 'Use YYYY-YYYY (e.g., 2019-2023).');
          else setInvalid(input, 'Invalid format.');
          return false;
        }
      } catch(_) {}
    }
    setValid(input); return true;
  }

  function selectOk(sel) {
    if (!sel.value) { setInvalid(sel, 'Please choose an option.'); return false; }
    setValid(sel); return true;
  }

  function validateFieldById(id) {
    const el = elById(id);
    if (!el) return true;
    if (el.type === 'file') return fileOk(el);
    if (el.tagName === 'SELECT') return selectOk(el);
    return textOk(el);
  }

  function firstInvalidEl() {
    for (const id of FIELD_IDS) {
      const el = elById(id);
      if (!el) continue;
      if (el.classList.contains('is-invalid')) return el;
      const ok = validateFieldById(id);
      if (!ok) return el;
    }
    return null;
  }

  function updateSubmitState(showAlert = true) {
    let allGood = true;
    FIELD_IDS.forEach(id => { if (!validateFieldById(id)) allGood = false; });
    submitBtn.disabled = !allGood;
    if (alertBox && showAlert) alertBox.classList.toggle('d-none', allGood);
    return allGood;
  }

  // UPDATED: show/hide upload fields based on selection + set requireds
  function setUploadMode(mode) {
    const front = document.getElementById('front_surrender');
    const back  = document.getElementById('back_surrender');
    const frontLabel = document.getElementById('frontLabel');
    const backLabel  = document.getElementById('backLabel');
    const frontGroup = document.getElementById('frontGroup');
    const backGroup  = document.getElementById('backGroup');
    if (!front || !back || !frontGroup || !backGroup) return;

    // reset visual state
    [front, back].forEach(el => {
      el.classList.remove('is-valid','is-invalid');
      el.setCustomValidity('');
    });

    if (mode === 'id') {
      front.required = true;  back.required = true;
      if (frontLabel) frontLabel.textContent = 'Upload ID (Front):';
      if (backLabel)  backLabel.textContent  = 'Upload ID (Back):';
      frontGroup.classList.remove('d-none');
      backGroup.classList.remove('d-none');
    } else if (mode === 'affidavit') {
      front.required = true;  back.required = false;
      if (frontLabel) frontLabel.textContent = 'Affidavit of Loss (First Page):';
      if (backLabel)  backLabel.textContent  = 'Affidavit of Loss (Second Page, optional):';
      frontGroup.classList.remove('d-none');
      backGroup.classList.remove('d-none'); // visible but optional
    } else {
      // no selection: hide both, clear requirements & values
      front.required = false; back.required = false;
      front.value = ''; back.value = '';
      frontGroup.classList.add('d-none');
      backGroup.classList.add('d-none');
      if (frontLabel) frontLabel.textContent = 'Upload ID (Front) / Affidavit First Page:';
      if (backLabel)  backLabel.textContent  = 'Upload ID (Back) / Affidavit Second Page:';
    }
  }

  // ----- INIT + LIVE -----
  setUploadMode(docTypeSel ? docTypeSel.value : '');
  FIELD_IDS.forEach(id => {
    const el = elById(id);
    if (!el) return;
    const evt = (el.type === 'file' || el.tagName === 'SELECT') ? 'change' : 'input';
    el.addEventListener(evt, () => updateSubmitState(true));
  });

  // Trim names on blur (allow internal spaces; strip ends only)
  ['fn_surrender','sn_surrender'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('blur', () => {
      el.value = (el.value || '').trim();
      updateSubmitState(true);
    });
  });

  // Remove spaces live from email
  const emailEl = document.getElementById('email_surrender');
  if (emailEl) emailEl.addEventListener('input', () => {
    const cleaned = emailEl.value.replace(/\s+/g, '');
    if (emailEl.value !== cleaned) emailEl.value = cleaned;
  });

  if (docTypeSel) {
    docTypeSel.addEventListener('change', () => {
      setUploadMode(docTypeSel.value);
      updateSubmitState(true);
    });
  }

  updateSubmitState(false);

  // ----- SUBMIT -----
  form.addEventListener('submit', (e) => {
    ['fn_surrender','sn_surrender'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = (el.value || '').trim();
    });

    const ok = updateSubmitState(true);
    if (!ok) {
      e.preventDefault();
      const bad = firstInvalidEl();
      if (bad) bad.scrollIntoView({ behavior: 'smooth', block: 'center' });
      return;
    }
    if (modal) {
      if (titleEl) titleEl.textContent = 'Submitting Requestâ€¦';
      if (bodyEl) {
        bodyEl.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="spinner-border me-3" role="status" aria-hidden="true"></div>
            <div>Please wait while we submit your requestâ€¦</div>
          </div>`;
      }
      if (footer) footer.classList.add('d-none');
      modal.show();
    }
  });
})();
</script>

{% if show_modal %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const modalEl = document.getElementById('submissionModal');
  const modal   = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
  document.getElementById('submissionModalLabel').textContent = 'Request Submitted';
  document.getElementById('submissionModalBody').innerHTML =
    'Your request is being submitted and is subject to approval. Youâ€™ll receive an email update. Redirecting to home in ... ' +
    '<span id="submitCountdown">5</span> secondsâ€¦';
  modalEl.querySelector('.modal-footer').classList.remove('d-none');
  modal.show();

  let t = 5;
  const span = document.getElementById('submitCountdown');
  const timer = setInterval(() => {
    t--;
    if (span) span.textContent = t;
    if (t <= 0) {
      clearInterval(timer);
      window.location.href = "{% url 'client_home' %}";
    }
  }, 1000);
});
</script>
{% endif %}



</body>
</html>
