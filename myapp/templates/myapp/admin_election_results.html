{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSA - Election Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'myapp/css/admin_election.css' %}">
</head>
<body>
  <button class="btn btn-primary toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

  {% include "partials/sidebar.html" %}
  {% include "partials/logout_modal.html" %}

  <style>
    .input-group-sm .form-control:focus {
      border: 2px solid #440207;
      box-shadow: 0 0 0 0.15rem rgba(68, 2, 7, 0.1);
    }
    .input-group-sm .form-control:hover { border: 1px solid #440207; }
    .input-group-sm:focus-within .input-group-text {
      background-color: #f8f0f0; border-color: #440207; color: #440207;
    }
    .position-table h5 .mode-badge { font-size: .7rem; vertical-align: middle; }
  </style>

  <div class="mt-4 ps-4 pe-4" style="margin-left: 260px; min-height: 100vh;">
    <!-- Header -->
    <div class="election-header text-white mt-4"
        style="background: linear-gradient(to right, rgba(0,0,0,0.9), rgba(0,0,0,0.3)),
               url('{% static 'myapp/images/election_bg.jpg' %}');
               background-size: cover; background-position: center; background-repeat: no-repeat;
               padding: 50px; min-height: 100px; margin-bottom: 50px; border-radius: 20px;">
      <h2 class="fw-bold mb-0">University Student Government Election Dashboard</h2>
      <p class="mb-0">Monitor, manage, and update election proceedings.</p>
      <hr class="border-light">
    </div>

    <!-- Nav tabs -->
    <div class="d-flex gap-2">
      <a class="btn tab-btn mb-2 {% if request.resolver_match.url_name == 'admin_election' %}active{% endif %}"
         href="{% url 'admin_election' %}">
        <i class="bi bi-person-circle"></i> Candidates
      </a>
      <a class="btn tab-btn mb-2 {% if request.resolver_match.url_name == 'admin_election_results' %}active{% endif %}"
         href="{% url 'admin_election_results' %}">
        <i class="bi bi-bar-chart-fill"></i> Results
      </a>
      <a class="btn tab-btn mb-2 {% if request.resolver_match.url_name == 'admin_election_manage' %}active{% endif %}"
         href="{% url 'admin_election_manage' %}">
        <i class="bi bi-gear-fill"></i> Manage
      </a>
    </div>

    <!-- Results -->
    <div class="tab-content p-5 border rounded shadow-sm" style="background: #dddddd3b">
      <div class="container-fluid">
        <h4><i class="bi bi-bar-chart-fill me-2"></i><strong>Results</strong></h4>
        <p>See the election results and statistics of all candidates.</p>
        <hr class="bg-dark"><br>
        <!-- Toolbar -->
        <div class="d-flex flex-wrap gap-3 align-items-center">
          <div>
            <select id="electionFilter" class="form-select form-select-sm w-auto">
              <option value="">Loading elections…</option>
            </select>
          </div>
          <div class="input-group input-group-sm ms-auto w-50">
            <input type="text" id="searchInput" class="form-control" placeholder="Search by name">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
          </div>
        </div>

        <!-- Dynamic -->
        <div id="resultsRoot" class="d-flex flex-column gap-4"></div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Sidebar helpers
    function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('show'); }
    function handleDropdown(menuId){
      const icon = document.getElementById(`icon-${menuId}`);
      const menu = document.getElementById(menuId);
      const coll = bootstrap.Collapse.getOrCreateInstance(menu);
      if(menu.classList.contains('show')){ coll.hide(); icon.classList.remove('rotate'); }
      else { coll.show(); icon.classList.add('rotate'); }
      ['violationMenu','documentsMenu','postingsMenu','studentRecordMenu'].forEach(id=>{
        if(id!==menuId){ const m=document.getElementById(id); const ic=document.getElementById(`icon-${id}`);
          const c=bootstrap.Collapse.getInstance(m); if(c) c.hide(); if(ic) ic.classList.remove('rotate'); }
      });
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      const u=window.location.href;
      document.querySelectorAll('.nav-link').forEach(a=>{ if(a.href && u.includes(a.href)) a.classList.add('active'); });
    });
  </script>

  <script>
  (function(){
    const root = document.getElementById('resultsRoot');
    const electionFilter = document.getElementById('electionFilter');
    const searchInput = document.getElementById('searchInput');

    let payload = null;
    let elections = [];
    let currentElectionId = '';
    let searchQ = '';

    const pct = n => (Math.round(n * 100) / 100).toFixed(2);

    function rowHTML(r){
      const key = `${(r.name||'').toLowerCase()}|${(r.party||'').toLowerCase()}`;
      return `
        <tr data-key="${key}">
          <td>${r.name}${r.party ? ` <span class="badge bg-secondary ms-2">${r.party}</span>` : ''}</td>
          <td>${r.votes}</td>
          <td>${pct(r.percent)}%</td>
        </tr>`;
    }

    function filterTable(tbody){
      const q = (searchQ || '').trim();
      let any = false;
      tbody.querySelectorAll('tr').forEach(tr=>{
        if (tr.classList.contains('abstain-row')) { tr.style.display=''; return; }
        const key = tr.getAttribute('data-key') || '';
        const show = !q || key.includes(q);
        tr.style.display = show ? '' : 'none';
        if (show) any = true;
      });
      const noRow = tbody.querySelector('.no-match-msg');
      if (!any) {
        if (!noRow){
          const tr = document.createElement('tr');
          tr.className = 'no-match-msg';
          tr.innerHTML = `<td colspan="3" class="text-center text-muted">No matching candidate names.</td>`;
          tbody.appendChild(tr);
        }
      } else if (noRow) { noRow.remove(); }
    }

    function blockHTML(title, rows, extras){
      const abstainRow = (extras && typeof extras.abstain !== 'undefined')
        ? `<tr class="abstain-row table-danger"><td class="fw-bold">ABSTAIN</td><td>${extras.abstain}</td><td></td></tr>`
        : '';
      const subtitle = extras?.subtitle ? `<small class="text-muted ms-2">${extras.subtitle}</small>` : '';
      const modeBadge = extras?.modeBadge ? ` <span class="badge text-bg-info mode-badge">${extras.modeBadge}</span>` : '';
      return `
        <div class="position-table"  style="border: 0.5px solid rgb(65, 4, 4);  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); border-radius: 1rem;">
          <h5 class="fw-bold text-dark">${title}${modeBadge} ${subtitle}</h5>
          <div class="table-responsive">
            <table class="table table-dark align-middle text-center">
              <thead class="table"><tr><th>Name</th><th>Votes</th><th>Percentage</th></tr></thead>
              <tbody>
                ${rows.map(rowHTML).join('')}
                ${abstainRow}
              </tbody>
            </table>
          </div>
        </div>`;
    }

    function render(){
      if (!payload) return;
      const pos = payload.positions;
      root.innerHTML = '';

      // President
      root.insertAdjacentHTML('beforeend', blockHTML(
        'PRESIDENT',
        pos['President'].candidates,
        { subtitle:`(SY: ${payload.election.academic_year})`, abstain: pos['President'].abstain }
      ));

      // Vice President
      root.insertAdjacentHTML('beforeend', blockHTML(
        'VICE PRESIDENT',
        pos['Vice President'].candidates,
        { subtitle:`(SY: ${payload.election.academic_year})`, abstain: pos['Vice President'].abstain }
      ));

      // Senators (plurality vs majority)
      const sen = pos['Senator'];
      if (sen.mode === 'plurality') {
        const senWrap = document.createElement('div');
        senWrap.innerHTML = blockHTML('SENATORS', sen.candidates, {
          subtitle:`(SY: ${payload.election.academic_year})`,
          abstain: sen.abstain_slots,
          modeBadge: 'Plurality'
        });
        senWrap.querySelector('.position-table').insertAdjacentHTML('afterbegin', `
          <div class="mb-2">
            <span class="badge text-bg-dark">Projected Winners (Top ${sen.seat_count})</span>
            <div class="small text-muted mt-1">${(sen.winners||[]).map(w=>w.name).join(', ') || '—'}</div>
          </div>
        `);
        root.appendChild(senWrap.firstElementChild);
      } else {
        // Majority mode
        const senWrap = document.createElement('div');
        senWrap.innerHTML = blockHTML('SENATORS', sen.candidates, {
          subtitle:`(SY: ${payload.election.academic_year})`,
          modeBadge: 'Majority (50%+1)'
        });
        const infoHTML = `
        
        <div class="w-100 mb-3 text-center"> 
          <div class="alert alert-info py-2 mb-2">
            ${sen.notes || 'Each candidate must reach the threshold to be seated.'}
          </div><br>
          <div class="d-flex flex-wrap align-items-center gap-3 mb-2 justify-content-center">
            <span class="badge text-bg-secondary">Threshold: ${sen.threshold} ballot${sen.threshold===1?'':'s'}</span>
            <span class="badge text-bg-dark">Seats: ${sen.seat_count}</span>
            <span class="badge text-bg-success">Approved: ${(sen.approved||[]).length}</span>
            <span class="badge text-bg-warning">Vacant: ${sen.vacant_seats}</span>
          </div>
          <div class="mb-2">
            <span class="badge text-bg-success">Approved Candidates</span>
            <div class="small text-muted mt-1">${(sen.approved||[]).map(w=>w.name).join(', ') || '—'}</div>
          </div>
        </div>
        `;
        senWrap.querySelector('.position-table').insertAdjacentHTML('afterbegin', infoHTML);
        root.appendChild(senWrap.firstElementChild);
      }

      // Governors by org label
      const gov = pos['Governors'];
      const groups = gov.groups || {};
      const titles = Object.keys(groups).sort();
      if (!titles.length){
        root.insertAdjacentHTML('beforeend', `<div class="alert alert-info">No Governor candidates in this election.</div>`);
      } else {
        titles.forEach(orgLabel=>{
          const g = groups[orgLabel];
          root.insertAdjacentHTML('beforeend', blockHTML(
            orgLabel.toUpperCase(),
            g.candidates,
            { subtitle:`(SY: ${payload.election.academic_year})` }
          ));
        });
        root.insertAdjacentHTML('beforeend',
          `<div class="small text-muted">Overall Governor abstain ballots: ${gov.overall_abstain}</div>`
        );
      }

      // Apply search
      root.querySelectorAll('tbody').forEach(filterTable);
    }

    async function loadElections(){
      electionFilter.innerHTML = `<option value="">Loading elections…</option>`;
      try{
        const res = await fetch('/api/admin/elections/');
        const data = await res.json();
        if (data.status !== 'success') throw new Error(data.message || 'Failed to load elections');
        elections = data.elections || [];
        if (!elections.length){
          electionFilter.innerHTML = `<option value="">No elections</option>`;
          return;
        }
        const active = elections.find(e=>e.is_active);
        currentElectionId = active ? String(active.id) : String(elections[0].id);
        electionFilter.innerHTML = elections.map(e => `
          <option value="${e.id}" ${String(e.id)===currentElectionId?'selected':''}>
            ${e.label}
          </option>
        `).join('');
      }catch(err){
        console.error(err);
        electionFilter.innerHTML = `<option value="">Unable to load elections</option>`;
      }
    }

    async function loadResults(){
      root.innerHTML = `<div class="text-muted">Loading results…</div>`;
      const qs = new URLSearchParams();
      if (currentElectionId) qs.set('election_id', currentElectionId);
      const url = '/api/admin/results/' + (qs.toString() ? `?${qs.toString()}` : '');
      const res = await fetch(url);
      const data = await res.json();
      if (data.status !== 'success'){
        root.innerHTML = `<div class="alert alert-warning">${data.message || 'Unable to load results.'}</div>`;
        return;
      }
      payload = data;
      render();
    }

    electionFilter.addEventListener('change', ()=>{
      currentElectionId = electionFilter.value;
      loadResults();
    });

    searchInput.addEventListener('input', ()=>{
      searchQ = (searchInput.value || '').toLowerCase();
      root.querySelectorAll('tbody').forEach(filterTable);
    });

    // Boot
    (async function init(){
      await loadElections();
      await loadResults();
    })();
  })();
  </script>
</body>
</html>
