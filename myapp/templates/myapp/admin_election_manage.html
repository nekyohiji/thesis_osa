{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSA - Election Manage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  
  <link rel="stylesheet" href="{% static 'myapp/css/admin_election.css' %}">
</head>

<body>
  <button class="btn btn-primary toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

  {% include "partials/sidebar.html" %}
  {% include "partials/logout_modal.html" %}

<!-- //////////////////////////START HERE MAG CODE ///////////////////////////-->


  <style>

        /* Highlight on focus */
    .input-group-sm .form-control:focus {
    border: 2px solid #440207;
    box-shadow: 0 0 0 0.15rem rgba(68, 2, 7, 0.1); /* soft glow */
    }

    /* Optional: subtle border on hover */
    .input-group-sm .form-control:hover {
    border: 1px solid #440207;
    }

    .input-group-sm:focus-within .input-group-text {
    background-color: #f8f0f0;
    border-color: #440207;
    color: #440207;
    }
  
</style>

<div class="mt-4 ps-4 pe-4" style="margin-left: 260px; min-height: 100vh;">
  <div class="election-header text-white mt-4"
      style="background: linear-gradient(to right, rgba(0,0,0,0.9), rgba(0,0,0,0.3)), 
              url('{% static 'myapp/images/election_bg.jpg' %}');
              background-size: cover;
              background-position: center;
              background-repeat: no-repeat;
              padding: 50px;
              min-height: 100px;
              margin-bottom: 50px;
              border-radius: 20px;
              ">
    <h2 class="fw-bold mb-0">University Student Government Election Dashboard</h2>
    <p class="mb-0">Monitor, manage, and update election proceedings.</p>
    <hr class="border-light">
  </div>


      <div class="d-flex gap-2">
        <a class="btn tab-btn mb-2 {% if request.resolver_match.url_name == 'admin_election' %}active{% endif %}" 
          href="{% url 'admin_election' %}">
          <i class="bi bi-person-circle"></i> Candidates
        </a>

        <a class="btn tab-btn mb-2 {% if request.resolver_match.url_name == 'admin_election_results' %}active{% endif %}" 
          href="{% url 'admin_election_results' %}">
          <i class="bi bi-bar-chart-fill"></i> Results
        </a>

        <a class="btn tab-btn mb-2 {% if request.resolver_match.url_name == 'admin_election_manage' %}active{% endif %}" 
          href="{% url 'admin_election_manage' %}">
          <i class="bi bi-gear-fill"></i> Manage
        </a>
      </div>

<!-- ELECTION MANAGE -->

<div class="container-fluid p-5 rounded" style="background: #c2c1c13b ;">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold m-0">Election Management</h4>
    <span class="text-muted small">Server time: {{ now }}</span>
  </div>
  <hr>

  {% if messages %}
    <div class="mb-3">
      {% for m in messages %}
        <div class="alert alert-{{ m.tags|default:'secondary' }} py-2 mb-2">{{ m }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row gy-3">
    <div class="col-lg-7">

      <div class="card p-4" style="border: 0.5px solid rgb(65, 4, 4);  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); border-radius: 1rem;">
        <div class="card-body">
          <h5 class="card-title fw-bold"><i class="bi bi-bar-chart-fill me-2"></i>Elections</h5>
          <small>Monitor Election availability and ligibility.</small>
          <div class="table-responsive"> <br>
            <table class="table align-middle text-center">
              <thead>
                <tr>
                  <th>#</th><th>Name</th><th>Year</th><th>Window</th><th>Status</th><th>Eligible Count</th><th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% if elections %}
                  {% for e in elections %}
                    <tr>
                      <td>{{ forloop.counter }}</td>
                      <td class="fw-medium">{{ e.name }}</td>
                      <td><span class="badge bg-secondary">{{ e.academic_year }}</span></td>

                      <td class="small text-muted">
                        <div><strong>Start:</strong> {{ e.start_date }}</div>
                        <div><strong>End:</strong> {{ e.end_date }}</div>
                      </td>

                      <td>
                        {% if e.status == 'finalized' %}
                          <span class="badge bg-dark">Finalized</span>
                        {% elif e.status == 'scheduled' %}
                          <span class="badge bg-warning text-dark">Scheduled</span>
                        {% elif e.status == 'closed' %}
                          <span class="badge bg-secondary">Closed</span>
                        {% elif e.status == 'active' %}
                          <span class="badge bg-success">Active</span>
                        {% endif %}
                      </td>

                      {# ✅ Eligible Count cell #}
                      <td>
                        <span class="eligible-count" data-eid="{{ e.id }}">{{ e.eligibles.all.count }}</span>
                      </td>

                      {# Actions #}
                      <td class="text-nowrap d-flex flex-column justify-content-center gap-2">



                        <button type="button" class="btn btn-sm  elig-toggle-btn text-light"  style="background: #440207;" data-target="upload">Upload</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary elig-toggle-btn" data-target="verify">Verify ID</button>

                        <!-- Upload eligibles -->
                        <form method="post" action="{% url 'eligibles_upload' e.id %}" enctype="multipart/form-data" class="d-none toggle-form upload mt-2">
                          {% csrf_token %}

                        <div class="d-flex gap-2 align-items-center">
                          <input type="file" name="csv" accept=".csv" class="form-control form-control-sm" required>
                          <button class="btn btn-sm text-light " style="background: #440207;">Upload</button>
                        </div>
                        </form>

                        <!-- Verify -->
                        <form method="post" action="{% url 'eligibles_verify' e.id %}" class="d-none toggle-form verify mt-2">
                          {% csrf_token %}
                        <div class="d-flex gap-2 align-items-center">
                          <input name="student_id" placeholder="TUP ID" class="form-control form-control-sm" required>
                          <button class="btn btn-sm btn-outline-secondary">Verify ID</button>
                        </div>
                        </form>

                        <!-- Close now -->
                        <button
                          class="btn btn-sm btn-warning mt-2"
                          data-bs-toggle="modal"
                          data-bs-target="#confirmEndModal"
                          data-eid="{{ e.id }}"
                          title="Close this election today"
                          {% if e.status != 'active' %}disabled{% endif %}>
                          Close now
                        </button>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="7" class="text-center text-muted py-4">No elections yet.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
          <p class="small text-muted m-0">Tip: upload a fresh whitelist for each election.</p>
        </div>
      </div>
    </div>




    
    <div class="col-lg-5 ">
      <div class="card p-4" style="border: 0.5px solid rgb(65, 4, 4);  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); border-radius: 1rem;">
        <div class="card-body">
          <h4 class="card-title text-center fw-bold">Create New Election</h4><hr class="bg-dark">
          <form method="post" action="{% url 'admin_election_create' %}" class="row g-2">
            {% csrf_token %}
            <div class="col-6">
              <label class="form-label fw-bold ">Name:</label>
              <input
                id="election_name"
                name="name"
                class="form-control text-center"
                placeholder="Student Government Election"
                required
                maxlength="120"
                autocomplete="off"
              />
            </div>

            <div class="col-6">
              <label class="form-label fw-bold">Academic Year:</label>
              <input
                name="academic_year"
                class="form-control text-center"
                placeholder="2025-2026"
                required
                maxlength="9"
                inputmode="numeric"
                pattern="^(19|20)\d{2}-(19|20)\d{2}$"
                title="Format must be YYYY-YYYY (e.g., 2025-2026)."
                autocomplete="off"
              />
            </div>
            <div class="col-6">
              <label class="form-label fw-bold">Start:</label>
              <input
                type="date"
                name="start_date"
                id="start_date"
                class="form-control text-center"
                required
                value="{{ now|date:'Y-m-d' }}"
                min="{{ now|date:'Y-m-d' }}"
                max="{{ now|date:'Y-m-d' }}"
              >
            </div>
            <div class="col-6">
              <label class="form-label fw-bold">End:</label>
              <input type="date" name="end_date" id="end_date" class="form-control text-center" required>  
            </div>
            
            <div class="col-12">
              <br>
              <button class="btn w-100 text-light" 
              style="color:#440207; background:#440207;"
              onmouseover="this.style.backgroundColor='#440207'; this.style.color='#fff';"
            >Create</button>
            </div>
          </form>
        </div>
      </div>




      <div class="card mt-3" style="border: 0.5px solid rgb(65, 4, 4); box-shadow: 0 4px 10px rgba(0,0,0,0.5); border-radius: 1rem;">
        <div class="card-body">
          <h6 class="card-title fw-bold">Scan / Enroll Eligible</h6>

          <div class="mb-2">
            <label class="form-label small">Election:</label>
            <select id="scanElection" class="form-select form-select-sm">
              {% for e in elections %}
                <option value="{{ e.id }}" {% if e.status == 'active' %}selected{% endif %}>
                  {{ e.name }} ({{ e.academic_year }}) — {{ e.status|capfirst }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="input-group input-group-sm mb-2">
            <span class="input-group-text"><i class="bi bi-qr-code-scan"></i></span>
            <input id="scanBox" class="form-control" placeholder="Scan or type TUP ID (press Enter)" autocomplete="off" autofocus>
          </div>

          <div id="scanHint" class="small text-muted mb-2">
            Tip: handheld scanners act like keyboards—ensure it sends an Enter key after the scan.
          </div>

          <div id="scanResult" class="d-none"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- //////////////////////////FOR MODALS-->

<!-- Enable Voting Modal -->
  <div class="modal fade" id="confirmEnableModal" tabindex="-1" aria-labelledby="enableModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border">
          <div class="modal-header">
          <h5 class="modal-title" id="enableModalLabel"></h5>
          </div>
          <div class="modal-body text-center">
          Are you sure you want to <strong>Enable</strong> voting for all programs?
          </div>
          <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="confirmEnableBtn"> Enable Election</button>
          </div>
      </div>
      </div>
  </div>

<!-- Disable Voting Modal -->
  <div class="modal fade" id="confirmDisableModal" tabindex="-1" aria-labelledby="disableModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border">
          <div class="modal-header">
          <h5 class="modal-title" id="disableModalLabel"></h5>
          </div>
          <div class="modal-body text-center">
          Are you sure you want to <strong>Disable</strong> voting for all programs?
          </div>
          <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDisableBtn">Disable Election</button>
          </div>
      </div>
      </div>
  </div>

<!-- Create Election Period Modal -->
  <div class="modal fade" id="confirmCreateModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border">
          <div class="modal-header">
          <h5 class="modal-title" id="createModalLabel"></h5>
          </div>
          <div class="modal-body text-center">
          Are you sure you want to <strong>Create</strong> a new election period?
          </div>
          <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmCreateBtn">Create Election</button>
          </div>
      </div>
      </div>
  </div>

<!-- End Election Period Modal -->
  <div class="modal fade" id="confirmEndModal" tabindex="-1" aria-labelledby="endModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border">
          <div class="modal-header">
          <h5 class="modal-title" id="endModalLabel"></h5>
          </div>
          <div class="modal-body text-center">
          Are you sure you want to <strong>End</strong> the current election period?
          </div>
          <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-dark" id="confirmEndBtn">End Election</button>
          </div>
      </div>
      </div>
  </div>

<form id="endNowForm" method="post" class="d-none">
  {% csrf_token %}
</form>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>


/* Sidebar Functions*/
      // Toggle Sidebar
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('show');
      }

      // Handle Dropdowns Uniformly
      function handleDropdown(menuId) {
        const clickedIcon = document.getElementById(`icon-${menuId}`);
        const clickedMenu = document.getElementById(menuId);
        const clickedCollapse = bootstrap.Collapse.getOrCreateInstance(clickedMenu);

        // Toggle clicked menu
        if (clickedMenu.classList.contains('show')) {
          clickedCollapse.hide();
          clickedIcon.classList.remove('rotate');
        } else {
          clickedCollapse.show();
          clickedIcon.classList.add('rotate');
        }

        // Hide other open menus
        const allDropdowns = ['violationMenu', 'documentsMenu', 'postingsMenu', 'studentRecordMenu'];
        allDropdowns.forEach(id => {
          if (id !== menuId) {
            const menu = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            const collapse = bootstrap.Collapse.getInstance(menu);
            if (collapse) collapse.hide();
            if (icon) icon.classList.remove('rotate');
          }
        });
      }

      // Highlight Active Link
      document.addEventListener('DOMContentLoaded', function () {
        const currentUrl = window.location.href;
        const navLinks = document.querySelectorAll('.nav-link');

        navLinks.forEach(link => {
          if (link.href && currentUrl.includes(link.href)) {
            link.classList.add('active');
          }
        });
      });
</script>

<script>
(function(){
  // Build URL like you do for "close now"
  const scanBase = "{% url 'eligible_scan' 0 %}";

  const elSel   = document.getElementById('scanElection');
  const elBox   = document.getElementById('scanBox');
  const elRes   = document.getElementById('scanResult');

  function showResult(kind, html){
    elRes.className = ''; // reset
    elRes.classList.add('alert', 'py-2', 'mb-0');
    elRes.classList.add(kind); // 'alert-success' | 'alert-info' | 'alert-warning' | 'alert-danger'
    elRes.innerHTML = html;
    elRes.classList.remove('d-none');
  }

  function tupOnly(raw){
    // mirror backend logic: extract TUP id-ish token
    const m = raw.match(/(TUP[A-Z]*-\d{2}-\d{3,10})/i);
    let token = m ? m[1] : (raw.split(/\s+/)[0] || raw);
    token = token.replace(/[‐-‒–—―]/g, '-').replace(/\s+/g, '').replace(/[^A-Za-z0-9-]/g, '').toUpperCase();
    return token.startsWith('TUP') ? token : '';
  }

  async function doScanSubmit(raw){
    const eid = elSel.value;
    const sid = tupOnly(raw);
    if (!sid){
      showResult('alert-warning', 'No TUP ID detected. Please scan again.');
      return;
    }
    // POST
    const url = scanBase.replace('/0/', `/${eid}/`);
    const fd  = new FormData();
    fd.append('payload', raw);

    try{
      const resp = await fetch(url, { method: 'POST', body: fd, headers: { 'X-CSRFToken': '{{ csrf_token }}' }});
      const data = await resp.json();

      if (data.status === 'enrolled'){
        showResult('alert-success', `<strong>${data.sid}</strong> enrolled. Eligible count: ${data.eligible_count}${data.already_voted ? ' — <em>Already Voted</em>' : ''}`);
      } else if (data.status === 'already_eligible'){
        showResult('alert-info', `<strong>${data.sid}</strong> is already eligible${data.already_voted ? ' — <em>Already Voted</em>' : ''}.`);
      } else if (data.status === 're_enabled'){
        showResult('alert-success', `<strong>${data.sid}</strong> re-enabled as eligible.`);
      } else if (data.status === 'not_in_student'){
        showResult('alert-danger', `<strong>${data.sid}</strong> not found in Student records.`);
      } else {
        showResult('alert-warning', data.message || 'Unexpected response.');
      }
      if (Object.prototype.hasOwnProperty.call(data, 'eligible_count')) {
        document
          .querySelectorAll(`.eligible-count[data-eid="${eid}"]`)
          .forEach(el => {
            el.textContent = Number(data.eligible_count).toLocaleString();
            el.classList.remove('flash'); // retrigger animation
            // force reflow to restart CSS animation
            void el.offsetWidth;
            el.classList.add('flash');
          });
      }
    }catch(err){
      showResult('alert-danger', 'Network or server error.');
    }finally{
      elBox.value = '';
      elBox.focus();
    }
  }

  if (elBox){
    // Scanner usually "types" then presses Enter
    elBox.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        e.preventDefault();
        doScanSubmit(elBox.value.trim());
      }
    });
    // Optional: paste trigger
    elBox.addEventListener('paste', (e) => {
      setTimeout(() => doScanSubmit(elBox.value.trim()), 0);
    });
  }
})();
// stay focused even after accidental clicks
elBox.addEventListener('blur', () => setTimeout(() => elBox.focus(), 0));

// some scanners inject a newline char instead of Enter
elBox.addEventListener('input', () => {
  if (/\r|\n/.test(elBox.value)) {
    const trimmed = elBox.value.replace(/[\r\n]+/g,'').trim();
    if (trimmed) doScanSubmit(trimmed);
  }
});
document.addEventListener("DOMContentLoaded", function() {
  const startEl = document.getElementById("start_date");
  const endEl = document.getElementById("end_date");

  startEl.addEventListener("change", function() {
    if (!startEl.value) return;
    const start = new Date(startEl.value);
    const maxEnd = new Date(start);
    maxEnd.setDate(maxEnd.getDate() + 60);

    endEl.min = startEl.value;
    endEl.max = maxEnd.toISOString().slice(0,10);

    if (!endEl.value || new Date(endEl.value) < start || new Date(endEl.value) > maxEnd) {
      endEl.value = startEl.value;
    }
  });
});
document.addEventListener('DOMContentLoaded', () => {
  const el = document.getElementById('election_name');

  // Block leading or double spaces as you type
  el.addEventListener('keydown', (e) => {
    if (e.key === ' ') {
      const i = el.selectionStart ?? 0;
      const prev = i > 0 ? el.value[i - 1] : '';
      if (i === 0 || prev === ' ') e.preventDefault();
    }
  });

  // Live sanitize
  el.addEventListener('input', () => {
    let v = el.value;

    // 1) letters and spaces only
    v = v.replace(/[^A-Za-z ]+/g, '');

    // 2) collapse multiple internal spaces
    v = v.replace(/ {2,}/g, ' ');

    // 3) no leading spaces
    v = v.replace(/^ +/, '');

    // 4) allow ONE trailing space while typing (don’t strip)
    //    but prevent 2+ trailing spaces
    v = v.replace(/ {2,}$/, ' ');

    if (el.value !== v) el.value = v;

    // 5) validity
    const lettersOnly = v.replace(/ /g, '');
    el.setCustomValidity(lettersOnly.length >= 2 ? '' : 'Enter at least 2 letters. Spaces only between letters.');
  });

  // On blur, trim any trailing space
  el.addEventListener('blur', () => {
    el.value = el.value.replace(/ +$/, '');
  });
});
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('confirmEndModal');
  const form  = document.getElementById('endNowForm');
  const confirmBtn = document.getElementById('confirmEndBtn');

  // When the modal opens, point the hidden form to the right URL using the row's data-eid
  modal.addEventListener('show.bs.modal', (ev) => {
    const trigger = ev.relatedTarget; // the "Close now" button
    const eid = trigger?.getAttribute('data-eid');
    // Build URL from named route; replace /0/ with /<eid>/
    const base = "{% url 'admin_election_close_now' 0 %}";
    form.action = base.replace('/0/', `/${eid}/`);
  });

  // Submit POST when user confirms
  confirmBtn.addEventListener('click', () => form.submit());
});

  // Toggle buttons (verify and uplaod)
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.elig-toggle-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const target = btn.getAttribute('data-target'); // "upload" or "verify"
      const td = btn.closest('td');
      if (!td) return; // safety
      const form = td.querySelector('.toggle-form.' + target);
      if (!form) return;
      form.classList.toggle('d-none'); // show/hide
    });
  });
});
</script>
</body>
</html>