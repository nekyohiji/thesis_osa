{% load static %}

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
  <title>OSA - Student Assistantship</title>

  <!-- Bootstrap CSS + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- Fonts + FA (optional) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Your CSS -->
  <link rel="stylesheet" href="{% static 'myapp/css/client_CS.css' %}">

  <style>
    .form-section {
      border: 1px solid #800000; border-radius: 6px; padding: 20px; margin-bottom: 20px; background-color: #fff;
    }
    .form-section h5 { font-weight: bold; margin-bottom: 15px; }
    .form-control:focus, .form-select:focus {
      border-color: #5e0000; box-shadow: 0 0 4px rgba(94,0,0,.4); outline: none;
    }
    .btn-submit { background-color: #440207; color:#fff; transition: .2s; }
    .btn-submit:hover { background-color: #5e0000; color:#fff; font-weight: 600; }
    .hint { font-size: .85rem; color:#6c757d; }
    .status-wrap { position: relative; }
    .status-icon {
      position: absolute; right: .65rem; top: 50%; transform: translateY(-50%);
      font-size: 1.05rem; pointer-events: none;
    }
    .status-wrap .form-control, .status-wrap .form-select { padding-right: 2rem; }
  </style>
</head>
<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-custom fixed-top">
  <div class="container-fluid">
    <a id="TUPC" class="navbar-brand" href="{% url 'client_home' %}">
      <img src="{% static 'myapp/images/logo.png' %}" alt="TUP Logo" class="img-fluid me-2">
      <span class="d-none d-sm-inline"><b>Technological University of the Philippines - Cavite</b></span>
      <span class="d-inline d-sm-none"><b>TUPC</b></span>
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="{% url 'client_studentAssistantship' %}"> &larr; Return to Posting Platform</a></li>
      </ul>
    </div>
  </div>
</nav>
<br><br>
<div class="d-flex justify-content-start p-4">
    </div>

<div class="container mb-5">
 
  <!-- Header -->
  <div class="mb-4">
    <h1 class="mb-3">
      <i class="fas fa-file-signature me-2"></i>
      <b>Student Assistantship Form</b>
    </h1>
    <hr>
    <h6 class="text-muted">Please fill in the required information below.</h6>
    <h6 class="text-danger"><b>INCORRECT INFORMATION WILL RESULT IN DELAY OR NON-ISSUANCE OF THE REQUESTED DOCUMENT.</b></h6>
  </div>

  <!-- Top alert -->
  <div id="formAlert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
    <strong>Some fields need attention.</strong> Look for red ❌ icons and messages beside the fields.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <!-- FORM -->
  <form id="studentassistform" method="post" action="{% url 'submit_student_assist' %}" novalidate>
    {% csrf_token %}

    <!-- Personal -->
    <div class="form-section">
      <div class="card-body">
        <h5 class="fw-bold mb-3"><i class="bi bi-person-fill"></i> Personal Information</h5><hr>

        <div class="row">
          <div class="col-md-12 mb-3">
            <label class="form-label fw-semibold" for="full_name">Full Name:</label>
            <div class="status-wrap">
              <input
                type="text"
                class="form-control"
                id="full_name"
                name="name"
                placeholder="e.g., Juan Dela Cruz"
                minlength="2"
                maxlength="100"
                required
                inputmode="text"
                pattern="^(?! )(?!.* {2,})(?!.* $)[A-Za-zÑñ.'-]+(?: [A-Za-zÑñ.'-]+)*$"
                title="Letters, period (.), apostrophe ('), hyphen (-); single spaces between words; no trailing space.">
              <i id="full_name_status" class="status-icon bi d-none"></i>
            </div>
            <div class="invalid-feedback">Full name is required (2–100 characters).</div>
          </div>
        </div>


        <div class="row">
            <div class="col-md mb-3">
              <label class="form-label fw-semibold" for="age">Age:</label>
              <div class="status-wrap">
                <input type="number" class="form-control" id="age" name="age"
                      placeholder="e.g., 21" min="16" max="121" step="1" required>
                <i id="age_status" class="status-icon bi d-none"></i>
              </div>
              <div class="hint mt-1">Required. Allowed: 16–121.</div>
              <div class="invalid-feedback">Age must be 16–121.</div>
            </div>

            <div class="col-md mb-3">
              <label class="form-label fw-semibold" for="sex">Sex:</label>
              <div class="status-wrap">
                <select class="form-select" id="sex" name="sex" required>
                  <option value="" selected>-- Select --</option>
                  <option>Male</option>
                  <option>Female</option>
                </select>
                <i id="sex_status" class="status-icon bi d-none"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- ID & Program -->
        <div class="row g-3 mb-3">
            <div class="col-12 col-md-6">
              <label class="form-label fw-semibold" for="id">ID:</label>
              <div class="status-wrap">
                <input type="text" class="form-control" id="id" name="tupc_id"
                      placeholder="TUPC-XX-XXXX" required
                      pattern="^TUPC-\d{2}-[A-Za-z0-9]{4,15}$"
                      title="Format: TUPC-XX-XXXX (min 4 characters, up to 15)" minlength="12" maxlength="23">
                <i id="id_status" class="status-icon bi d-none"></i>
              </div>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label fw-semibold" for="program">Program:</label>
              <div class="status-wrap">
                <input type="text" class="form-control" id="program" name="program" maxlength="18"
                      placeholder="BET-COET" required>
                <i id="program_status" class="status-icon bi d-none"></i>
              </div>
              <div class="hint mt-1">Max 18 characters.</div>
            </div>


            <div class="row g-3 mb-3">
            <!-- Contact -->
            <div class="col-12 col-md-6">
                <label class="form-label fw-semibold" for="contact">Contact No.:</label>
                <div class="status-wrap">
                <input type="text" class="form-control" id="contact" name="contact"
                        value="+63 " placeholder="+63 995-241-5114"
                        minlength="16" maxlength="16"
                        pattern="^\+63\s\d{3}-\d{3}-\d{4}$"
                        title="Format: +63 XXX-XXX-XXXX"
                        autocomplete="off" required>
                <i id="contact_status" class="status-icon bi d-none"></i>
                </div>
                <div class="valid-feedback">Format OK.</div>
                <div class="invalid-feedback">Use +63 XXX-XXX-XXXX.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold" for="contact_email">Email</label>
              <input type="email" class="form-control" id="contact_email" name="contact_email" autocomplete="email" inputmode="email" required>
              <div class="invalid-feedback">Email must end with @gmail.com, @gsfe.tupcavite.edu.ph, or @tup.edu.ph.</div>
            </div>

            <!-- Address -->
            <div class="col-12 col-md-6">
                <label class="form-label fw-semibold" for="address">Address:</label>
                <div class="status-wrap">
                <input type="text" class="form-control" id="address" name="address"
                        placeholder="House/Street, Barangay, City/Municipality, Province, ZIP"
                        minlength="5" maxlength="255" required>
                <i id="address_status" class="status-icon bi d-none"></i>
                </div>
                <div class="invalid-feedback">Please enter your full address (min 5 characters).</div>
            </div>
        </div>  
    </div>

    <!-- CLIENT TYPE SECTION -->
    <div class="form-section mt-4">
        <div class="card-body">
            <h5 class="fw-bold mb-3"><i class="bi bi-person-fill"></i> Client Type (Required)</h5><hr>

          <!-- Client Type Row -->
          <div class="row mb-3">
            <div class="col-md-12">
              <label class="form-label fw-semibold" for="client_type">Client Type:</label>
                <select class="form-select" id="client_type" name="client_type" required>
                  <option value="">-- Select Client Type --</option>
                  <option value="Citizen">Citizen</option>
                  <option value="Business">Business</option>
                  <option value="Government (Employee/Agency)">Government (Employee/Agency)</option>
                </select>
                <div class="invalid-feedback">Please select a client type.</div>
              </div>
            </div>
          </div>

          <!-- Are you a/an Section -->
          <div class="row">
            <div class="col-md-12">
            <label class="form-label fw-semibold">Are you a/an:</label>
            <div class="row mt-2 gy-2">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="radio" id="st_tupc" name="stakeholder" value="TUPC Student" required>
                  <label class="form-check-label" for="st_tupc">TUPC Student — Year level</label>

                  <!-- Year level dropdown, hidden by default (NOT required here) -->
                  <select class="form-select mt-2 d-none" id="year_level" name="year_level">
                    <option value="" selected>-- Select year level --</option>
                    <option>1st Year</option>
                    <option>2nd Year</option>
                    <option>3rd Year</option>
                    <option>4th Year</option>
                    <option>5th Year</option>
                  </select>
                  <div class="invalid-feedback" id="year_level_feedback">Please select your year level.</div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="radio" id="st_external" name="stakeholder" value="External Client" required>
                  <label class="form-check-label" for="st_external">External Client</label>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="radio" id="st_alumnus" name="stakeholder" value="Alumnus" required>
                  <label class="form-check-label" for="st_alumnus">Alumnus</label>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="radio" id="st_parent" name="stakeholder" value="Parent/Guardian" required>
                  <label class="form-check-label" for="st_parent">Parent/Guardian</label>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="radio" id="st_otherstud" name="stakeholder" value="Student from other School" required>
                  <label class="form-check-label" for="st_otherstud">Student from other school</label>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="radio" id="st_employee" name="stakeholder" value="TUPC Employee" required>
                  <label class="form-check-label" for="st_employee">TUPC Employee</label>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>
  </div>

    <!-- Submit -->
    <div class="d-flex justify-content-end mt-4 ">
  
      <button type="button"
              id="openConfirmModal"
              class="btn btn-submit d-flex align-items-center px-4"
              data-bs-toggle="modal" data-bs-target="#confirmSubmitModal"
              disabled>
        <i class="bi bi-send-fill me-2"></i> Submit Request
      </button>
    </div>
  </form>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmSubmitModal" tabindex="-1" aria-labelledby="confirmSubmitModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="confirmSubmitModalLabel">Confirm Submission</h5></div>
      <div class="modal-body text-center">
        Are you sure you want to submit this request?<br>Double-check your details before proceeding.
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" form="studentassistform" class="btn text-light" style="background-color:#440207;" id="confirmSubmitBtn">Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- Redirect Modal -->
<div class="modal fade" id="redirectModal" tabindex="-1" aria-labelledby="redirectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header"><h5 class="modal-title" id="redirectModalLabel">Submitting…</h5></div>
      <div class="modal-body">
        Your request is being submitted. You’ll be redirected to Home in
        <strong><span id="countModal">5</span></strong> seconds.
        <div class="small text-muted mt-2">Please don’t close this tab.</div>
        <div id="submitError" class="alert alert-danger d-none mt-3" role="alert">Submission failed. Please try again later.</div>
      </div>
      <div class="modal-footer"><a href="{% url 'client_home' %}" class="btn btn-primary" id="goNowBtn">Go Now</a></div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ================== CONSTANTS ================== */
const PROGRAM_MAX = 18;
const RE_PHONE_HYPHEN = /^\+63\s\d{3}-\d{3}-\d{4}$/;
const RE_TUPC_ID = /^TUPC-\d{2}-[A-Za-z0-9]{4,15}$/; // TUPC-YY-<4–15 alnum>
const RE_NAME = /^(?! )(?!.* {2,})(?!.* $)[A-Za-zÑñ.'-]+(?: [A-Za-zÑñ.'-]+)*$/;
const RE_ALLOWED_EMAIL = /^[^\s@]+@(?:gmail\.com|gsfe\.tupcavite\.edu\.ph|tup\.edu\.ph)$/i;

/* ================== HELPERS ================== */
function digitsOnly(s){ return (s||"").replace(/\D+/g,""); }
function formatPhMobileHyphenated(raw){
  const d = digitsOnly(raw);
  const rest = d.startsWith("63") ? d.slice(2) : d;
  const ten = rest.slice(0,10);
  if (!ten) return "+63 ";
  const a = ten.slice(0,3), b = ten.slice(3,6), c = ten.slice(6,10);
  return `+63 ${a}${b?'-'+b:''}${c?'-'+c:''}`;
}
function setClasses(el, valid){ el.classList.toggle('is-valid',valid); el.classList.toggle('is-invalid',!valid); }
function setStatusIcon(el, valid){
  const icon = document.getElementById(el.id + '_status'); if (!icon) return;
  icon.classList.remove('d-none','bi-check-circle-fill','bi-x-circle-fill','text-success','text-danger');
  icon.classList.add(valid ? 'bi-check-circle-fill' : 'bi-x-circle-fill', valid ? 'text-success' : 'text-danger');
}
function mark(el, ok){ setClasses(el, ok); setStatusIcon(el, ok); return ok; }

/* ================== ELEMENTS ================== */
const form       = document.getElementById('studentassistform');
const openBtn    = document.getElementById('openConfirmModal');
const confirmBtn = document.getElementById('confirmSubmitBtn');
const formAlert  = document.getElementById('formAlert');

const fullName = document.getElementById('full_name') || document.getElementById('first_name');
const ageEl    = document.getElementById('age');
const sexEl    = document.getElementById('sex');
const idEl     = document.getElementById('id');
const program  = document.getElementById('program');
const phone    = document.getElementById('contact');
const address  = document.getElementById('address');
const emailEl  = document.getElementById('contact_email');
const clientTypeSel = document.getElementById('client_type');

const stTupc   = document.getElementById('st_tupc');
const yrSel    = document.getElementById('year_level');
const stRadios = [...document.querySelectorAll('input[name="stakeholder"]')];

/* ================== SHOW/HIDE YEAR LEVEL (single toggler) ================== */
function toggleYearLevel(){
  if (!stTupc || !yrSel) return;
  const show = stTupc.checked;
  yrSel.classList.toggle('d-none', !show);
  yrSel.required = show;
  if (!show){
    yrSel.value = '';
    yrSel.classList.remove('is-valid','is-invalid');
    yrSel.setCustomValidity('');
  }
}

/* ================== FIELD VALIDATORS ================== */
function validateEmail(){
  if (!emailEl) return true;
  const v = (emailEl.value || "").trim();
  const ok = RE_ALLOWED_EMAIL.test(v);
  emailEl.setCustomValidity(ok ? "" : "Email must end with @gmail.com, @gsfe.tupcavite.edu.ph, or @tup.edu.ph.");
  emailEl.classList.toggle('is-valid', ok);
  emailEl.classList.toggle('is-invalid', !ok);
  return ok;
}

function validateFullName(){
  if (!fullName) return true;
  let v = fullName.value;
  if (v.endsWith(' ')) {
    fullName.setCustomValidity('No trailing space allowed.');
    return mark(fullName, false);
  }
  v = v.trim();
  fullName.value = v;
  const ok = v.length >= 2 && v.length <= 100 && RE_NAME.test(v);
  fullName.setCustomValidity(ok ? '' :
    "Letters, period (.), apostrophe ('), hyphen (-); single spaces between words; no trailing space."
  );
  return mark(fullName, ok);
}

function validateAge(){
  if (!ageEl) return true;
  const n = Number((ageEl.value||'').trim());
  const ok = Number.isInteger(n) && n >= 16 && n <= 121;
  ageEl.setCustomValidity(ok ? '' : 'Age must be 16–121.');
  return mark(ageEl, ok);
}

function validateSex(){
  if (!sexEl) return true;
  const ok = !!sexEl.value;
  sexEl.setCustomValidity(ok ? '' : 'Please select sex.');
  return mark(sexEl, ok);
}

function validatePhone(){
  if (!phone) return true;
  const ok = RE_PHONE_HYPHEN.test(phone.value);
  phone.setCustomValidity(ok ? '' : 'Use +63 XXX-XXX-XXXX.');
  return mark(phone, ok);
}

function validateAddress(){
  if (!address) return true;
  const v = address.value.trim();
  const ok = v.length >= 5 && v.length <= 255;
  address.setCustomValidity(ok ? '' : 'Address must be 5–255 characters.');
  return mark(address, ok);
}

function validateID(){
  if (!idEl) return true;
  idEl.value = idEl.value.toUpperCase().replace(/\s+/g,'');
  const ok = RE_TUPC_ID.test(idEl.value);
  idEl.setCustomValidity(ok ? '' : 'Format: TUPC-XX-<4–15 letters/numbers>.');
  return mark(idEl, ok);
}

function validateProgram(){
  if (!program) return true;
  const v = program.value.trim();
  const ok = v.length >= 1 && v.length <= PROGRAM_MAX;
  program.setCustomValidity(ok ? '' : `Program must be 1–${PROGRAM_MAX} characters.`);
  return mark(program, ok);
}

function validateClientType(){
  if (!clientTypeSel) return true;
  const ok = !!clientTypeSel.value;
  clientTypeSel.setCustomValidity(ok ? '' : 'Please select a client type.');
  clientTypeSel.classList.toggle('is-valid', ok);
  clientTypeSel.classList.toggle('is-invalid', !ok);
  return ok;
}

function validateStakeholderGroup(){
  if (!stRadios.length) return true;
  const anyChecked = stRadios.some(r => r.checked);
  stRadios.forEach(r => r.setCustomValidity(''));
  if (!anyChecked){
    (document.activeElement && stRadios.includes(document.activeElement) ? document.activeElement : stRadios[0])
      .setCustomValidity('Please choose one.');
  }
  return anyChecked;
}

function validateYearLevel(){
  if (!yrSel || !stTupc) return true;
  if (!stTupc.checked) return true;
  const ok = !!yrSel.value;
  yrSel.setCustomValidity(ok ? '' : 'Please select your year level.');
  yrSel.classList.toggle('is-valid', ok);
  yrSel.classList.toggle('is-invalid', !ok);
  return ok;
}

/* ================== MASTER FORM VALIDATOR (single definition) ================== */
function validateForm(){
  let ok = true;
  ok = validateEmail()              && ok;
  ok = validateFullName()           && ok;
  ok = validateAge()                && ok;
  ok = validateSex()                && ok;
  ok = validatePhone()              && ok;
  ok = validateAddress()            && ok;
  ok = validateID()                 && ok;
  ok = validateProgram()            && ok;
  ok = validateClientType()         && ok;
  ok = validateStakeholderGroup()   && ok;
  ok = validateYearLevel()          && ok;

  ok = form.checkValidity()         && ok;
  openBtn.disabled = !ok;
  if (ok) formAlert.classList.add('d-none');
  return ok;
}

/* ================== LISTENERS ================== */
if (phone){
  if (!phone.value.trim() || phone.value.trim() === '+63') phone.value = '+63 ';
  const syncPhone = () => { phone.value = formatPhMobileHyphenated(phone.value); validatePhone(); validateForm(); };
  phone.addEventListener('input', syncPhone);
  phone.addEventListener('blur',  syncPhone);
  phone.addEventListener('focus', () => {
    if (!phone.value.startsWith('+63')) phone.value = '+63 ';
    setTimeout(() => phone.setSelectionRange(phone.value.length, phone.value.length), 0);
  });
}
if (emailEl){  emailEl.addEventListener('input', () => { validateEmail(); validateForm(); });
               emailEl.addEventListener('blur',  () => { validateEmail(); validateForm(); }); }
if (fullName){ fullName.addEventListener('input', () => { validateFullName(); validateForm(); }); }
if (ageEl){    ageEl.addEventListener('input', () => { validateAge(); validateForm(); }); }
if (sexEl){    sexEl.addEventListener('change', () => { validateSex(); validateForm(); }); }
if (address){  address.addEventListener('input', () => { validateAddress(); validateForm(); }); }
if (idEl){
  idEl.addEventListener('input', () => { validateID(); validateForm(); });
  idEl.addEventListener('blur',  () => { validateID(); validateForm(); });
}
if (program){
  program.setAttribute('maxlength', String(PROGRAM_MAX));
  program.addEventListener('input', () => { validateProgram(); validateForm(); });
  program.addEventListener('blur',  () => { validateProgram(); validateForm(); });
}
stRadios.forEach(r => r.addEventListener('change', () => {
  toggleYearLevel(); validateStakeholderGroup(); validateYearLevel(); validateForm();
}));
if (yrSel){ yrSel.addEventListener('change', () => { validateYearLevel(); validateForm(); }); }
if (clientTypeSel){
  clientTypeSel.addEventListener('change', () => { validateClientType(); validateForm(); });
}

/* ================== OPEN BUTTON GUARD ================== */
document.getElementById('openConfirmModal').addEventListener('click', () => {
  if (openBtn.disabled){
    formAlert.classList.remove('d-none');
    validateForm();
    const firstInvalid = form.querySelector('.is-invalid');
    if (firstInvalid) firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});
  }
});

/* ================== SUBMIT FLOW ================== */
const redirectModal = new bootstrap.Modal(document.getElementById('redirectModal'));
const confirmModal  = new bootstrap.Modal(document.getElementById('confirmSubmitModal'));
const countSpan     = document.getElementById('countModal');
const errorBox      = document.getElementById('submitError');
let countdownTimer  = null;

function startCountdown(seconds, redirectUrl){
  let n = seconds; countSpan.textContent = n;
  clearInterval(countdownTimer);
  countdownTimer = setInterval(() => {
    n -= 1; countSpan.textContent = n;
    if (n <= 0){ clearInterval(countdownTimer); window.location.href = redirectUrl; }
  }, 1000);
}
function getCsrfToken(){
  const inp = form.querySelector('input[name=csrfmiddlewaretoken]');
  return inp ? inp.value : '';
}

confirmBtn.addEventListener('click', async function(){
  if (!validateForm()){
    formAlert.classList.remove('d-none');
    const firstInvalid = form.querySelector('.is-invalid');
    if (firstInvalid) firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});
    return;
  }

  confirmModal.hide();
  redirectModal.show();

  // ----- Encode stakeholder as "TUPC Student - YEAR LEVEL" before building FormData
  let originalStakeVal = null;
  let mutated = false;
  if (stTupc && stTupc.checked && yrSel && yrSel.value){
    originalStakeVal = stTupc.value;
    stTupc.value = `TUPC Student - ${yrSel.value}`;
    mutated = true;
  }

  const fd = new FormData(form);

  // Revert UI value after we captured it
  if (mutated) stTupc.value = originalStakeVal;

  // Disable UI during submit
  Array.from(form.elements).forEach(el => el.disabled = true);
  confirmBtn.disabled = true; openBtn.disabled = true; errorBox.classList.add('d-none');

  try{
    const resp = await fetch(form.action, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCsrfToken(), 'X-Requested-With': 'XMLHttpRequest' },
      body: fd, credentials: 'same-origin'
    });
    const isJson = (resp.headers.get('content-type')||'').includes('application/json');
    const data = isJson ? await resp.json() : null;

    if (resp.ok && (!isJson || (data && data.ok))){
      startCountdown(5, "{% url 'client_home' %}");
      return;
    }
    if (data && data.errors){
      Object.keys(data.errors).forEach(name => {
        const el = form.querySelector(`[name="${name}"]`);
        if (el){ el.classList.add('is-invalid'); }
      });
    }
    clearInterval(countdownTimer);
    errorBox.classList.remove('d-none');
  } catch(e){
    clearInterval(countdownTimer);
    errorBox.textContent = 'Network error. Please try again.';
    errorBox.classList.remove('d-none');
  } finally {
    Array.from(form.elements).forEach(el => el.disabled = false);
    confirmBtn.disabled = false; openBtn.disabled = false;
  }
});

/* ================== INIT ================== */
document.addEventListener('DOMContentLoaded', () => {
  if (phone && (phone.value === '' || phone.value === '+63')) phone.value = '+63 ';
  toggleYearLevel();
  validateForm();
});
</script>
</body>
</html>