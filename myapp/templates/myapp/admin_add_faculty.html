{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OSA - Add Facilitator </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'myapp/css/admin_CS.css' %}">
</head>

<body>
  <button class="btn btn-primary toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

<!-- Sidebar -->
  {% include "partials/sidebar.html" %}
  {% include "partials/logout_modal.html" %}

<!-- //////////////////////////START HERE MAG CODE ///////////////////////////-->


 
<style>
  /* Highlight on focus */
  .input-group-sm .form-control:focus {
    border: 2px solid #440207;
    box-shadow: 0 0 0 0.15rem rgba(68, 2, 7, 0.1); /* soft glow */
  }

  .input-group-sm .form-control:hover {
    border: 1px solid #440207;
  }

  .input-group-sm:focus-within .input-group-text {
    background-color: #f8f0f0;
    border-color: #440207;
    color: #440207;
  }

  .btn.text-light {
    background-color: #440207 !important;
    padding: 10px;
    transition: all 0.3s ease;
  }

  .btn.text-light:hover {
    background-color: #5e0000 !important; 
  }

  .form-control {
    border-radius: 6px; /* optional: smoother edges */
    box-shadow: none;  /* remove Bootstrap default glow */
  }

  .form-control:focus {
    border: 1px solid #440207 !important;  /* darker border on focus */
    box-shadow: 0 0 4px rgba(68, 2, 7, 0.3); /* subtle glow */
  }
</style>


<div class="main-content" style="margin-left: 250px; min-height: 100vh; background-color: #f8f9fa;">

  <!-- Header -->
  <div class="container-fluid py-4 px-4">
    <div class="election-header text-white mt-4"
         style="background: linear-gradient(to right bottom, #000000, #440207, rgb(104, 3, 12));
                background-size: cover; background-position: center; background-repeat: no-repeat;
                padding: 50px; min-height: 100px; border-radius: 20px; margin-bottom: 1px; margin-top: 1px;">
      <h2 class="fw-bold mb-0"><i class="bi bi-people-fill me-2"></i> Community Service Facilitator Dashboard</h2>
      <p class="mb-0">Monitor, manage, and add faculty members</p>
    </div>
  </div>

  <div class="container-fluid px-4">

    <!-- Top Nav Buttons -->
    <a href="{% url 'admin_community_service' %}" class="btn btn-secondary me-2"
       style="text-align:center;background-color:#f0f0f0;color:#333;font-weight:500;border:1px solid #ccc;border-radius:5px;padding:10px 15px;transition:all .3s ease;"
       onmouseover="this.style.backgroundColor='#ccccccff'; this.style.borderColor='#ccc';">
      <i class="bi bi-clipboard-check-fill me-2"></i> Community Service Requests
    </a>

    <a href="{% url 'admin_add_faculty' %}" class="btn btn-secondary"
       style="text-align:center;background-color:#f0f0f0;color:#333;font-weight:500;border:1px solid #ccc;border-radius:5px;padding:10px 15px;transition:all .3s ease;"
       onmouseover="this.style.backgroundColor='#ccccccff'; this.style.borderColor='#ccc';">
      <i class="bi bi-people-fill me-2"></i> Community Service Facilitators
    </a>

    <hr>

    <!-- Flash messages -->
    {% if messages %}
      <div class="mt-2">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="bg-white p-2 rounded shadow-sm border">
      <div class="container-fluid pt-4 pb-5">
        <div class="bg-white p-4 rounded shadow-sm border">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <h5 class="fw-bold mb-1"><i class="bi bi-people-fill me-2"></i><strong>Community Service Facilitator</strong></h5>
              <small class="text-muted">Manage faculty accounts for monitoring students’ community service.</small>
            </div>
            <button class="btn text-light" style="background-color:#440207; padding:10px; font-size:17px;"
                    data-bs-toggle="modal" data-bs-target="#addfaculty">
              <i class="bi bi-plus-circle-fill me-2"></i> Add Community Service Facilitator
            </button>
          </div>

          <hr class="border-dark">

          <!-- Search -->
          <div class="d-flex justify-content-end mb-3">
            <form class="input-group input-group-sm" style="max-width: 420px;" method="get" action="{% url 'admin_add_faculty' %}">
              <input id="faculty_search" name="q" type="text" class="form-control"
                     placeholder="Search facilitator by name or ID"
                     value="{{ q|default:'' }}">
              <button class="input-group-text bg-white border" type="submit" title="Search">
                <i class="bi bi-search text-muted"></i>
              </button>
            </form>
          </div>

          <!-- Table -->
          <div class="card shadow-sm border">
            <div class="card-header text-white" style="background-color:#440207;">
              <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Community Service Facilitator List</h6>
            </div>

            <div class="card-body table-responsive p-0" style="max-height: calc(49px * 10); overflow-y: auto;">
              <table class="table table-hover table-bordered align-middle text-center mb-0" id="facilitatorTable">
                <thead class="table-secondary sticky-top border">
                  <tr>
                    <th style="width:240px;">ID Number</th>
                    <th style="width:300px">Name</th>
                    <th style="width:240px;">Email</th>
                    <th style="width:240px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="facilitatorTbody">
                  {% if facilitators %}
                    {% for f in facilitators %}
                      <tr data-name="{{ f.full_name|escape }}"
                          data-id="{{ f.faculty_id|escape }}"
                          data-email="{{ f.email|default_if_none:''|escape }}">
                        <td class="font-monospace">{{ f.faculty_id }}</td>
                        <td class="text-center">{{ f.full_name }}</td>
                        <td class="text-center">
                          {% if f.email %}
                            <a href="mailto:{{ f.email|escape }}">{{ f.email }}</a>
                          {% else %}
                            <span class="text-muted">—</span>
                          {% endif %}
                        </td>
                        <td>
                          <button type="button"
                                  class="btn btn-sm border"
                                  style="color:#440207; border-color:#440207;"
                                  data-bs-toggle="modal"
                                  data-bs-target="#confirmRemoveModal"
                                  data-action="{% url 'facilitator_delete' f.pk %}"
                                  data-name="{{ f.full_name|escape }}"
                                  data-id="{{ f.faculty_id|escape }}"
                                  data-email="{{ f.email|default_if_none:''|escape }}"
                                  onmouseover="this.style.backgroundColor='#440207'; this.style.color='#fff';"
                                  onmouseout="this.style.backgroundColor=''; this.style.color='#440207';">
                            <i class="bi bi-trash-fill me-1"></i> Remove
                          </button>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="4" class="text-muted py-4">No facilitators found.</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Facilitator Modal -->
<div class="modal fade" id="addfaculty" tabindex="-1" aria-labelledby="addfacultyLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-sm rounded">

      <div class="modal-header">
        <h5 class="modal-title text-dark fw-semibold" id="addfacultyLabel">
          <i class="bi bi-people-fill me-2"></i> Add Community Service Facilitator
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="post" action="{% url 'admin_add_faculty' %}" id="addFacilitatorForm" novalidate>
        {% csrf_token %}
        <div class="modal-body">

          <!-- Show server-side errors at top of modal -->
          {% if form.errors or form.non_field_errors %}
            <div class="alert alert-danger py-2">
              {% if form.non_field_errors %}{{ form.non_field_errors }}{% endif %}
              {% for field in form %}
                {% for err in field.errors %}
                  <div>{{ field.label }}: {{ err }}</div>
                {% endfor %}
              {% endfor %}
            </div>
          {% endif %}

          <!-- Facilitator Name -->
          <div class="mb-3">
            <label for="facilitatorName" class="form-label fw-semibold">Facilitator Name:</label>
            <input type="text" class="form-control {% if form.full_name.errors %}is-invalid{% endif %}"
                   id="facilitatorName" name="full_name"
                   placeholder="Enter facilitator name" required
                   value="{{ form.full_name.value|default:'' }}">
            {% if form.full_name.errors %}
              <div class="invalid-feedback">{{ form.full_name.errors|striptags }}</div>
            {% else %}
              <div class="invalid-feedback">Please provide a name.</div>
            {% endif %}
          </div>

          <!-- Faculty ID: NN-NNN -->
          <div class="mb-1">
            <label for="facultyId" class="form-label fw-semibold">Faculty ID Number (NN-NNN):</label>
            <input type="text" class="form-control {% if form.faculty_id.errors %}is-invalid{% endif %}"
                   id="facultyId" name="faculty_id"
                   placeholder="12-345" maxlength="6" inputmode="numeric"
                   pattern="\d{2}-\d{3}" required
                   value="{{ form.faculty_id.value|default:'' }}">
            {% if form.faculty_id.errors %}
              <div class="invalid-feedback">{{ form.faculty_id.errors|striptags }}</div>
            {% else %}
              <div class="invalid-feedback">Use format <b>NN-NNN</b> (e.g., 12-345).</div>
            {% endif %}
            <div class="form-text">Two digits, a hyphen, then three digits.</div>
          </div>
          <div class="mb-3">
            <label for="facilitatorEmail" class="form-label fw-semibold">Email:</label>
            <input type="email"
                  class="form-control {% if form.email.errors %}is-invalid{% endif %}"
                  id="facilitatorEmail"
                  name="email"
                  placeholder="name@example.com"
                  inputmode="email"
                  maxlength="254"
                  required
                  value="{{ form.email.value|default:'' }}">
            {% if form.email.errors %}
              <div class="invalid-feedback">{{ form.email.errors|striptags }}</div>
            {% else %}
              <div class="invalid-feedback">Please provide a valid email address.</div>
            {% endif %}
            <div class="form-text">We’ll use this to send OTP for secure login.</div>
          </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn text-light px-4" style="background-color:#440207;">Add</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="confirmRemoveModal" tabindex="-1" aria-labelledby="confirmRemoveModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="deleteForm" method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="confirmRemoveModalLabel"><i class="bi bi-trash-fill me-2"></i>Confirm Removal</h5>
        </div>
        <div class="modal-body text-center">
          <div class="mb-2">Are you sure you want to remove:</div>
          <div class="fw-bold" id="deleteName">—</div>
          <div class="text-muted small mt-1">ID: <span id="deleteId">—</span></div>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm" style="background-color:#440207; color:#fff;">Yes, Remove</button>
        </div>
      </form>
    </div>
  </div>
</div>

  <!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
        // Toggle Sidebar
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('show');
      }

      // Handle Dropdowns Uniformly
      function handleDropdown(menuId) {
        const clickedIcon = document.getElementById(`icon-${menuId}`);
        const clickedMenu = document.getElementById(menuId);
        const clickedCollapse = bootstrap.Collapse.getOrCreateInstance(clickedMenu);

        // Toggle clicked menu
        if (clickedMenu.classList.contains('show')) {
          clickedCollapse.hide();
          clickedIcon.classList.remove('rotate');
        } else {
          clickedCollapse.show();
          clickedIcon.classList.add('rotate');
        }

        // Hide other open menus
        const allDropdowns = ['violationMenu', 'documentsMenu', 'postingsMenu', 'studentRecordMenu'];
        allDropdowns.forEach(id => {
          if (id !== menuId) {
            const menu = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            const collapse = bootstrap.Collapse.getInstance(menu);
            if (collapse) collapse.hide();
            if (icon) icon.classList.remove('rotate');
          }
        });
      }

      // Highlight Active Link
      document.addEventListener('DOMContentLoaded', function () {
        const currentUrl = window.location.href;
        const navLinks = document.querySelectorAll('.nav-link');

        navLinks.forEach(link => {
          if (link.href && currentUrl.includes(link.href)) {
            link.classList.add('active');
          }
        });
      });
</script>

{% if open_add_modal %}
<script>
  document.addEventListener('DOMContentLoaded', function(){
    var m = new bootstrap.Modal(document.getElementById('addfaculty'));
    m.show();
  });
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', () => {
  try {
    /* ========== Instant client-side filter (name, ID, email) ========== */
    const searchInput = document.getElementById('faculty_search');
    const tbody = document.getElementById('facilitatorTbody');
    if (searchInput && tbody) {
      searchInput.addEventListener('input', () => {
        try {
          const q = (searchInput.value || '').trim().toLowerCase();
          tbody.querySelectorAll('tr').forEach(row => {
            const name  = (row.dataset.name  || '').toLowerCase();
            const id    = (row.dataset.id    || '').toLowerCase();
            const email = (row.dataset.email || '').toLowerCase();
            row.style.display = (!q || name.includes(q) || id.includes(q) || email.includes(q)) ? '' : 'none';
          });
        } catch (err) {
          console.error('Filter error:', err);
        }
      });
    } else {
      console.warn('Search elements not found for facilitator filter.');
    }

    /* ========== Add Facilitator form: auto-format + validation ========== */
    const form       = document.getElementById('addFacilitatorForm');
    const idInput    = document.getElementById('facultyId');
    const nameInput  = document.getElementById('facilitatorName');
    const emailInput = document.getElementById('facilitatorEmail');

    // Auto-format NN-NNN
    if (idInput) {
      idInput.addEventListener('input', () => {
        try {
          let v = idInput.value.replace(/[^\d]/g, '');
          if (v.length > 2) v = v.slice(0, 2) + '-' + v.slice(2, 5);
          idInput.value = v.slice(0, 6);
        } catch (err) {
          console.error('ID format error:', err);
        }
      });
    }

    // Validate on submit
    if (form) {
      form.addEventListener('submit', (e) => {
        try {
          const idPattern = /^\d{2}-\d{3}$/;
          let ok = true;

          // Name required
          if (!nameInput || !nameInput.value.trim()) { nameInput?.classList.add('is-invalid'); ok = false; }
          else { nameInput.classList.remove('is-invalid'); }

          // Faculty ID pattern
          if (!idInput || !idPattern.test(idInput.value.trim())) { idInput?.classList.add('is-invalid'); ok = false; }
          else { idInput.classList.remove('is-invalid'); }

          // Email required + basic format
          if (emailInput) {
            const emailVal = (emailInput.value || '').trim();
            const emailOk = !!emailVal && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailVal);
            if (!emailOk) { emailInput.classList.add('is-invalid'); ok = false; }
            else { emailInput.classList.remove('is-invalid'); }
          }

          if (!ok) {
            e.preventDefault();
            e.stopPropagation();
            return;
          }

          // Optional: prevent double-submit
          const submitBtn = form.querySelector('button[type="submit"]');
          submitBtn && (submitBtn.disabled = true);

        } catch (err) {
          console.error('Form submit validation error:', err);
          e.preventDefault();
          e.stopPropagation();
          alert('Something went wrong validating the form. Please try again.');
        }
      });
    } else {
      console.warn('addFacilitatorForm not found.');
    }

    /* ========== Delete confirm modal wiring ========== */
    const confirmModal = document.getElementById('confirmRemoveModal');
    if (confirmModal) {
      const deleteName = document.getElementById('deleteName');
      const deleteId   = document.getElementById('deleteId');
      const deleteForm = document.getElementById('deleteForm');
      const deleteEmail = document.getElementById('deleteEmail'); // optional span

      confirmModal.addEventListener('show.bs.modal', (event) => {
        try {
          const button = event.relatedTarget;
          const name   = button?.getAttribute('data-name')   || '—';
          const id     = button?.getAttribute('data-id')     || '—';
          const email  = button?.getAttribute('data-email')  || '—';
          const action = button?.getAttribute('data-action') || '#';

          if (deleteName)  deleteName.textContent = name;
          if (deleteId)    deleteId.textContent = id;
          if (deleteEmail) deleteEmail.textContent = email;
          if (deleteForm)  deleteForm.setAttribute('action', action);
        } catch (err) {
          console.error('Modal populate error:', err);
        }
      });
    }

  } catch (outerErr) {
    console.error('Init error:', outerErr);
  }
});
</script>
<script>
  window.addEventListener('pageshow', function (e) {
    if (e.persisted) location.reload();
  });
</script>


</body>
</html>
